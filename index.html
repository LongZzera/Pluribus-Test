<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLURIBUS: A JUN√á√ÉO - FINAL V3</title>
    <style>
/* === ESTILOS GERAIS === */
body, html {
    margin: 0; padding: 0; width: 100%; height: 100%;
    font-family: 'Courier New', Courier, monospace;
    background-color: #000; color: #FFF;
    overflow: hidden; text-shadow: 0 0 2px #FF0;
    user-select: none;
}
/* Scanlines */
body::after {
    content: " "; display: block; position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1) 1px, transparent 1px, transparent 2px);
    pointer-events: none; z-index: 9999;
}

/* Telas */
.screen {
    width: 100vw; height: 100vh; display: none; position: absolute;
    top: 0; left: 0; align-items: center; justify-content: center;
    flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box;
    background: #000; z-index: 10;
}
.screen.active { display: flex; }
.hidden { display: none !important; }

/* Container */
.menu-container {
    text-align: center; background: #050505;
    padding: 30px; border: 2px solid #FF0;
    box-shadow: 0 0 20px rgba(255, 255, 0, 0.2);
    max-width: 900px; width: 95%;
}

h1, h2, h3 { color: #FF0; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
p { font-size: 1.1em; line-height: 1.4; color: #DDD; margin-bottom: 10px; }

/* Bot√µes */
button {
    padding: 10px 20px; margin: 5px;
    font-family: 'Courier New', Courier, monospace; font-size: 1em; font-weight: bold;
    background-color: #000; color: #FF0; border: 2px solid #FF0;
    cursor: pointer; transition: all 0.1s; text-transform: uppercase;
}
button:hover:not(:disabled) { background-color: #FF0; color: #000; box-shadow: 0 0 15px #FF0; }
button:disabled { border-color: #444; color: #444; cursor: not-allowed; box-shadow: none; }

/* HUD */
#game-hud {
    width: 100%; padding: 10px; background: #000; border-bottom: 1px solid #FF0;
    display: flex; justify-content: space-between; position: absolute; top: 0; z-index: 20;
}
.hud-column { width: 48%; display: flex; flex-direction: column; gap: 2px; font-size: 0.9em; }
.bar-container { width: 100%; height: 8px; background: #222; border: 1px solid #555; margin-bottom: 5px; }
.bar-fill { height: 100%; transition: width 0.3s; }

#sanity-bar { background: #FFF; }
#intimacy-bar { background: #FF0; }
#door-bar { background: #FFF; }
#battery-bar { background: #FF0; }

/* Hub */
#apartment-hub-view { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding-top: 80px; }
#apartment-art {
    font-size: 11px; line-height: 11px; color: #FF0; border: 1px solid #FF0;
    padding: 15px; background: rgba(20, 20, 20, 0.9); margin-bottom: 10px;
}
#hub-display-log {
    height: 50px; border: 1px solid #FF0; color: #FFF;
    padding: 5px; overflow: hidden; font-style: italic; text-align: center; display: flex; align-items: center; justify-content: center;
}
#glitch-timer { color: #F00; font-weight: bold; margin-top: 5px; text-shadow: 0 0 5px #F00; }

/* Visor */
#peephole-overlay { background: #000; z-index: 50; }
#visitor-ascii-art {
    font-size: 12px; line-height: 10px; white-space: pre; 
    color: #CCC; border: 2px solid #FF0; padding: 20px; 
    width: 500px; height: 250px; margin-bottom: 10px;
    display: flex; align-items: center; justify-content: center; text-align: center;
}
.dark-vision { color: #222 !important; border-color: #444 !important; }
#peephole-timer-display { font-size: 3em; color: #FF0; font-weight: bold; animation: pulse 0.5s infinite; }

/* C√¢mera */
#camera-screen { background: #050505; }
#cam-ui {
    width: 100%; max-width: 700px; margin: 0 auto;
    border: 2px solid #FF0; padding: 10px; background: #001100;
}
#cam-feed { 
    width: 100%; height: 300px; 
    display: flex; align-items: center; justify-content: center; flex-direction: column;
    color: #0F0; font-size: 1em; white-space: pre;
    background: repeating-linear-gradient(0deg, rgba(0, 255, 0, 0.1), rgba(0, 255, 0, 0.1) 1px, transparent 1px, transparent 2px);
    text-shadow: 0 0 5px #0f0; border: 1px solid #050; overflow: hidden;
}

/* MINI GAME PAC MAN */
#minigame-screen { background: rgba(0,0,0,0.95); z-index: 200; }
canvas { border: 4px solid #FF0; background: #000; box-shadow: 0 0 30px #FF0; display: block; margin: 0 auto; }
#minigame-msg { color: #FF0; font-size: 2em; margin-bottom: 20px; animation: pulse 0.2s infinite; }

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="main-menu-screen" class="screen active">
        <div class="menu-container">
            <h1 style="font-size: 3em;">PLURIBUS</h1>
            <p style="color: #FF0;">A JUN√á√ÉO</p>
            <br>
            <button onclick="startGame()" style="font-size: 1.5em;">INICIAR JOGO</button>
            <div style="margin-top: 10px;">
                <button onclick="showScreen('how-to-play-screen')">COMO JOGAR</button>
                <button onclick="showScreen('credits-screen')">CR√âDITOS</button>
                <button onclick="initAudio()">ATIVAR SOM üîä</button>
            </div>
        </div>
    </div>

    <div id="how-to-play-screen" class="screen">
        <div class="menu-container">
            <h2>MANUAL DE SOBREVIV√äNCIA</h2>
            <div style="text-align: left; max-height: 60vh; overflow-y: auto;">
                <p>1. <strong>GLITCH (PAC-MAN):</strong> A cada 30s, o jogo trava. Use as SETAS para comer tudo.</p>
                <p>2. <strong>C√ÇMERA:</strong> Gasta 20% de bateria. S√≥ 2 usos por dia.</p>
                <p>3. <strong>PORTA:</strong> S√≥ pode ser reparada 3 vezes por dia.</p>
                <p>4. <strong>GERADOR:</strong> S√≥ pode ser usado 1 vez por dia.</p>
            </div>
            <button onclick="showScreen('main-menu-screen')">VOLTAR</button>
        </div>
    </div>

    <div id="credits-screen" class="screen">
        <div class="menu-container">
            <h2>CR√âDITOS</h2>
            <br>
            <p>CRIADOR</p>
            <p style="font-size: 2em; color: #FF0; text-shadow: 0 0 10px #FF0;">HALDO</p>
            <br>
            <button onclick="showScreen('main-menu-screen')">VOLTAR</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-hud">
            <div class="hud-column">
                <span>üß† SANIDADE: <span id="val-sanity">100%</span></span>
                <div class="bar-container"><div id="sanity-bar" class="bar-fill"></div></div>
                <span>‚ù§Ô∏è INTIMIDADE: <span id="val-intimacy">100%</span></span>
                <div class="bar-container"><div id="intimacy-bar" class="bar-fill"></div></div>
            </div>
            <div class="hud-column">
                <span>üõ°Ô∏è PORTA: <span id="val-door">100%</span></span>
                <div class="bar-container"><div id="door-bar" class="bar-fill"></div></div>
                <div style="display:flex; justify-content:space-between;">
                    <span>üîã BAT: <span id="val-battery">100%</span></span>
                    <span>üè† HAB: <span id="val-pop" style="color:#FF0;">1/4</span></span>
                </div>
                <div class="bar-container"><div id="battery-bar" class="bar-fill"></div></div>
            </div>
        </div>

        <div id="apartment-hub-view">
            <div class="hub-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="text-align:left;">
                        <h2 style="margin:0; font-size:1.5em;">DIA <span id="val-day">1</span></h2>
                    </div>
                    <h1 id="clock-display" style="font-size:3em; margin:0; color:#FF0;">00:00</h1>
                </div>

                <pre id="apartment-art">
    [ TV ]      [ R√ÅDIO ]      [ MESA ]
      |             |             |
    (OFF)        (CHIADO)      (PLANO)

          \     |     /
           \    |    /
            \   |   /
             \  |  /
              \ | /
          [  PORTA  ]
                </pre>
                
                <div id="hub-display-log"><p>SOBREVIVA.</p></div>
                <div id="glitch-timer">GLITCH EM: 30s</div>
                
                <div class="hub-actions" style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <button id="btn-repair" onclick="actionRepair()">üî® REPARAR (3)</button>
                    <button id="btn-manage" onclick="openManageScreen()">üë• GERENCIAR</button>
                    <button id="btn-tv" onclick="openTVScreen()">üì∫ TV (1x)</button>
                    <button id="btn-focus" onclick="actionFocus()">üßò FOCAR (4)</button>
                    <button id="btn-cam" onclick="openCameraScreen()">üìπ C√ÇMERA (2)</button>
                    <button id="btn-gen" onclick="actionGenerator()">‚ö° GERADOR (1)</button>
                </div>
            </div>
        </div>

        <div id="peephole-overlay" class="screen hidden">
            <h2 style="color:#FF0; margin:0;">ALGU√âM BATEU!</h2>
            <div id="peephole-timer-display">10</div>
            <div id="visitor-ascii-art" class="dark-vision">?????????????\n? VULT ?\n?????????????</div>
            <div id="peephole-controls" style="text-align: center;">
                <div style="margin-bottom: 15px;">
                    <button id="btn-light" onclick="useLight()">üî¶ LUZ (-15%)</button>
                    <button id="btn-scan" onclick="useScanner()">üß¨ SCANNER</button>
                    <button id="btn-listen" onclick="useListen()">üëÇ OUVIR</button>
                </div>
                <div id="dialogue-area"></div>
                <div id="decision-area" class="hidden" style="margin-top:10px;">
                    <button id="btn-open" onclick="resolveVisitor('open')" style="color:#FFF; border-color:#FFF;">ABRIR</button>
                    <button onclick="resolveVisitor('deny')" style="color:#FF0; border-color:#FF0;">N√ÉO ABRIR</button>
                </div>
                <div id="pop-warning" style="color:#F00; font-size:0.8em; height:20px;"></div>
            </div>
        </div>
    </div>

    <div id="minigame-screen" class="screen">
        <div class="menu-container" style="border: none; background: transparent; box-shadow: none;">
            <h2 id="minigame-msg">ERRO NO SISTEMA!</h2>
            <p style="color: #FFF;">COMA TUDO. FUJA DOS FANTASMAS.</p>
            <canvas id="pacman-canvas"></canvas>
            <p style="font-size: 1em; color: #FF0; margin-top: 10px;">USE AS SETAS DO TECLADO</p>
        </div>
    </div>

    <div id="camera-screen" class="screen">
        <div class="menu-container">
            <h2>VIGIL√ÇNCIA V2.0</h2>
            <div id="cam-ui"><div id="cam-feed"><div id="cam-loading">CONECTANDO...</div><div id="cam-result" class="hidden"></div></div></div>
            <div style="margin-top:20px;"><p id="cam-status">Bateria: -20%</p><button onclick="closeCameraScreen()">DESLIGAR</button></div>
        </div>
    </div>

    <div id="manage-screen" class="screen">
        <div class="menu-container"><h2>GERENCIAR</h2><div id="occupants-list"></div><button onclick="closeManageScreen()">VOLTAR</button></div>
    </div>

    <div id="tv-screen" class="screen">
        <div class="menu-container"><h2>CANAL DA JUN√á√ÉO</h2><div id="tv-content"></div><div id="tv-controls"><button id="tv-ask-btn" onclick="askTV()">PERGUNTAR</button><button onclick="closeTVScreen()">DESLIGAR</button></div></div>
    </div>

    <div id="report-screen" class="screen">
        <div class="menu-container"><h2>RELAT√ìRIO</h2><div id="rank-grade" class="rank-grade"></div><div class="score-detail"><p>PONTOS: <span id="score-total"></span></p></div><button onclick="goToMeeting()">REUNI√ÉO</button></div>
    </div>

    <div id="meeting-screen" class="screen">
        <div class="menu-container"><h2>REUNI√ÉO</h2><div id="meeting-grid" class="meeting-grid"></div></div>
    </div>

    <div id="victory-screen" class="screen">
        <div class="menu-container"><h1>VIT√ìRIA</h1><button onclick="startEndlessMode()">MODO INFINITO</button><button onclick="location.reload()">MENU</button></div>
    </div>

    <div id="game-over-screen" class="screen">
        <div class="menu-container"><h1 style="color:#F00;">FIM DE JOGO</h1><p id="go-msg"></p><button onclick="location.reload()">TENTAR NOVAMENTE</button></div>
    </div>

    <script>
/* === SISTEMA === */
let audioCtx = null;
let gameLoop = null, peepTimer = null, glitchInterval = null, minigameLoop = null;
let glitchCountdown = 30;
const TICK_SPEED = 300;

let game = {
    state: 'menu', day: 1, mode: 'normal', time: { h: 0, m: 0 },
    stats: { sanity: 100, intimacy: 100, door: 100, battery: 100 },
    occupants: [], flags: { tvUsed: false, generatorUsed: false },
    uses: { focus: 4, scan: 4, cam: 2, repair: 3 },
    visitor: null, nextVisitor: null, peepTime: 10
};

// MAPA DO PACMAN (GLOBAL) - 2 = VAZIO, 0 = PONTO, 1 = PAREDE
const PACMAN_MAP = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,2,2,2,2,2,1,2,2,2,2,2,0,1], 
    [1,2,1,1,1,1,2,1,2,1,1,1,1,2,1],
    [1,2,1,0,2,2,2,2,2,2,2,0,1,2,1],
    [1,2,1,2,1,1,0,2,0,1,1,2,1,2,1], 
    [1,2,0,2,0,2,2,2,2,2,0,2,0,2,1],
    [1,2,1,2,1,1,0,2,0,1,1,2,1,2,1],
    [1,2,1,0,2,2,2,2,2,2,2,0,1,2,1],
    [1,2,1,1,1,1,2,1,2,1,1,1,1,2,1],
    [1,0,2,2,2,2,2,1,2,2,2,2,2,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// LORE & DATA
const tvScript = [{q:"O que √© isso?", a:"A JUN√á√ÉO √â O FUTURO."}, {q:"Por que?", a:"A DOR PRECISA PARAR."}, {q:"Quem sou eu?", a:"VOC√ä √â PARTE DE N√ìS."}, {q:"Fim?", a:"APENAS O COME√áO."}];
const visitorsPool = [
    { type: 'Humano', name: 'Vizinho', art: ' (o o)\n  \\_/', sound: 'human', dialogues: [{q:"Quem?", a:"Sou vizinho!", sanity:5}]},
    { type: 'Humano', name: 'M√©dico', art: '  (+)\n (o o)', sound: 'human', dialogues: [{q:"Ajuda?", a:"Estou ferido.", sanity:0}]},
    { type: 'Infectado', name: 'M√≠mico', art: ' (O O)\n  \\_/', sound: 'alien', dialogues: [{q:"Quem?", a:"Sou eu...", sanity:-15}]},
    { type: 'Infectado', name: 'Vazio', art: '  ( )\n  ---', sound: 'static', dialogues: [{q:"...", a:"...", sanity:-20}]}
];
const meetingTasks = [{name:"REZAR", san:20, int:5}, {name:"JOGAR", san:10, int:15}, {name:"CONVERSAR", san:5, int:10}];

/* === AUDIO === */
function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playSound(type) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    if(type==='knock'){osc.frequency.value=80; gain.gain.value=0.5; osc.start(now); osc.stop(now+0.1);}
    if(type==='win'){osc.type='sine'; osc.frequency.setValueAtTime(400,now); osc.frequency.linearRampToValueAtTime(800,now+0.2); gain.gain.value=0.3; osc.start(now); osc.stop(now+0.2);}
    if(type==='lose'){osc.type='sawtooth'; osc.frequency.setValueAtTime(200,now); gain.gain.value=0.5; osc.start(now); osc.stop(now+0.3);}
}

/* === ENGINE === */
function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

function startGame() {
    game.stats = { sanity: 100, intimacy: 100, door: 100, battery: 100 };
    game.day = 1; game.mode = 'normal'; game.occupants = [{name:"Ana", loyalty:80}];
    resetDay(); showScreen('game-screen');
    if(gameLoop) clearInterval(gameLoop); gameLoop = setInterval(tick, TICK_SPEED);
    
    glitchCountdown = 30;
    if(glitchInterval) clearInterval(glitchInterval);
    glitchInterval = setInterval(glitchTick, 1000);
}

function resetDay() {
    game.time = {h:0, m:0}; game.flags = {tvUsed:false, generatorUsed:false};
    game.uses = {focus:4, scan:4, cam:2, repair:3};
    updateHUD();
}

function glitchTick() {
    if(game.state !== 'minigame' && document.getElementById('game-screen').classList.contains('active')) {
        glitchCountdown--;
        document.getElementById('glitch-timer').innerText = `GLITCH EM: ${glitchCountdown}s`;
        if(glitchCountdown <= 0) startMinigame();
    }
}

function tick() {
    if(game.state === 'minigame') return;
    if(!document.getElementById('game-screen').classList.contains('active')) return;
    if(document.getElementById('peephole-overlay').classList.contains('active')) return;

    game.time.m++;
    if(game.time.m >= 60) { game.time.m=0; game.time.h++; }
    if(game.time.m === 0) game.occupants.forEach(o => { o.loyalty-=3; if(o.loyalty<=0) gameOver("TRA√çDO."); });
    if(game.time.m === 30 && game.time.h < 5) triggerVisitor();
    if(game.time.h >= 5) endDay();
    updateHUD();
}

/* === MINI GAME === */
let canvas, ctx, player, ghosts, pellets, mapSize = 25;

function startMinigame() {
    game.state = 'minigame';
    showScreen('minigame-screen');
    setTimeout(initMinigame, 100); // Pequeno delay para garantir render
}

function initMinigame() {
    canvas = document.getElementById('pacman-canvas');
    ctx = canvas.getContext('2d');
    
    // Define tamanho do canvas baseado no mapa
    canvas.width = PACMAN_MAP[0].length * mapSize;
    canvas.height = PACMAN_MAP.length * mapSize;
    
    pellets = [];
    let emptySpots = [];
    
    for(let y=0; y<PACMAN_MAP.length; y++) {
        for(let x=0; x<PACMAN_MAP[0].length; x++) {
            // 0 = Pastilha, 2 = Caminho Vazio
            if(PACMAN_MAP[y][x] === 0) {
                pellets.push({x:x, y:y});
            }
            if(PACMAN_MAP[y][x] !== 1) {
                emptySpots.push({x:x, y:y});
            }
        }
    }

    player = { x: 1, y: 1, dir: {x:0, y:0}, nextDir: {x:0, y:0}, color: '#FF0' };
    ghosts = [];
    for(let i=0; i<4; i++) {
        let s = emptySpots[Math.floor(Math.random()*emptySpots.length)];
        ghosts.push({x:s.x, y:s.y, color:'#F00'});
    }

    window.addEventListener('keydown', handleMiniInput);
    if(minigameLoop) clearInterval(minigameLoop);
    minigameLoop = setInterval(updateMinigame, 150);
}

function handleMiniInput(e) {
    if(game.state !== 'minigame') return;
    if(e.key === 'ArrowUp') player.nextDir = {x:0, y:-1};
    if(e.key === 'ArrowDown') player.nextDir = {x:0, y:1};
    if(e.key === 'ArrowLeft') player.nextDir = {x:-1, y:0};
    if(e.key === 'ArrowRight') player.nextDir = {x:1, y:0};
}

function updateMinigame() {
    const isWall = (x, y) => PACMAN_MAP[y] && PACMAN_MAP[y][x] === 1;

    if(!isWall(player.x + player.nextDir.x, player.y + player.nextDir.y)) player.dir = player.nextDir;
    if(!isWall(player.x + player.dir.x, player.y + player.dir.y)) { player.x += player.dir.x; player.y += player.dir.y; }

    for(let i=0; i<pellets.length; i++) {
        if(pellets[i].x === player.x && pellets[i].y === player.y) { pellets.splice(i, 1); break; }
    }

    ghosts.forEach(g => {
        let moves = [{x:0,y:1}, {x:0,y:-1}, {x:1,y:0}, {x:-1,y:0}].filter(m => !isWall(g.x+m.x, g.y+m.y));
        let move = moves[Math.floor(Math.random()*moves.length)];
        if(move) { g.x+=move.x; g.y+=move.y; }
        if(g.x === player.x && g.y === player.y) finishMinigame(false);
    });

    drawMinigame();
    if(pellets.length === 0) finishMinigame(true);
}

function drawMinigame() {
    ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Desenhar Paredes
    ctx.fillStyle = '#445';
    for(let y=0; y<PACMAN_MAP.length; y++) {
        for(let x=0; x<PACMAN_MAP[0].length; x++) {
            if(PACMAN_MAP[y][x] === 1) ctx.fillRect(x*mapSize, y*mapSize, mapSize, mapSize);
        }
    }

    // Pellets
    ctx.fillStyle = '#AAA';
    pellets.forEach(p => ctx.fillRect(p.x*mapSize+10, p.y*mapSize+10, 5, 5));

    // Player
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x*mapSize+2, player.y*mapSize+2, mapSize-4, mapSize-4);

    // Fantasmas
    ctx.fillStyle = '#F00';
    ghosts.forEach(g => ctx.fillRect(g.x*mapSize+2, g.y*mapSize+2, mapSize-4, mapSize-4));
}

function finishMinigame(win) {
    clearInterval(minigameLoop);
    window.removeEventListener('keydown', handleMiniInput);
    game.state = 'game';
    
    if(win) { playSound('win'); updateStats(20); alert("GLITCH CORRIGIDO: +20% B√îNUS"); }
    else { playSound('lose'); updateStats(-20); alert("ERRO FATAL: -20% PENALIDADE"); }
    
    showScreen('game-screen');
    updateHUD();
    glitchCountdown = 30;
}

function updateStats(amount) {
    for(let k in game.stats) game.stats[k] = Math.min(100, Math.max(0, game.stats[k] + amount));
}

/* === HUD & UTILS === */
function updateHUD() {
    for(let k in game.stats) game.stats[k] = Math.min(100, Math.max(0, game.stats[k]));
    ['sanity','intimacy','door','battery'].forEach(k => {
        document.getElementById('val-'+k).innerText = Math.round(game.stats[k]) + '%';
        document.getElementById(k+'-bar').style.width = game.stats[k] + '%';
    });
    
    let totalPop = game.occupants.length + 1;
    document.getElementById('val-pop').innerText = `${totalPop}/4`;
    document.getElementById('val-pop').style.color = totalPop >= 4 ? '#F00' : '#FF0';
    document.getElementById('val-day').innerText = game.day;
    document.getElementById('clock-display').innerText = `${String(game.time.h).padStart(2,'0')}:${String(game.time.m).padStart(2,'0')}`;

    document.getElementById('btn-repair').disabled = game.stats.door >= 100 || game.uses.repair <= 0;
    document.getElementById('btn-repair').innerText = `üî® REPARAR (${game.uses.repair})`;
    document.getElementById('btn-tv').disabled = game.flags.tvUsed;
    document.getElementById('btn-focus').disabled = game.uses.focus <= 0;
    document.getElementById('btn-focus').innerText = `üßò FOCAR (${game.uses.focus})`;
    document.getElementById('btn-light').disabled = game.stats.battery <= 0;
    document.getElementById('btn-cam').disabled = game.stats.battery < 20 || game.uses.cam <= 0;
    document.getElementById('btn-cam').innerText = `üìπ C√ÇMERA (${game.uses.cam})`;
    document.getElementById('btn-gen').disabled = game.flags.generatorUsed; 
    document.getElementById('btn-gen').innerText = game.flags.generatorUsed ? "‚ö° GERADOR (USADO)" : "‚ö° GERADOR (1x)";

    if(game.stats.sanity <= 0) gameOver("SUA MENTE QUEBROU.");
    if(game.stats.intimacy <= 0) gameOver("VOC√ä FOI EXPULSO.");
    if(game.stats.door <= 0) gameOver("ELES ENTRARAM.");
}

/* === A√á√ïES === */
function getNextVisitor() { if (!game.nextVisitor) game.nextVisitor = visitorsPool[Math.floor(Math.random()*visitorsPool.length)]; return game.nextVisitor; }

function triggerVisitor() {
    playSound('knock');
    game.visitor = getNextVisitor(); game.nextVisitor = null;
    document.getElementById('peephole-overlay').classList.remove('hidden');
    document.getElementById('peephole-overlay').classList.add('active');
    document.getElementById('visitor-ascii-art').classList.add('dark-vision');
    document.getElementById('visitor-ascii-art').innerText = "??????\n? VULT ?\n??????";
    document.getElementById('dialogue-area').innerHTML = '';
    document.getElementById('decision-area').classList.add('hidden');
    document.getElementById('btn-scan').innerText = `üß¨ SCANNER (${game.uses.scan})`;
    document.getElementById('btn-scan').disabled = game.uses.scan <= 0;
    document.getElementById('btn-open').disabled = (game.occupants.length+1 >= 4);

    game.visitor.dialogues.forEach(d => {
        let btn = document.createElement('button');
        btn.innerText = d.q;
        btn.onclick = () => {
            document.getElementById('dialogue-area').innerText = `"${d.a}"`;
            game.stats.sanity += d.sanity;
            document.getElementById('decision-area').classList.remove('hidden');
        };
        document.getElementById('dialogue-area').appendChild(btn);
    });

    game.peepTime = 10;
    document.getElementById('peephole-timer-display').innerText = 10;
    if(peepTimer) clearInterval(peepTimer);
    peepTimer = setInterval(() => {
        game.peepTime--;
        document.getElementById('peephole-timer-display').innerText = game.peepTime;
        if(game.peepTime <= 0) { clearInterval(peepTimer); game.stats.sanity-=20; game.stats.door-=20; closePeephole(); }
    }, 1000);
}

function useLight() { if(game.stats.battery>0){game.stats.battery-=15; document.getElementById('visitor-ascii-art').classList.remove('dark-vision'); document.getElementById('visitor-ascii-art').innerText=game.visitor.art; updateHUD();} }
function useScanner() { if(game.uses.scan>0){game.uses.scan--; playSound('alarm'); let isHuman=game.visitor.type==='Humano'; document.getElementById('dialogue-area').innerHTML=isHuman?"HUMANO":"INFECTADO"; document.getElementById('btn-scan').innerText=`SCAN (${game.uses.scan})`; document.getElementById('btn-scan').disabled=true;} }
function useListen() { game.stats.sanity-=2; playSound(game.visitor.sound); updateHUD(); }
function resolveVisitor(choice) {
    clearInterval(peepTimer);
    if(choice==='open'){
        if(game.visitor.type==='Humano'){game.stats.intimacy+=10; game.occupants.push({name:"Sobrevivente",loyalty:50});}
        else{game.stats.sanity-=40; game.stats.intimacy-=30;}
    } else { game.stats.door-=20; if(game.visitor.type==='Humano') game.stats.sanity-=15; }
    closePeephole();
}
function closePeephole() { document.getElementById('peephole-overlay').classList.remove('active'); document.getElementById('peephole-overlay').classList.add('hidden'); updateHUD(); }

function openCameraScreen() { if(game.stats.battery<20 || game.uses.cam<=0)return; showScreen('camera-screen'); game.stats.battery-=20; game.uses.cam--; const target=getNextVisitor(); setTimeout(()=>{ document.getElementById('cam-result').classList.remove('hidden'); document.getElementById('cam-result').innerText = (target.type==='Humano' ? "HUMANO" : "INFECTADO"); document.getElementById('cam-loading').classList.add('hidden'); }, 1000); }
function closeCameraScreen() { showScreen('game-screen'); updateHUD(); document.getElementById('cam-result').classList.add('hidden'); document.getElementById('cam-loading').classList.remove('hidden'); }

function openManageScreen() { showScreen('manage-screen'); const l=document.getElementById('occupants-list'); l.innerHTML=''; game.occupants.forEach((o,i)=>{ l.innerHTML+=`<div>${o.name} (Lealdade: ${o.loyalty}%) <button onclick="care(${i})">CUIDAR</button><button onclick="kick(${i})">EXPULSAR</button></div>`; }); if(game.occupants.length===0) l.innerHTML="SOZINHO."; }
function care(i) { game.occupants[i].loyalty=Math.min(100,game.occupants[i].loyalty+20); game.time.m+=30; openManageScreen(); }
function kick(i) { game.occupants.splice(i,1); game.stats.sanity-=15; openManageScreen(); }
function closeManageScreen() { showScreen('game-screen'); }

function openTVScreen() { if(game.flags.tvUsed)return; showScreen('tv-screen'); document.getElementById('tv-content').innerHTML=''; document.getElementById('tv-ask-btn').disabled=false; }
function askTV() { const qa=tvScript[game.day-1]||{q:"...",a:"..."}; document.getElementById('tv-content').innerHTML=`<div class='tv-msg player'>${qa.q}</div>`; setTimeout(()=>{ document.getElementById('tv-content').innerHTML+=`<div class='tv-msg hive'>${qa.a}</div>`; game.flags.tvUsed=true; game.stats.sanity-=5; document.getElementById('tv-ask-btn').disabled=true; },1000); }
function closeTVScreen() { showScreen('game-screen'); updateHUD(); }

function actionRepair() { if(game.uses.repair>0){game.uses.repair--; game.time.h++; game.stats.door+=20; updateHUD();} }
function actionGenerator() { if(!game.flags.generatorUsed){game.time.h++; game.stats.battery=100; game.flags.generatorUsed=true; updateHUD();} }
function actionFocus() { if(game.uses.focus>0){game.uses.focus--; game.stats.sanity+=15; game.time.m+=30; updateHUD();} }

function endDay() { showScreen('report-screen'); document.getElementById('rank-grade').innerText=game.day; let s=game.stats.sanity+game.stats.intimacy+game.stats.door+(game.occupants.length*100); document.getElementById('score-total').innerText=s; document.getElementById('rank-grade').innerText=(s>500?'S':'D'); }
function goToMeeting() { showScreen('meeting-screen'); const g=document.getElementById('meeting-grid'); g.innerHTML=''; meetingTasks.forEach(t=>{ g.innerHTML+=`<button onclick="doMeeting('${t.name}',${t.san},${t.int})">${t.name}</button>`; }); if(game.occupants.length===0) g.innerHTML="<button onclick='nextDay()'>DORMIR SOZINHO</button>"; }
function doMeeting(n,s,i) { game.stats.sanity+=s; game.stats.intimacy+=i; game.occupants.forEach(o=>o.loyalty+=10); nextDay(); }

function nextDay() { if(game.mode==='normal'&&game.day>=8){clearInterval(gameLoop);clearInterval(glitchInterval);showScreen('victory-screen');} else { game.day++; resetDay(); showScreen('game-screen'); } }
function startEndlessMode() { game.mode='endless'; game.day++; resetDay(); showScreen('game-screen'); glitchCountdown=30; if(glitchInterval)clearInterval(glitchInterval); glitchInterval=setInterval(glitchTick,1000); if(gameLoop)clearInterval(gameLoop); gameLoop=setInterval(tick, TICK_SPEED); }
function gameOver(m) { clearInterval(gameLoop); clearInterval(glitchInterval); showScreen('game-over-screen'); document.getElementById('go-msg').innerText=m; }
    </script>
</body>
</html>