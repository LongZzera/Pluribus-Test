<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLURIBUS: A JUN√á√ÉO - Vigilante Edition v2.4</title>
    <style>
        :root {
            --bg-color: #050505;
            --text-primary: #e0e0e0;
            --text-dim: #666666;
            --text-alert: #ffcc00;
            --text-danger: #ff3333;
            --text-safe: #33ff33;
            --text-lore: #00ccff;
            --border-style: 1px solid var(--text-dim);
            --scan-color: rgba(255, 204, 0, 0.03);
            --cam-bg: #001100;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; background-color: var(--bg-color); color: var(--text-primary);
            font-family: 'Courier New', Courier, monospace; overflow: hidden;
            height: 100vh; display: flex; flex-direction: column; font-size: 14px;
        }

        /* --- FX --- */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, var(--scan-color) 50%, rgba(0,0,0,0) 50%);
            background-size: 100% 3px; pointer-events: none; z-index: 999;
        }
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9); pointer-events: none; z-index: 998;
        }
        
        /* --- LAYOUT --- */
        #game-container {
            display: flex; flex-direction: column; height: 100%; padding: 20px;
            z-index: 1; max-width: 1200px; margin: 0 auto; width: 100%; filter: blur(0.3px);
        }

        /* --- MENUS --- */
        .full-screen-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; border: 2px solid var(--text-dim);
        }
        
        .menu-btn {
            margin-top: 10px; font-size: 1.1em; padding: 10px 30px; width: 320px;
            border: 2px solid var(--text-alert); color: var(--bg-color);
            background: var(--text-alert); font-weight: bold; cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-btn:hover { transform: scale(1.05); }
        .menu-btn.secondary { background: transparent; color: var(--text-alert); border: 1px solid var(--text-alert); }

        #arcade-menu, #trophy-menu { display: none; }
        #arcade-stats { border: 1px solid var(--text-lore); padding: 15px; margin-bottom: 15px; width: 400px; background: #080808; }
        .rank-title { font-size: 1.5em; color: var(--text-lore); font-weight: bold; margin-bottom: 5px; }
        .xp-bar-container { width: 100%; height: 10px; background: #222; border: 1px solid #555; margin-top: 5px; }
        .xp-bar-fill { height: 100%; background: var(--text-lore); width: 0%; transition: width 0.5s; }

        /* --- HUD --- */
        #hud {
            border: 2px solid var(--text-dim); padding: 10px; margin-bottom: 15px;
            display: grid; grid-template-columns: 1fr 1fr 0.8fr 1fr 1fr; gap: 20px;
            background: rgba(20, 20, 20, 0.8); align-items: center;
        }
        .stat-box { display: flex; flex-direction: column; justify-content: center; }
        .stat-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9em; font-weight: bold; color: var(--text-alert); }
        .bar-container { width: 100%; background: #111; height: 12px; border: 1px solid #444; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--text-primary); transition: width 0.3s ease-out; }
        .bar-fill.danger { background: var(--text-danger); box-shadow: 0 0 10px var(--text-danger); }
        .bar-fill.safe { background: var(--text-safe); }
        #clock-box { border-left: 1px solid var(--text-dim); border-right: 1px solid var(--text-dim); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #clock-display { font-size: 1.6em; color: var(--text-alert); font-weight: bold; letter-spacing: 2px; }

        /* --- MAIN UI --- */
        #main-hub { display: flex; flex: 1; gap: 20px; overflow: hidden; transition: opacity 0.5s; }
        #room-view { flex: 1.5; border: var(--border-style); padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle at center, #111 0%, #000 100%); position: relative; }
        #ascii-art { white-space: pre; font-size: 11px; line-height: 12px; color: var(--text-primary); font-weight: bold; opacity: 0.8; text-align: center; }
        #location-name { position: absolute; top: 10px; left: 10px; color: var(--text-dim); letter-spacing: 2px; font-weight: bold; }
        #controls-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        .tabs { display: flex; border-bottom: 1px solid var(--text-dim); margin-bottom: 10px; }
        .tab-btn { flex: 1; background: transparent; border: none; color: var(--text-dim); padding: 8px; cursor: pointer; border-bottom: 2px solid transparent; font-family: inherit; }
        .tab-btn.active { color: var(--text-alert); border-bottom-color: var(--text-alert); font-weight: bold; background: rgba(255, 204, 0, 0.05); }
        .tab-content { display: none; flex-direction: column; gap: 10px; height: 100%; }
        .tab-content.active { display: flex; }
        .panel-section { border: var(--border-style); padding: 10px; background: rgba(20, 20, 20, 0.5); }
        .panel-title { color: var(--text-alert); font-weight: bold; margin-bottom: 8px; font-size: 0.9em; text-transform: uppercase; }

        button { background: #0a0a0a; color: var(--text-primary); border: 1px solid var(--text-dim); padding: 10px; font-family: 'Courier New'; cursor: pointer; margin-bottom: 5px; width: 100%; text-align: left; font-size: 0.85rem; display: flex; justify-content: space-between; transition: all 0.1s; }
        button:hover:not(:disabled) { background: #222; border-color: var(--text-primary); padding-left: 15px; }
        button:disabled { color: #444; border-color: #222; cursor: not-allowed; opacity: 0.6; }
        button.danger-action { border-color: var(--text-danger); color: var(--text-danger); }
        button.danger-action:hover { background: #300; }

        /* --- CCTV STYLES --- */
        #cctv-screen {
            width: 100%; height: 180px; background: var(--cam-bg); border: 2px solid #334433;
            margin-bottom: 10px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            font-family: monospace; color: #558855; white-space: pre;
        }
        #cctv-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
            pointer-events: none; animation: scrollScan 10s linear infinite;
        }
        #cctv-label { position: absolute; top: 5px; left: 5px; color: #33ff33; background: rgba(0,0,0,0.7); padding: 2px 5px; font-size: 0.8em; }
        #cctv-rec { position: absolute; top: 5px; right: 5px; color: red; animation: blink 1s infinite; font-weight: bold; }
        .cam-btn-group { display: flex; gap: 5px; }
        .cam-btn-group button { flex: 1; justify-content: center; font-size: 0.8em; }
        @keyframes scrollScan { from { background-position: 0 0; } to { background-position: 0 100%; } }

        /* --- TROPHY NOTIFICATION --- */
        #trophy-notification {
            position: fixed; top: 20px; right: 20px;
            background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 50px;
            padding: 10px 25px 10px 15px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transform: translateX(150%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 3000; color: #fff; pointer-events: none; min-width: 300px;
        }
        #trophy-notification.active { transform: translateX(0); }
        #trophy-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; background: #000; border: 2px solid #fff; }
        #trophy-details { display: flex; flex-direction: column; }
        #trophy-label { font-size: 0.7em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        #trophy-name { font-size: 1em; font-weight: bold; }

        /* --- TROPHY MENU LIST --- */
        #trophy-list { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 400px; overflow-y: auto; width: 500px; text-align: left; }
        .trophy-item { background: #0f0f0f; border: 1px solid #333; padding: 15px; display: flex; align-items: center; gap: 15px; opacity: 0.5; transition: 0.3s; }
        .trophy-item.unlocked { opacity: 1; border-color: var(--text-primary); background: #1a1a1a; }
        .t-icon { font-size: 2em; width: 50px; text-align: center; }
        .t-info h4 { margin: 0; color: #fff; }
        .t-info p { margin: 3px 0 0 0; font-size: 0.8em; color: #888; }
        
        /* --- MODALS & GAMEPLAY --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 100; display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.active { visibility: visible; opacity: 1; }

        #map-modal-content { background: #0a0a0a; border: 2px solid var(--text-alert); padding: 20px; width: 80%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .map-btn { padding: 15px; font-size: 1.1em; text-align: left; border: 1px solid #444; transition: 0.2s; cursor: pointer; color: #fff; background: #000; }
        .map-btn:hover { border-color: var(--text-safe); background: #111; color: var(--text-safe); }
        .map-btn small { display: block; font-size: 0.7em; color: #888; margin-top: 3px; }

        #peephole-layout { display: flex; gap: 20px; width: 95%; max-width: 1100px; height: 700px; }
        #visor-section { flex: 1; display: flex; flex-direction: column; align-items: center; border: 1px solid var(--text-dim); padding: 20px; background: #080808; position: relative; }
        #visor-circle { width: 280px; height: 280px; border-radius: 50%; border: 4px solid #333; background: #000; overflow: hidden; position: relative; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        #visor-circle.stress-high { border-color: var(--text-danger); box-shadow: 0 0 15px var(--text-danger); animation: shake 0.5s infinite; }
        #visitor-face { white-space: pre; font-size: 14px; text-align: center; z-index: 2; color: var(--text-primary); transition: opacity 0.1s; }
        #visor-circle.uv-active #visitor-face { opacity: 0.3; }
        .uv-hidden-text { position: absolute; color: transparent; font-weight: bold; z-index: 3; font-size: 1.2em; pointer-events: none;}
        #visor-circle.uv-active .uv-hidden-text { color: var(--text-safe); text-shadow: 0 0 8px var(--text-safe); }
        
        #data-section { flex: 1.4; display: flex; flex-direction: column; gap: 8px; }
        .investigation-card { background: #111; border: 1px solid var(--text-dim); padding: 12px; display: flex; flex-direction: column; gap: 5px; }
        .inv-header { color: var(--text-dim); font-size: 0.75em; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 3px; margin-bottom: 3px; display: flex; justify-content: space-between; }
        #id-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; font-family: monospace; color: #aaa; }
        .id-field strong { color: #fff; }
        .highlight-diff { color: var(--text-danger); animation: blink 1s infinite; }
        #stress-meter-container { width: 100%; height: 6px; background: #222; margin-top: 5px; }
        #stress-meter-fill { height: 100%; width: 0%; background: var(--text-safe); transition: width 0.3s, background 0.3s; }
        #dialogue-box { font-style: italic; color: #fff; height: 70px; overflow-y: auto; border-left: 2px solid var(--text-primary); padding-left: 10px; font-size: 0.95em; }
        .dialogue-options { display: flex; gap: 5px; }
        .dialogue-btn { flex: 1; font-size: 0.8em; padding: 8px; text-align: center; justify-content: center; background: #1a1a1a; border-color: #444; }
        .dialogue-btn:hover { background: #333; border-color: #888; }
        .scan-result-box { min-height: 25px; font-weight: bold; text-align: center; font-size: 1.1em; }
        .decision-area { margin-top: auto; border-top: 1px solid #333; padding-top: 10px; }
        .timer-bar-container { width: 100%; height: 15px; background: #000; border: 1px solid var(--text-danger); margin: 5px 0; }
        #timer-bar { width: 100%; height: 100%; background: var(--text-danger); }
        
        .crew-card { border: 1px solid #333; background: #080808; margin-bottom: 10px; padding: 10px; }
        .crew-header { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding-bottom: 5px; margin-bottom: 5px; }
        .crew-role { color: var(--text-alert); font-size: 0.8em; }
        .crew-hp-bar { width: 100%; height: 6px; background: #222; margin-bottom: 8px; }
        .crew-hp-fill { height: 100%; background: var(--text-safe); }
        .crew-actions { display: flex; gap: 5px; }
        .crew-actions button { font-size: 0.7em; padding: 5px; margin: 0; justify-content: center; text-align: center; }
        .lore-file { border: 1px solid #333; padding: 8px; margin-bottom: 5px; cursor: pointer; background: #080808; display: flex; justify-content: space-between; }
        .lore-file:hover { border-color: var(--text-lore); }
        .lore-file.locked { opacity: 0.5; cursor: default; border-style: dashed; }
        #log-container { height: 150px; overflow-y: auto; font-size: 12px; background: #000; border: 1px solid #333; padding: 8px; }
        .log-entry { margin-bottom: 4px; padding-left: 5px; border-left: 2px solid transparent; }
        .log-entry.alert { color: var(--text-danger); border-left-color: var(--text-danger); }
        .log-entry.safe { color: var(--text-safe); border-left-color: var(--text-safe); }
        .log-entry.lore { color: var(--text-lore); border-left-color: var(--text-lore); font-style: italic; }

        #radio-minigame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; height: 200px; background: #000; border: 2px solid var(--text-alert); z-index: 300; display: none; flex-direction: column; padding: 20px; box-shadow: 0 0 30px #000; }
        #radio-minigame.active { display: flex; }
        #tuner-bar-bg { width: 100%; height: 30px; background: #222; position: relative; margin: 20px 0; border: 1px solid #555; }
        #tuner-target { position: absolute; top: 0; height: 100%; width: 60px; background: rgba(0, 255, 0, 0.3); border-left: 1px solid #0f0; border-right: 1px solid #0f0; }
        #tuner-cursor { position: absolute; top: -5px; bottom: -5px; width: 4px; background: #fff; box-shadow: 0 0 5px #fff; left: 0; }
        #dream-modal { z-index: 3001; }
        .dream-content { width: 600px; background: #0a0a0a; border: 1px solid var(--text-primary); padding: 30px; text-align: center; }
        .dream-text { font-size: 1.1em; color: #bbb; margin-bottom: 30px; font-style: italic; line-height: 1.6; }
        .dream-choices { display: flex; gap: 20px; }
        .dream-choices button { text-align: center; justify-content: center; border-color: var(--text-dim); color: var(--text-dim); }
        .dream-choices button:hover { border-color: var(--text-primary); color: var(--text-primary); }

        .d-pad { display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px; gap: 5px; margin-top: 20px; justify-content: center; }
        .d-pad-btn { width: 60px; height: 60px; background: #111; border: 2px solid var(--text-alert); color: var(--text-alert); font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; transition: all 0.1s; }
        .d-pad-btn:active { background: var(--text-alert); color: #000; transform: scale(0.95); }
        .d-pad-up { grid-column: 2; grid-row: 1; }
        .d-pad-left { grid-column: 1; grid-row: 2; }
        .d-pad-down { grid-column: 2; grid-row: 2; }
        .d-pad-right { grid-column: 3; grid-row: 2; }

        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>

    <!-- TROPHY NOTIFICATION -->
    <div id="trophy-notification">
        <div id="trophy-icon">üèÜ</div>
        <div id="trophy-details">
            <span id="trophy-label">Trof√©u Conquistado</span>
            <span id="trophy-name">First Blood</span>
        </div>
    </div>

    <!-- MAIN START MENU -->
    <div id="start-menu" class="full-screen-menu">
        <h1>PLURIBUS</h1>
        <h2 style="color: #888; letter-spacing: 3px;">VIGILANTE EDITION</h2>
        
        <button class="menu-btn" onclick="game.startStory()">MODO HIST√ìRIA (CAMPANHA)</button>
        <button class="menu-btn secondary" onclick="arcadeMode.openMenu()">MODO ARCADE (MINIGAMES)</button>
        <button class="menu-btn secondary" style="border-color: var(--trophy-gold); color: var(--trophy-gold);" onclick="achievementSys.openMenu()">COLE√á√ÉO DE TROF√âUS</button>
        
        <div style="margin-top: 20px; font-size: 0.8em; color: #666;">V2.4.0 - SISTEMA DE C√ÇMERAS</div>
    </div>

    <!-- ARCADE MENU -->
    <div id="arcade-menu" class="full-screen-menu">
        <h1>SALA ARCADE</h1>
        <div id="arcade-stats">
            <div class="rank-title" id="rank-display">RANK: CIVIL</div>
            <div style="display:flex; justify-content:space-between;">
                <span>PONTUA√á√ÉO TOTAL:</span>
                <span id="total-score-display" style="color:white; font-weight:bold;">0</span>
            </div>
            <div class="xp-bar-container"><div id="xp-bar" class="xp-bar-fill"></div></div>
            <small id="next-rank-msg" style="color:#666;">PR√ìXIMO N√çVEL: 100 PTS</small>
        </div>
        
        <h3 style="color:var(--text-dim); border-bottom:1px solid #333; width:300px; margin-bottom:15px;">PROTOCOLO DE TREINO</h3>
        <button class="menu-btn" onclick="minigameManager.startSpecific('snake', 'arcade')">JOGAR: SNAKE-LINK</button>
        <button class="menu-btn" onclick="minigameManager.startSpecific('pac', 'arcade')">JOGAR: PAC-DATA</button>
        <button class="menu-btn" onclick="minigameManager.startSpecific('flappy', 'arcade')">JOGAR: FLAP-LINK</button>
        <button class="menu-btn" onclick="minigameManager.startSpecific('dino', 'arcade')">JOGAR: RUN-DATA</button>
        <button class="menu-btn" onclick="minigameManager.startSpecific('echo', 'arcade')">JOGAR: ECHO-MIND</button>
        <button class="menu-btn secondary" onclick="arcadeMode.closeMenu()" style="margin-top: 30px;">VOLTAR AO MENU</button>
    </div>

    <!-- TROPHY MENU -->
    <div id="trophy-menu" class="full-screen-menu">
        <h1 style="color: var(--trophy-plat)">SALA DE TROF√âUS</h1>
        <div id="trophy-list">
            <!-- Filled by JS -->
        </div>
        <button class="menu-btn secondary" onclick="achievementSys.closeMenu()" style="margin-top: 30px;">VOLTAR</button>
    </div>

    <!-- GAME CONTAINER -->
    <div id="game-container" style="display:none;">
        <div id="hud">
            <div class="stat-box"><div class="stat-header"><span>SANIDADE</span><span id="val-san">100%</span></div><div class="bar-container"><div id="bar-san" class="bar-fill"></div></div></div>
            <div class="stat-box"><div class="stat-header"><span>ENERGIA</span><span id="val-nrg">100%</span></div><div class="bar-container"><div id="bar-nrg" class="bar-fill"></div></div></div>
            <div id="clock-box"><div id="clock-display">08:00</div><div style="font-size: 0.7em; color: #888;">DIA <span id="val-day">1</span></div></div>
            <div class="stat-box"><div class="stat-header"><span>INTIMIDADE</span><span id="val-int">100%</span></div><div class="bar-container"><div id="bar-int" class="bar-fill"></div></div></div>
            <div class="stat-box"><div class="stat-header"><span>PORTA</span><span id="val-door">100%</span></div><div class="bar-container"><div id="bar-door" class="bar-fill safe"></div></div></div>
        </div>

        <div id="main-hub">
            <div id="room-view">
                <div id="location-name">BUNKER // ZONA SEGURA</div>
                <div id="ascii-art"></div>
                <div id="crew-display" style="margin-top:20px; font-size:0.8em; color:#444;"></div>
            </div>

            <div id="controls-panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="game.ui.switchTab('maint')">A√á√ïES</button>
                    <button class="tab-btn" onclick="game.ui.switchTab('cams')">C√ÇMERAS</button>
                    <button class="tab-btn" onclick="game.ui.switchTab('crew')">TRIPULA√á√ÉO</button>
                    <button class="tab-btn" onclick="game.ui.switchTab('archive')">ARQUIVO</button>
                    <button class="tab-btn" onclick="game.ui.switchTab('inventory')">ITENS</button>
                </div>
                
                <div id="tab-maint" class="tab-content active">
                    <div class="panel-section"><div class="panel-title" id="actions-title">COMANDOS</div><div id="dynamic-actions"></div></div>
                    <div class="panel-section" style="flex:1;"><div class="panel-title">REGISTRO</div><div id="log-container"></div></div>
                </div>

                <!-- CCTV TAB -->
                <div id="tab-cams" class="tab-content">
                    <div class="panel-section" style="flex:1;">
                        <div class="panel-title">MONITORAMENTO <span style="float:right; color:red;">REC ‚óè</span></div>
                        <div id="cctv-screen">
                            <div id="cctv-overlay"></div>
                            <div id="cctv-label">CAM 01 - CORREDOR</div>
                            <div id="cctv-feed">SINAL PERDIDO</div>
                        </div>
                        <div class="cam-btn-group">
                            <button onclick="cameraSys.switch(1)">CAM 01</button>
                            <button onclick="cameraSys.switch(2)">CAM 02</button>
                            <button onclick="cameraSys.switch(3)">CAM 03</button>
                        </div>
                        <p style="font-size:0.8em; color:#666; margin-top:10px;">
                            STATUS: <span id="cam-status" style="color:lime">ONLINE</span><br>
                            DRENO: -1 NRG/s
                        </p>
                    </div>
                </div>

                <div id="tab-crew" class="tab-content"><div class="panel-section" style="flex:1; overflow-y:auto;"><div class="panel-title">GEST√ÉO DE PESSOAL</div><div id="crew-container"></div></div></div>
                <div id="tab-archive" class="tab-content"><div class="panel-section" style="flex:1; overflow-y:auto;"><div class="panel-title">FRAGMENTOS DE DADOS</div><div style="margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;"><button onclick="game.actions.deepScan()" style="border-color:var(--text-lore); color:var(--text-lore);">VARREDURA PROFUNDA (-40 NRG)</button><small style="color:#666">Garante um arquivo de Lore se dispon√≠vel.</small></div><div id="lore-list"></div><div id="lore-display" style="margin-top:10px; padding:10px; border:1px dashed var(--text-lore); color: var(--text-lore); font-size:0.9em; min-height:100px; display:none;"></div></div></div>
                <div id="tab-inventory" class="tab-content"><div class="panel-section" style="flex:1; overflow-y:auto;"><div class="panel-title">ITENS CHAVE</div><div id="inventory-list" style="color: #888;">Vazio.</div></div></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="radio-minigame">
        <div class="panel-title">SINTONIA DE FREQU√äNCIA</div>
        <div id="tuner-bar-bg"><div id="tuner-target"></div><div id="tuner-cursor"></div></div>
        <p style="color: #888; font-size: 0.8em; text-align: center;">Clique para travar o sinal na √°rea verde.</p>
        <button onclick="radioGame.stop()" style="text-align: center; justify-content: center; margin-top: auto;">TRAVAR SINAL</button>
    </div>

    <div id="peephole-modal" class="modal-overlay">
        <div id="peephole-layout">
            <div id="visor-section">
                <div class="panel-title" style="width:100%; text-align:center;">C√ÇMERA DA PORTA</div>
                <div id="visor-circle"><div id="visitor-face"></div></div>
                <div style="width:100%; display:flex; flex-direction:column; gap:5px;">
                    <button id="btn-uv" onclick="game.encounter.toggleUV()">LUZ UV [OFF]</button>
                    <button id="btn-shotgun" onclick="game.encounter.shotgun()" class="danger-action">ESCOPETA (ELIMINAR)</button>
                </div>
            </div>
            <div id="data-section">
                <div class="investigation-card">
                    <div class="inv-header">CART√ÉO DE ACESSO <span id="doc-status" style="float:right">V√ÅLIDO</span></div>
                    <div id="id-card-grid">
                        <div class="id-field">NOME: <strong id="id-name">---</strong></div>
                        <div class="id-field">ID: <strong id="id-code">---</strong></div>
                        <div class="id-field">ORIGEM: <strong id="id-origin">---</strong></div>
                        <div class="id-field">TIPO SANG.: <strong id="id-blood">---</strong></div>
                        <div class="id-field">VALIDADE: <strong id="id-date">---</strong></div>
                    </div>
                </div>
                <div class="investigation-card">
                    <div class="inv-header">INTERROGAT√ìRIO <span style="float:right">ESTRESSE</span></div>
                    <div id="stress-meter-container"><div id="stress-meter-fill"></div></div>
                    <div id="dialogue-box">"..."</div>
                    <div class="dialogue-options">
                        <button class="dialogue-btn" onclick="game.encounter.ask('origin')">ORIGEM?</button>
                        <button class="dialogue-btn" onclick="game.encounter.ask('symptoms')">SINTOMAS?</button>
                        <button class="dialogue-btn" onclick="game.encounter.ask('blood')">SANGUE?</button>
                        <button class="dialogue-btn" onclick="game.encounter.ask('calm')">ACALMAR</button>
                    </div>
                </div>
                <div class="investigation-card">
                    <div class="inv-header">SCANNER BIOL√ìGICO (-5 ENERGIA)</div>
                    <button onclick="game.encounter.scan()" style="margin-bottom:5px;">INICIAR LEITURA</button>
                    <div id="scan-result" class="scan-result-box">DADOS OCULTOS</div>
                </div>
                <div class="decision-area">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="color:var(--text-danger)">TEMPO RESTANTE</span><span id="tension-display">30.0s</span>
                    </div>
                    <div class="timer-bar-container"><div id="timer-bar"></div></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="game.encounter.decide(true)" style="background:#003300; border-color:var(--text-safe);">ABRIR PORTA</button>
                        <button onclick="game.encounter.decide(false)" style="background:#330000; border-color:var(--text-danger);">RECUSAR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dream-modal" class="modal-overlay">
        <div class="dream-content">
            <h2 style="color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px;">SONHO L√öCIDO</h2>
            <div id="dream-text" class="dream-text">...</div>
            <div id="dream-options" class="dream-choices"></div>
        </div>
    </div>

    <div id="map-modal" class="modal-overlay">
        <div id="map-modal-content">
            <div class="panel-title" style="font-size: 1.4em; border-bottom: 1px solid #444; padding-bottom: 10px;">MAPA T√ÅTICO</div>
            <p style="color:#888; font-size:0.9em;">SELECIONE UM DESTINO. O TEMPO AVAN√áAR√Å.</p>
            <button class="map-btn" onclick="game.actions.travel('mercado')"><strong>MERCADO CENTRAL</strong><small>ALIMENTOS ‚Ä¢ ENERGIA ‚Ä¢ RISCO M√âDIO</small></button>
            <button class="map-btn" onclick="game.actions.travel('farmacia')"><strong>FARM√ÅCIA ANTIGA</strong><small>REM√âDIOS ‚Ä¢ LORE ‚Ä¢ RISCO ALTO</small></button>
            <button class="map-btn" onclick="game.actions.travel('ruas')"><strong>ZONA URBANA (RUAS)</strong><small>ITENS RAROS ‚Ä¢ SUCATA ‚Ä¢ RISCO EXTREMO</small></button>
            <button onclick="game.ui.toggleMap()" style="margin-top:10px; border-color: var(--text-dim); color: var(--text-dim);">CANCELAR</button>
        </div>
    </div>

    <div id="lore-modal" class="modal-overlay" style="z-index: 3000;">
        <div style="max-width:500px; background:#111; padding:30px; border:2px solid var(--text-primary); text-align:justify;">
            <h2 id="lore-title" style="color:var(--text-alert); text-align:center;">FIM DO DIA</h2>
            <p id="lore-text">...</p>
            <button id="next-day-btn" onclick="game.nextDay()" style="margin-top:20px; justify-content: center;">CONTINUAR</button>
        </div>
    </div>

    <!-- MINIGAME CONTAINER -->
    <div id="minigame-container" class="modal-overlay" style="z-index: 2999;">
        <div style="text-align:center;">
            <h2 id="minigame-title" style="color:var(--text-alert)">CALIBRAGEM NEURAL</h2>
            <p id="minigame-info" style="color: #888;">DADOS: <span id="pac-dots">0</span></p>
            <canvas id="minigame-canvas" width="400" height="400" style="border:2px solid var(--text-alert); background:#000;"></canvas>
            <div class="d-pad">
                <div class="d-pad-btn d-pad-up" onclick="minigameManager.handleInput('ArrowUp')">‚ñ≤</div>
                <div class="d-pad-btn d-pad-left" onclick="minigameManager.handleInput('ArrowLeft')">‚óÑ</div>
                <div class="d-pad-btn d-pad-down" onclick="minigameManager.handleInput('ArrowDown')">‚ñº</div>
                <div class="d-pad-btn d-pad-right" onclick="minigameManager.handleInput('ArrowRight')">‚ñ∫</div>
            </div>
            <p style="font-size: 0.8em; color: #444; margin-top: 10px;">Use as setas ou o teclado.</p>
            <button id="arcade-back-btn" style="display:none; margin-top:10px; border-color:red; color:red;" onclick="minigameManager.exitArcade()">SAIR DO JOGO</button>
        </div>
    </div>

    <script>
        const audioSys = {
            ctx: null,
            init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended') this.ctx.resume(); },
            playTone: function(f,t,d,v=0.1) { if(!this.ctx) return; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.type=t; o.frequency.setValueAtTime(f,this.ctx.currentTime); g.gain.setValueAtTime(v,this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+d); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d); },
            sfx: {
                click: ()=>audioSys.playTone(1200,'square',0.05), error: ()=>audioSys.playTone(150,'sawtooth',0.3), success: ()=>{ audioSys.playTone(600,'sine',0.1); setTimeout(()=>audioSys.playTone(900,'sine',0.2),100); },
                scan: ()=>audioSys.playTone(2000,'sine',0.2), lore: ()=> { audioSys.playTone(400,'sine',0.1); setTimeout(()=>audioSys.playTone(600,'sine',0.3), 150); },
                travel: ()=>audioSys.playTone(100,'square',1.0,0.2), knock: ()=>audioSys.playTone(80, 'square', 0.1, 0.3), glitch: ()=>audioSys.playTone(Math.random()*500, 'sawtooth', 0.05, 0.1), trophy: ()=> { audioSys.playTone(800,'sine',0.1); setTimeout(()=>audioSys.playTone(1200,'sine',0.3),100); },
                jump: ()=>audioSys.playTone(300, 'square', 0.1, 0.1)
            }
        };

        // --- PERSISTENT RANK ---
        const arcadeMode = {
            totalScore: 0,
            ranks: [ { name: "CIVIL", threshold: 0 }, { name: "RECRUTA", threshold: 100 }, { name: "SOBREVIVENTE", threshold: 300 }, { name: "EXPLORADOR", threshold: 600 }, { name: "OPERADOR", threshold: 1000 }, { name: "VETERANO", threshold: 1500 }, { name: "ELITE", threshold: 2200 }, { name: "HACKER NEURAL", threshold: 3000 }, { name: "MESTRE DO SISTEMA", threshold: 4000 }, { name: "A SINGULARIDADE", threshold: 5500 }, { name: "DEUS DA M√ÅQUINA", threshold: 7500 } ],
            
            init: function() {
                const saved = localStorage.getItem('pluribus_rank');
                if(saved) this.totalScore = parseInt(saved);
                this.updateUI();
            },
            openMenu: function() { document.getElementById('start-menu').style.display = 'none'; document.getElementById('arcade-menu').style.display = 'flex'; this.updateUI(); },
            closeMenu: function() { document.getElementById('arcade-menu').style.display = 'none'; document.getElementById('start-menu').style.display = 'flex'; },
            addScore: function(amount) { 
                this.totalScore += amount; 
                localStorage.setItem('pluribus_rank', this.totalScore); // Save
                if (this.totalScore >= 2000) achievementSys.unlock('arcade_2k'); if (this.totalScore >= 7500) achievementSys.unlock('arcade_max'); 
                this.updateUI(); 
            },
            updateUI: function() {
                const el = document.getElementById('total-score-display');
                if(el) el.innerText = this.totalScore;
                let c = this.ranks[0], n = this.ranks[1]; for (let i = 0; i < this.ranks.length; i++) { if (this.totalScore >= this.ranks[i].threshold) { c = this.ranks[i]; n = this.ranks[i+1] || null; } }
                const rankEl = document.getElementById('rank-display');
                if(rankEl) rankEl.innerText = "RANK: " + c.name;
                const msgEl = document.getElementById('next-rank-msg');
                if (n && msgEl) { msgEl.innerText = `PR√ìXIMO N√çVEL: ${n.threshold} PTS`; document.getElementById('xp-bar').style.width = `${((this.totalScore - c.threshold) / (n.threshold - c.threshold)) * 100}%`; } 
                else if(msgEl) { msgEl.innerText = "N√çVEL M√ÅXIMO"; document.getElementById('xp-bar').style.width = "100%"; }
            }
        };

        const achievementSys = {
            trophies: [
                { id: 'first_death', name: 'Primeiro Sangue', desc: 'Morra pela primeira vez.', type: 'bronze', earned: false },
                { id: 'first_human', name: 'Porteiro', desc: 'Deixe um humano entrar.', type: 'bronze', earned: false },
                { id: 'first_kill', name: 'Exterminador', desc: 'Use a escopeta.', type: 'bronze', earned: false },
                { id: 'lore_hunter', name: 'Curioso', desc: 'Encontre um arquivo de Lore.', type: 'bronze', earned: false },
                { id: 'survivor_5', name: 'Veterano', desc: 'Chegue ao Dia 5.', type: 'silver', earned: false },
                { id: 'arcade_2k', name: 'Hacker Neural', desc: '2000 pts no Arcade.', type: 'silver', earned: false },
                { id: 'true_end', name: 'A Verdade', desc: 'Descubra o final secreto.', type: 'silver', earned: false },
                { id: 'story_complete', name: 'Sobrevivente Real', desc: 'Complete o Modo Hist√≥ria.', type: 'gold', earned: false },
                { id: 'arcade_max', name: 'Lenda do Arcade', desc: 'Alcance o Rank Deus da M√°quina.', type: 'gold', earned: false },
                { id: 'platinum', name: 'A Consci√™ncia Final', desc: 'Obtenha todos os trof√©us.', type: 'plat', earned: false }
            ],
            init: function() {
                const saved = localStorage.getItem('pluribus_trophies');
                if (saved) { const savedData = JSON.parse(saved); this.trophies.forEach(t => { if (savedData.includes(t.id)) t.earned = true; }); }
            },
            unlock: function(id) {
                const trophy = this.trophies.find(t => t.id === id);
                if (trophy && !trophy.earned) { trophy.earned = true; this.save(); this.notify(trophy); this.checkPlatinum(); }
            },
            checkPlatinum: function() {
                const allEarned = this.trophies.filter(t => t.id !== 'platinum').every(t => t.earned);
                if (allEarned) this.unlock('platinum');
            },
            save: function() { localStorage.setItem('pluribus_trophies', JSON.stringify(this.trophies.filter(t => t.earned).map(t => t.id))); },
            notify: function(trophy) {
                const notif = document.getElementById('trophy-notification');
                document.getElementById('trophy-label').innerText = trophy.type === 'plat' ? "PLATINA OBTIDA" : "TROF√âU CONQUISTADO";
                document.getElementById('trophy-name').innerText = trophy.name;
                let c = '#cd7f32'; if(trophy.type === 'silver') c = '#c0c0c0'; if(trophy.type === 'gold') c = '#ffd700'; if(trophy.type === 'plat') c = '#e5e4e2';
                document.getElementById('trophy-icon').style.borderColor = c; document.getElementById('trophy-icon').style.color = c;
                audioSys.sfx.trophy(); notif.classList.add('active'); setTimeout(() => notif.classList.remove('active'), 4000);
            },
            openMenu: function() {
                document.getElementById('start-menu').style.display = 'none'; document.getElementById('trophy-menu').style.display = 'flex';
                const list = document.getElementById('trophy-list'); list.innerHTML = "";
                this.trophies.forEach(t => {
                    let c = '#444'; if(t.earned) { if(t.type==='bronze')c='#cd7f32'; if(t.type==='silver')c='#c0c0c0'; if(t.type==='gold')c='#ffd700'; if(t.type==='plat')c='#e5e4e2'; }
                    list.innerHTML += `<div class="trophy-item ${t.earned?'unlocked':''}"><div class="t-icon" style="color:${c}">üèÜ</div><div class="t-info"><h4>${t.name}</h4><p>${t.desc}</p></div></div>`;
                });
            },
            closeMenu: function() { document.getElementById('trophy-menu').style.display = 'none'; document.getElementById('start-menu').style.display = 'flex'; }
        };
        achievementSys.init();
        arcadeMode.init(); // Init arcade persistence

        const scenes = {
            bunker: `\n      _______________________\n     /                       \\\n    /    [R√ÅDIO]   [TV]       \\\n   |                          |\n   |    +------+              |\n   |    | CAMA |   [PORTA]    |\n   |    |      |      ||      |\n   |    +------+      ||      |\n   |                          |\n    \\                        /\n     \\______________________/`,
            mercado: `\n       _____________________\n      /   MERCADO CENTRAL   \\\n     /  [PRATELEIRAS VAZIAS] \\\n    |    __   __   __   __    |\n    |   |  | |  | |XX| |  |   |\n    |   |__| |__| |XX| |__|   |\n    |           /    \\        |\n    |          ( LIXO )       |\n     \\_______________________/`,
            farmacia: `\n       _____________________\n      /      FARM√ÅCIA       \\\n     /    [BALC√ÉO REVIRADO]  \\\n    |       +-------+         |\n    |       | MEDIC |         |\n    |       +-------+         |\n    |    ___                  |\n    |   |XXX|  [ARQUIVOS]     |\n     \\_______________________/`,
            ruas: `\n         _    _      _    _\n       _| |__| |____| |__| |_\n      /  RU√çNAS DA CIDADE    \\\n     |   _   _        _   _   |\n     |  | | | |      | | | |  |\n     |  |_| |_|      |_| |_|  |\n     |      [CARRO DESTR.]    |\n      \\______________________/`
        };

        const loreDB = [
            { id: 0, title: "Relat√≥rio M√©dico #01", text: "Paciente Zero exibe calcifica√ß√£o. V√≠rus digital. [BUFF: CUSTO DE CURA -5]", unlocked: false, loc: 'bunker', buff: 'heal_cost' },
            { id: 1, title: "Frequ√™ncia Theta", text: "Eles sentem medo via r√°dio. [BUFF: R√ÅDIO GASTA MENOS ENERGIA]", unlocked: false, loc: 'bunker', buff: 'radio_cost' },
            { id: 2, title: "Chave do Esgoto", text: "ITEM CHAVE. Permite acesso aos t√∫neis sob a cidade.", unlocked: false, loc: 'ruas', isItem: true },
            { id: 3, title: "Mapa dos T√∫neis", text: "Mostra a sa√≠da secreta para o Setor 7. [BUFF: VIAGEM R√ÅPIDA]", unlocked: false, loc: 'mercado', isItem: true, buff: 'travel_time' },
            { id: 4, title: "Amostra Zero", text: "Vial de sangue original. A cura potencial.", unlocked: false, loc: 'farmacia', isItem: true },
            { id: 5, title: "Di√°rio do Soldado", text: "N√£o h√° resgate. √â uma armadilha. [BUFF: DANO ESCOPETA]", unlocked: false, loc: 'ruas', buff: 'shotgun_sanity' }
        ];
        const dreamsDB = [ { text: "Sonho: O dia do surto no metr√¥.", choices: [ {l:"Ajudar", e:"san", v:-10, r:"Mordida."}, {l:"Correr", e:"nrg", v:10, r:"Sobreviveu."} ] }, { text: "Sonho: A voz da colmeia chama.", choices: [ {l:"Resistir", e:"san", v:15, r:"Mente forte."}, {l:"Ouvir", e:"san", v:-15, r:"Paz falsa."} ] } ];

        // --- CCTV SYSTEM ---
        const cameraSys = {
            activeCam: 1,
            feeds: {
                1: `\n  [CAM 01: CORREDOR]\n\n   [PORTA]   (vazio)\n\n`,
                2: `\n  [CAM 02: VENTILA√á√ÉO]\n\n   |||||||   (sil√™ncio)\n\n`,
                3: `\n  [CAM 03: RUA]\n\n   _ _ _     (chuva)\n\n`
            },
            switch: function(id) {
                this.activeCam = id;
                this.render();
                audioSys.sfx.click();
            },
            update: function() {
                // Random events
                if (Math.random() > 0.9) {
                    const events = ["(vulto)", "(ru√≠do)", "(olhos)", "!!!", "(est√°tica)"];
                    const ev = events[Math.floor(Math.random()*events.length)];
                    if(this.activeCam === 1) this.feeds[1] = `\n  [CAM 01: CORREDOR]\n\n   [PORTA]   ${ev}\n\n`;
                    if(this.activeCam === 2) this.feeds[2] = `\n  [CAM 02: VENTILA√á√ÉO]\n\n   |||||||   ${ev}\n\n`;
                    if(this.activeCam === 3) this.feeds[3] = `\n  [CAM 03: RUA]\n\n   _ _ _     ${ev}\n\n`;
                    this.render();
                }
            },
            render: function() {
                const screen = document.getElementById('cctv-feed');
                if(screen) screen.innerText = this.feeds[this.activeCam];
                document.getElementById('cctv-label').innerText = `CAM 0${this.activeCam}`;
            }
        };

        const minigameManager = {
            activeGame: null, canvas: null, ctx: null, mode: 'story',
            startRandom: function() { this.mode = 'story'; this.launch(['pac', 'snake', 'echo', 'flappy', 'dino'][Math.floor(Math.random()*5)]); },
            startSpecific: function(n, m) { this.mode = m; this.launch(n); document.getElementById('arcade-menu').style.display = 'none'; document.getElementById('arcade-back-btn').style.display = m === 'arcade' ? 'inline-block' : 'none'; },
            launch: function(c) {
                document.getElementById('minigame-container').classList.add('active');
                this.canvas = document.getElementById('minigame-canvas'); this.ctx = this.canvas.getContext('2d');
                this.startCountdown(() => {
                    if(c==='pac'){ pacGame.init(this.canvas); pacGame.start(); this.activeGame=pacGame; }
                    else if(c==='snake'){ snakeGame.init(this.canvas); snakeGame.start(); this.activeGame=snakeGame; }
                    else if(c==='echo'){ echoGame.init(this.canvas); echoGame.start(); this.activeGame=echoGame; }
                    else if(c==='flappy'){ flappyGame.init(this.canvas); flappyGame.start(); this.activeGame=flappyGame; }
                    else if(c==='dino'){ dinoGame.init(this.canvas); dinoGame.start(); this.activeGame=dinoGame; }
                });
            },
            startCountdown: function(cb) {
                let c=3; const i=setInterval(()=>{
                    this.ctx.fillStyle='#000'; this.ctx.fillRect(0,0,400,400); this.ctx.font="100px Courier New"; this.ctx.textAlign="center"; this.ctx.textBaseline="middle";
                    if(c>0){this.ctx.fillStyle="var(--text-alert)";this.ctx.fillText(c,200,200);audioSys.sfx.click();}
                    else{this.ctx.fillStyle="var(--text-safe)";this.ctx.fillText("VAI!",200,200);audioSys.sfx.success();}
                    c--; if(c<-1){clearInterval(i);cb();}
                },1000);
            },
            handleInput: function(k) { if(this.activeGame) this.activeGame.handleInput(k); },
            endGame: function(won, score = 0) {
                if(this.activeGame) this.activeGame.active=false;
                document.getElementById('minigame-container').classList.remove('active');
                
                // SAVE SCORE PERSISTENTLY
                if(score > 0) {
                    arcadeMode.addScore(score);
                    if(this.mode === 'story') game.log(`XP GANHO: ${score}`, "safe");
                }

                if (this.mode === 'story') game.resolveDay(won);
                else {
                    if (won) { alert(`VIT√ìRIA! +${score} PONTOS`); } else alert("GAME OVER");
                    document.getElementById('arcade-menu').style.display = 'flex';
                }
            },
            exitArcade: function() { if(this.activeGame) this.activeGame.active=false; document.getElementById('minigame-container').classList.remove('active'); document.getElementById('arcade-menu').style.display = 'flex'; }
        };
        window.addEventListener('keydown', (e)=>{if(document.getElementById('minigame-container').classList.contains('active'))minigameManager.handleInput(e.key);});

        // --- GAMES ---
        const snakeGame = {
            active:false, canvas:null, ctx:null, grid:20, snake:[], food:{}, velocity:{x:1,y:0}, inputQueue:[], score:0, target:20,
            init: function(c){this.canvas=c;this.ctx=c.getContext('2d');},
            start: function(){
                this.active=true; this.snake=[{x:10,y:10},{x:9,y:10},{x:8,y:10}]; this.score=0; this.velocity={x:1,y:0}; this.inputQueue=[]; this.spawnFood(); 
                this.target = minigameManager.mode === 'arcade' ? 15 : 5; 
                document.getElementById('minigame-title').innerText="SNAKE-LINK"; 
                document.getElementById('minigame-info').innerText=`ALVOS: ${this.target}`; 
                this.loop();
            },
            spawnFood: function(){let v=false; while(!v){this.food={x:Math.floor(Math.random()*20),y:Math.floor(Math.random()*20)}; v=!this.snake.some(s=>s.x===this.food.x&&s.y===this.food.y);}},
            handleInput: function(k){if(this.inputQueue.length>2)return; const last=this.inputQueue.length>0?this.inputQueue[this.inputQueue.length-1]:this.velocity; if(k==='ArrowUp'&&last.y===0)this.inputQueue.push({x:0,y:-1}); if(k==='ArrowDown'&&last.y===0)this.inputQueue.push({x:0,y:1}); if(k==='ArrowLeft'&&last.x===0)this.inputQueue.push({x:-1,y:0}); if(k==='ArrowRight'&&last.x===0)this.inputQueue.push({x:1,y:0});},
            loop: function(){if(!this.active)return; if(this.inputQueue.length>0)this.velocity=this.inputQueue.shift(); const h={x:this.snake[0].x+this.velocity.x, y:this.snake[0].y+this.velocity.y}; if(h.x<0||h.x>=20||h.y<0||h.y>=20||this.snake.some(s=>s.x===h.x&&s.y===h.y)){minigameManager.endGame(false, 0);return;} this.snake.unshift(h); if(h.x===this.food.x&&h.y===this.food.y){this.score++;audioSys.sfx.click();if(minigameManager.mode==='story' && this.score>=this.target){minigameManager.endGame(true, 50);return;} if(minigameManager.mode==='arcade' && this.score>=this.target){minigameManager.endGame(true, 100);return;} this.spawnFood();}else{this.snake.pop();} 
            this.ctx.fillStyle='#000';this.ctx.fillRect(0,0,400,400); this.ctx.fillStyle='#fc0';this.ctx.fillRect(this.food.x*20+2,this.food.y*20+2,16,16); this.ctx.fillStyle='#3f3';this.snake.forEach(s=>this.ctx.fillRect(s.x*20,s.y*20,18,18)); setTimeout(()=>requestAnimationFrame(()=>this.loop()),120);}
        };

        const echoGame = {
            active:false, canvas:null, ctx:null, seq:[], userSeq:[], level:1, showing:false,
            init: function(c){this.canvas=c;this.ctx=c.getContext('2d');},
            start: function(){this.active=true; this.level=1; 
            document.getElementById('minigame-title').innerText="ECHO-MIND"; 
            document.getElementById('minigame-info').innerText="MEMORIZE"; 
            this.startLevel();},
            startLevel: function(){this.seq=[]; this.userSeq=[]; for(let i=0;i<this.level+2;i++)this.seq.push(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'][Math.floor(Math.random()*4)]); this.showing=true; this.showSequence(0);},
            showSequence: function(i){if(i>=this.seq.length){this.showing=false;this.draw(null);return;} this.draw(this.seq[i]); audioSys.sfx.click(); setTimeout(()=>{this.draw(null);setTimeout(()=>this.showSequence(i+1),200)},600);},
            draw: function(d){this.ctx.fillStyle='#000';this.ctx.fillRect(0,0,400,400); if(!d)return; this.ctx.font="100px monospace"; this.ctx.fillStyle="#3f3"; this.ctx.textAlign="center"; this.ctx.fillText({'ArrowUp':'‚Üë','ArrowDown':'‚Üì','ArrowLeft':'‚Üê','ArrowRight':'‚Üí'}[d],200,240);},
            handleInput: function(k){if(this.showing)return; if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)){this.userSeq.push(k); this.draw(k); audioSys.sfx.click(); setTimeout(()=>this.draw(null),200); if(this.userSeq[this.userSeq.length-1]!==this.seq[this.userSeq.length-1]){minigameManager.endGame(false, 0);return;} if(this.userSeq.length===this.seq.length){this.level++; if(minigameManager.mode==='story' && this.level>3) minigameManager.endGame(true, 50); else if (minigameManager.mode==='arcade' && this.level>5) minigameManager.endGame(true, 150); else setTimeout(()=>this.startLevel(),1000);}}}
        };

        const pacGame = {
            active: false, canvas: null, ctx: null, grid: 20, map: [],
            player: {x:1, y:1, dir:{x:0,y:0}, nextDir:{x:0,y:0}, mouthOpen: 0, mouthSpeed: 0.2},
            ghosts: [], dots: 0, maxDots: 0, level: 1, score: 0, frame: 0,
            init: function(c) { this.canvas = c; this.ctx = c.getContext('2d'); },
            start: function() { this.active = true; this.score = 0; this.level = 1; this.initLevel(); this.loop(); },
            initLevel: function() {
                this.dots = 0; this.map = [];
                let ghostCount = 1 + (this.level - 1);
                this.ghosts = [];
                for(let i=0; i<ghostCount; i++) this.ghosts.push({x:9, y:9, color: i===0?'#ff0000':(i===1?'#ffb8ae':'#00ffff'), dir:{x:0,y:0}});
                document.getElementById('minigame-title').innerText = `PAC-DATA - LVL ${this.level}`;
                document.getElementById('minigame-info').innerHTML = 'DADOS: <span id="pac-dots">0</span>';
                for(let y=0; y<20; y++) { let row = []; for(let x=0; x<20; x++) { if (x===0 || x===19 || y===0 || y===19 || (x%2===0 && y%2===0)) row.push(0); else { row.push(1); this.dots++; } } this.map.push(row); }
                this.map[1][1] = 2; this.dots--; this.map[1][2] = 2; this.dots--; this.map[2][1] = 2; this.dots--; this.map[9][9] = 2; this.dots--;
                this.maxDots = this.dots; this.player = { x: 1, y: 1, dir: {x:0,y:0}, nextDir: {x:1,y:0}, mouthOpen: 0, mouthSpeed: 0.2 };
            },
            handleInput: function(k) { if(k==='ArrowUp') this.player.nextDir = {x:0, y:-1}; if(k==='ArrowDown') this.player.nextDir = {x:0, y:1}; if(k==='ArrowLeft') this.player.nextDir = {x:-1, y:0}; if(k==='ArrowRight') this.player.nextDir = {x:1, y:0}; },
            loop: function() {
                if(!this.active) return;
                this.frame++;
                let pd = this.player.nextDir; if (this.map[this.player.y + pd.y][this.player.x + pd.x] !== 0) this.player.dir = pd;
                let nx = this.player.x + this.player.dir.x; let ny = this.player.y + this.player.dir.y;
                if (this.map[ny][nx] !== 0) { this.player.x = nx; this.player.y = ny; }
                if (this.map[this.player.y][this.player.x] === 1) { this.map[this.player.y][this.player.x] = 2; this.dots--; this.score += 10; audioSys.sfx.click(); }
                
                if (this.frame % 2 === 0) { // Ghosts move at half speed
                    this.ghosts.forEach(g => {
                        if (Math.random() > 0.5) {
                             let dirs = [];
                             if (this.player.x > g.x) dirs.push({x:1,y:0}); if (this.player.x < g.x) dirs.push({x:-1,y:0}); if (this.player.y > g.y) dirs.push({x:0,y:1}); if (this.player.y < g.y) dirs.push({x:0,y:-1});
                             dirs = dirs.filter(d => this.map[g.y+d.y][g.x+d.x] !== 0);
                             if(dirs.length > 0) { let move = dirs[Math.floor(Math.random()*dirs.length)]; g.x += move.x; g.y += move.y; }
                        } else {
                            let moves = [{x:0,y:1}, {x:0,y:-1}, {x:1,y:0}, {x:-1,y:0}];
                            let valid = moves.filter(d => this.map[g.y+d.y][g.x+d.x] !== 0);
                            if(valid.length > 0) { let move = valid[Math.floor(Math.random()*valid.length)]; g.x += move.x; g.y += move.y; }
                        }
                    });
                }
                this.ghosts.forEach(g => { if(g.x === this.player.x && g.y === this.player.y) { minigameManager.endGame(false, this.score); return; } });
                
                this.ctx.fillStyle = '#000'; this.ctx.fillRect(0, 0, 400, 400);
                for(let y=0; y<20; y++) { for(let x=0; x<20; x++) { let cell = this.map[y][x]; if (cell === 0) { this.ctx.strokeStyle = '#1919A6'; this.ctx.lineWidth = 2; this.ctx.strokeRect(x*20+5, y*20+5, 10, 10); } else if (cell === 1) { this.ctx.fillStyle = '#ffb8ae'; this.ctx.beginPath(); this.ctx.arc(x*20+10, y*20+10, 3, 0, Math.PI*2); this.ctx.fill(); } } }
                
                this.player.mouthOpen += this.player.mouthSpeed; if (this.player.mouthOpen > 0.25 || this.player.mouthOpen < 0) this.player.mouthSpeed *= -1;
                let angle = 0; if (this.player.dir.x === -1) angle = Math.PI; if (this.player.dir.y === -1) angle = -Math.PI/2; if (this.player.dir.y === 1) angle = Math.PI/2;
                this.ctx.fillStyle = '#FFFF00'; this.ctx.beginPath(); this.ctx.arc(this.player.x*20+10, this.player.y*20+10, 8, angle + Math.PI*this.player.mouthOpen, angle + Math.PI*(2 - this.player.mouthOpen)); this.ctx.lineTo(this.player.x*20+10, this.player.y*20+10); this.ctx.fill();
                
                this.ghosts.forEach(g => {
                    this.ctx.fillStyle = g.color; this.ctx.beginPath(); this.ctx.arc(g.x*20+10, g.y*20+10, 8, Math.PI, 0); this.ctx.lineTo(g.x*20+18, g.y*20+18); this.ctx.lineTo(g.x*20+10, g.y*20+14); this.ctx.lineTo(g.x*20+2, g.y*20+18); this.ctx.fill();
                    this.ctx.fillStyle = '#fff'; this.ctx.beginPath(); this.ctx.arc(g.x*20+7, g.y*20+8, 2.5, 0, Math.PI*2); this.ctx.arc(g.x*20+13, g.y*20+8, 2.5, 0, Math.PI*2); this.ctx.fill();
                    this.ctx.fillStyle = '#000'; this.ctx.beginPath(); this.ctx.arc(g.x*20+7, g.y*20+8, 1, 0, Math.PI*2); this.ctx.arc(g.x*20+13, g.y*20+8, 1, 0, Math.PI*2); this.ctx.fill();
                });
                
                const scoreEl = document.getElementById('pac-dots'); if(scoreEl) scoreEl.innerText = this.dots;
                if(this.dots <= 0) { this.level++; if(this.level > 3) minigameManager.endGame(true, this.score + 500); else { alert(`N√çVEL ${this.level-1} COMPLETO!`); this.initLevel(); setTimeout(() => requestAnimationFrame(() => this.loop()), 120); } } 
                else setTimeout(() => requestAnimationFrame(() => this.loop()), 120);
            }
        };

        const flappyGame = {
            active: false, canvas: null, ctx: null,
            bird: { y: 200, vel: 0, size: 15 }, pipes: [], frame: 0, score: 0, target: 10,
            init: function(c) { this.canvas = c; this.ctx = c.getContext('2d'); },
            start: function() {
                this.active = true; this.bird = { y: 200, vel: 0, size: 15 }; this.pipes = []; this.frame = 0; this.score = 0; 
                this.target = minigameManager.mode === 'arcade' ? 30 : 10;
                document.getElementById('minigame-title').innerText = "FLAP-LINK";
                document.getElementById('minigame-info').innerText = `ALVO: ${this.target}`;
                this.loop();
            },
            handleInput: function(k) { if(k==='ArrowUp' || k===' ') { this.bird.vel = -6; audioSys.sfx.jump(); } },
            loop: function() {
                if(!this.active) return;
                this.frame++;
                this.bird.vel += 0.4; this.bird.y += this.bird.vel;
                if(this.frame % 90 === 0) {
                    let gapY = Math.floor(Math.random() * 200) + 50;
                    this.pipes.push({ x: 400, topH: gapY, bottomY: gapY + 120, passed: false });
                }
                this.pipes.forEach(p => p.x -= 3);
                this.pipes = this.pipes.filter(p => p.x > -30);
                if(this.bird.y < 0 || this.bird.y > 400) { minigameManager.endGame(false, this.score); return; }
                this.pipes.forEach(p => {
                    if(50 + this.bird.size > p.x && 50 < p.x + 30) {
                        if(this.bird.y < p.topH || this.bird.y + this.bird.size > p.bottomY) { minigameManager.endGame(false, this.score); return; }
                    }
                    if(!p.passed && p.x < 50) { this.score++; p.passed = true; audioSys.sfx.click(); if(minigameManager.mode === 'story' && this.score >= this.target) minigameManager.endGame(true, 50); }
                });
                this.ctx.fillStyle = '#000'; this.ctx.fillRect(0, 0, 400, 400);
                this.ctx.fillStyle = '#ffcc00'; this.ctx.fillRect(50, this.bird.y, this.bird.size, this.bird.size);
                this.ctx.fillStyle = '#33ff33';
                this.pipes.forEach(p => { this.ctx.fillRect(p.x, 0, 30, p.topH); this.ctx.fillRect(p.x, p.bottomY, 30, 400 - p.bottomY); });
                document.getElementById('minigame-info').innerText = `PONTOS: ${this.score} / ${this.target}`;
                setTimeout(() => requestAnimationFrame(() => this.loop()), 20);
            }
        };

        const dinoGame = {
            active: false, canvas: null, ctx: null,
            dino: { y: 350, vel: 0, grounded: true }, obst: [], frame: 0, score: 0, target: 500,
            init: function(c) { this.canvas = c; this.ctx = c.getContext('2d'); },
            start: function() {
                this.active = true; this.dino = { y: 350, vel: 0, grounded: true }; this.obst = []; this.frame = 0; this.score = 0;
                this.target = minigameManager.mode === 'arcade' ? 1000 : 500;
                document.getElementById('minigame-title').innerText = "RUN-DATA";
                document.getElementById('minigame-info').innerText = `DIST√ÇNCIA: 0`;
                this.loop();
            },
            handleInput: function(k) { if((k==='ArrowUp' || k===' ') && this.dino.grounded) { this.dino.vel = -12; this.dino.grounded = false; audioSys.sfx.jump(); } },
            loop: function() {
                if(!this.active) return;
                this.score += 2; this.frame++;
                if(!this.dino.grounded) { this.dino.vel += 0.8; this.dino.y += this.dino.vel; if(this.dino.y >= 350) { this.dino.y = 350; this.dino.vel = 0; this.dino.grounded = true; } }
                if(this.frame % 100 === 0 || (this.frame % 60 === 0 && Math.random() > 0.7)) { this.obst.push({ x: 400, h: Math.random()>0.5?30:50 }); }
                this.obst.forEach(o => o.x -= 5);
                this.obst = this.obst.filter(o => o.x > -20);
                this.obst.forEach(o => { if(o.x < 70 && o.x > 30 && this.dino.y > (350 - o.h + 10)) { minigameManager.endGame(false, this.score); return; } });
                this.ctx.fillStyle = '#000'; this.ctx.fillRect(0, 0, 400, 400);
                this.ctx.fillStyle = '#fff'; this.ctx.fillRect(0, 380, 400, 2); 
                this.ctx.fillStyle = '#00ccff'; this.ctx.fillRect(50, this.dino.y, 20, 30); 
                this.ctx.fillStyle = '#ff3333'; this.obst.forEach(o => this.ctx.fillRect(o.x, 380 - o.h, 15, o.h)); 
                document.getElementById('minigame-info').innerText = `DIST√ÇNCIA: ${this.score} / ${this.target}`;
                if(minigameManager.mode === 'story' && this.score >= this.target) minigameManager.endGame(true, 50);
                else setTimeout(() => requestAnimationFrame(() => this.loop()), 20);
            }
        };

        const radioGame = {
            active:false, pos:0, dir:1, target:0, anim:null,
            start: function() { this.active=true; document.getElementById('radio-minigame').classList.add('active'); this.target=20+Math.random()*60; document.getElementById('tuner-target').style.left=this.target+'%'; document.getElementById('tuner-target').style.width='20%'; this.loop(); },
            loop: function() { if(!this.active)return; this.pos+=1.5*this.dir; if(this.pos>100||this.pos<0)this.dir*=-1; document.getElementById('tuner-cursor').style.left=this.pos+'%'; this.anim=requestAnimationFrame(()=>this.loop()); },
            stop: function() { cancelAnimationFrame(this.anim); this.active=false; document.getElementById('radio-minigame').classList.remove('active'); if(this.pos>=this.target&&this.pos<=this.target+20){audioSys.sfx.success();game.state.sanity=Math.min(100,game.state.sanity+15);if(Math.random()>0.7)game.unlockLore('bunker');else game.log("Sinal limpo.", "safe");}else{audioSys.sfx.error();game.state.sanity-=5;game.log("Ru√≠do.", "alert");} game.updateHUD(); }
        };

        const game = {
            running: false, tickCount: 0,
            state: { day: 1, hour: 8.0, sanity: 100, energy: 100, intimacy: 100, doorHealth: 100, location: 'bunker', paused: false },
            crew: [], unlocks: { map: true, uv: false, shotgun: false },
            currentVisitor: null, tensionTimer: null, tensionVal: 30,

            startStory: function() {
                document.getElementById('start-menu').style.display = 'none'; audioSys.init();
                this.running = true; this.tickCount = 0; this.crew = [];
                this.state = { day: 1, hour: 8.0, sanity: 100, energy: 100, intimacy: 100, doorHealth: 100, location: 'bunker', paused: false };
                this.unlocks = { map: true, uv: false, shotgun: false };
                document.getElementById('game-container').style.display = 'flex';
                this.updateHUD(); this.ui.renderScene(); this.ui.renderLoreList(); this.ui.renderCrew(); cameraSys.render();
                this.log("SISTEMA ONLINE. ZONA SEGURA.", "safe");
                setInterval(() => { if(this.running && !this.state.paused && this.state.doorHealth > 0) this.tick(); }, 1000);
            },

            tick: function() {
                this.tickCount++;
                const timeMod = this.state.location === 'bunker' ? 0.05 : 0.15; 
                this.state.hour += timeMod;
                // Camera Drain
                if(document.getElementById('tab-cams').classList.contains('active')) {
                    game.state.energy -= 0.1;
                    cameraSys.update();
                }
                if(this.state.location === 'bunker' && this.tickCount % 40 === 0 && this.state.hour < 13.9) this.encounter.trigger();
                if(this.state.location !== 'bunker' && Math.random() > 0.95) { this.state.sanity -= 2; this.log("Sons de passos...", "alert"); }
                if(this.state.hour >= 14) this.triggerEndSequence();
                if(this.state.doorHealth <= 0) this.gameOver("A PORTA CAIU.");
                if(this.state.sanity <= 0) this.gameOver("COLAPSO MENTAL.");
                if(this.state.energy <= 0) this.state.energy = 0;
                this.updateHUD();
            },

            triggerEndSequence: function() {
                if(this.state.location !== 'bunker') { this.log("DESMAIO FORA DE CASA.", "alert"); this.state.sanity -= 30; this.state.energy -= 30; this.state.location = 'bunker'; this.ui.renderScene(); }
                this.state.paused = true; this.triggerDream();
            },

            triggerDream: function() {
                const modal = document.getElementById('dream-modal');
                const dream = dreamsDB[Math.floor(Math.random()*dreamsDB.length)];
                document.getElementById('dream-text').innerText = dream.text;
                const opts = document.getElementById('dream-options'); opts.innerHTML = "";
                dream.choices.forEach(c => {
                    const btn = document.createElement('button'); btn.innerText = c.l;
                    btn.onclick = () => { game.state[c.e] = Math.min(100, game.state[c.e] + c.v); modal.classList.remove('active'); setTimeout(() => minigameManager.startRandom(), 500); };
                    opts.appendChild(btn);
                });
                modal.classList.add('active');
            },

            resolveDay: function(won) {
                this.state.day++; this.state.hour = 8; this.state.energy = 100; this.tickCount = 0;
                if(this.state.day == 3) this.unlocks.uv = true; if(this.state.day == 5) this.unlocks.shotgun = true;
                if(this.state.day == 5) achievementSys.unlock('survivor_5');
                document.getElementById('lore-modal').classList.add('active');
                document.getElementById('lore-text').innerText = won ? "Teste conclu√≠do." : "Falha no teste.";
                if(won) this.state.sanity = Math.min(100, this.state.sanity + 20);
                if(this.state.day > 8) this.checkEndings();
            },

            checkEndings: function() {
                achievementSys.unlock('story_complete');
                const hasKey = loreDB.find(l => l.id===2).unlocked;
                const hasMap = loreDB.find(l => l.id===3).unlocked;
                const hasCure = loreDB.find(l => l.id===4).unlocked;
                const knowsTruth = loreDB.find(l => l.id===5).unlocked;
                if(knowsTruth) achievementSys.unlock('true_end');
                let title = "RESGATE"; let text = "Sobreviveu. Destino incerto.";
                if(hasKey && hasMap) { title = "FUGA"; text = "Escapou pelos t√∫neis."; } 
                else if (hasCure) { title = "SACRIF√çCIO"; text = "A cura foi entregue. Voc√™ morreu."; } 
                else if (knowsTruth) { title = "VERDADE"; text = "Resgate falso. Voc√™ se escondeu."; }
                document.getElementById('lore-title').innerText = title;
                document.getElementById('lore-text').innerText = text;
                document.getElementById('next-day-btn').innerText = "REINICIAR";
                document.getElementById('next-day-btn').onclick = () => location.reload();
            },

            nextDay: function() { document.getElementById('lore-modal').classList.remove('active'); this.state.paused = false; this.log(`DIA ${this.state.day}.`, "safe"); },

            unlockLore: function(locationFilter) {
                const candidates = loreDB.filter(l => !l.unlocked && (l.loc === locationFilter || locationFilter === 'any'));
                if(candidates.length > 0) {
                    const item = candidates[0]; item.unlocked = true;
                    game.log(`DADOS: ${item.title}`, "lore"); audioSys.sfx.lore();
                    achievementSys.unlock('lore_hunter');
                    this.ui.renderLoreList(); this.ui.renderInventory();
                } else { game.log("Nada encontrado.", "dim"); }
            },

            gameOver: function(reason) {
                this.running = false; achievementSys.unlock('first_death');
                document.body.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#000;color:red;font-family:Courier;flex-direction:column;text-align:center;"><h1>FALHA</h1><h2>${reason}</h2><button onclick="location.reload()" style="margin-top:20px;border:1px solid red;color:red;background:black;padding:10px;">REINICIAR</button></div>`;
            },

            actions: {
                watchTV: function() { if(game.state.energy>=10){game.state.energy-=10;game.state.sanity+=5;game.log("TV assistida.");audioSys.sfx.click();} game.updateHUD(); },
                radio: function() { 
                    let cost = 5;
                    if(loreDB[1].unlocked) cost = 2; // Buff from Lore
                    if(game.state.energy>=cost){game.state.energy-=cost;radioGame.start();} 
                    game.updateHUD(); 
                },
                repairDoor: function() { if(game.state.energy>=15){game.state.energy-=15;game.state.doorHealth=Math.min(100,game.state.doorHealth+20);game.log("Porta reparada.");audioSys.sfx.click();} game.updateHUD(); },
                travel: function(dest) {
                    let timeCost = 0.5;
                    if(loreDB[3].unlocked) timeCost = 0.2; // Buff from Lore
                    game.ui.toggleMap(); audioSys.sfx.travel(); game.log(`Viajando: ${dest.toUpperCase()}`);
                    document.getElementById('main-hub').style.opacity = 0;
                    setTimeout(() => { game.state.location = dest; game.state.energy -= 10; game.state.hour += timeCost; game.ui.renderScene(); document.getElementById('main-hub').style.opacity = 1; game.updateHUD(); }, 1000);
                },
                scavenge: function() {
                    if(game.state.energy < 20) { game.log("Cansado demais.", "alert"); return; }
                    game.state.energy -= 20; game.state.hour += 0.5;
                    const risk = game.state.location === 'ruas' ? 0.6 : 0.3;
                    if(Math.random() < risk) { game.log("EMBOSCADA!", "alert"); game.state.sanity -= 15; audioSys.sfx.error(); } 
                    else {
                        if(Math.random() > 0.6) game.unlockLore(game.state.location); 
                        else if (Math.random() > 0.3) {
                            if(game.state.location === 'mercado') { game.state.energy = Math.min(100, game.state.energy+40); game.log("Comida.", "safe"); }
                            if(game.state.location === 'farmacia') { game.state.sanity = Math.min(100, game.state.sanity+40); game.log("Rem√©dios.", "safe"); }
                            if(game.state.location === 'ruas') { game.state.doorHealth = Math.min(100, game.state.doorHealth+20); game.log("Pe√ßas.", "safe"); }
                        } else game.log("Vazio.", "dim");
                    }
                    game.updateHUD();
                },
                stealth: function() { if(game.state.energy < 10) return; game.state.energy -= 10; game.state.hour += 1.0; game.log("Furtivo.", "dim"); if(Math.random() > 0.7) game.unlockLore(game.state.location); game.updateHUD(); },
                returnHome: function() { game.actions.travel('bunker'); },
                interactCrew: function(idx, type) {
                    const crew = game.crew[idx]; if(!crew) return;
                    if(type === 'feed') { if(game.state.energy >= 10 && crew.hp < 100) { game.state.energy -= 10; crew.hp = Math.min(100, crew.hp + 20); game.log(`Voc√™ alimentou ${crew.name}.`, "safe"); audioSys.sfx.click(); } }
                    if(type === 'talk') { game.state.hour += 0.1; game.state.sanity = Math.min(100, game.state.sanity + 5); game.log(`${crew.name} conversou.`, "lore"); }
                    if(type === 'heal') { 
                        let cost = 20;
                        if(loreDB[0].unlocked) cost = 15; // Buff from Lore
                        if(game.state.energy >= cost) { game.state.energy -= cost; crew.hp = 100; game.log(`${crew.name} curado.`, "safe"); } 
                    }
                    game.updateHUD(); game.ui.renderCrew();
                },
                deepScan: function() {
                    if(game.state.energy < 40) { game.log("Energia insuficiente.", "alert"); return; }
                    game.state.energy -= 40;
                    let loc = game.state.location;
                    if(loc === 'bunker') loc = 'any';
                    game.unlockLore(loc);
                    game.updateHUD();
                }
            },

            encounter: {
                visitorData: null,
                trigger: function() {
                    game.state.paused = true; audioSys.sfx.knock(); game.log("BATIDA NA PORTA.", "alert");
                    const isDistorted = Math.random() > 0.5; const stress = 0; const name = "Visitante " + Math.floor(Math.random() * 99); const id = Math.floor(1000 + Math.random() * 9000);
                    const trueData = { blood: ['A+', 'O-', 'B+', 'AB+'][Math.floor(Math.random()*4)], origin: ['Setor 7', 'Norte', 'Sul', 'Bunker 4'][Math.floor(Math.random()*4)], expired: Math.random() > 0.8 };
                    const idCardData = { name: name, id: id, blood: isDistorted && Math.random()>0.5 ? 'AB-' : trueData.blood, origin: isDistorted && Math.random()>0.5 ? 'Desconhecido' : trueData.origin, expiry: trueData.expired ? 'EXPIRADO' : 'V√ÅLIDO' };
                    this.visitorData = { isDistorted, stress, trueData, idCardData, scanned: false };
                    document.getElementById('peephole-modal').classList.add('active');
                    document.getElementById('visitor-face').innerText = this.getFace(isDistorted);
                    document.getElementById('id-name').innerText = idCardData.name; document.getElementById('id-code').innerText = idCardData.id; document.getElementById('id-origin').innerText = idCardData.origin; document.getElementById('id-blood').innerText = idCardData.blood; document.getElementById('id-date').innerText = idCardData.expiry; document.getElementById('id-date').style.color = idCardData.expiry==='EXPIRADO' ? 'red' : 'lime';
                    document.getElementById('dialogue-box').innerText = "..."; document.getElementById('scan-result').innerText = "AGUARDANDO"; document.getElementById('scan-result').style.color = "#666"; document.getElementById('visor-circle').classList.remove('stress-high');
                    game.tensionVal = 30;
                    game.tensionTimer = setInterval(() => {
                        if(!game.state.paused) return; 
                        game.tensionVal -= 0.1; document.getElementById('tension-display').innerText = game.tensionVal.toFixed(1) + 's'; document.getElementById('timer-bar').style.width = (game.tensionVal/30)*100 + "%";
                        if(this.visitorData.stress > 50) this.glitchEffect();
                        if(game.tensionVal <= 0) this.decide(false);
                    }, 100);
                },
                getFace: function(d) { const e = d ? ['@ @','X X'] : ['o o','- -']; const h = d ? 'MORTAL' : 'VIVO'; return `\n      ///////\n     /       \\\n    |  ${e[0]}  |\n    |    |    |\n    |  _____  |\n     \\_______/\n     <span class="uv-hidden-text">${h}</span>`; },
                glitchEffect: function() { if(this.visitorData.isDistorted) { if(Math.random() > 0.8) { document.getElementById('visitor-face').innerText = this.getFace(true).replace(/./g, c => Math.random()>0.8?'#':c); audioSys.sfx.glitch(); } } document.getElementById('visor-circle').classList.add('stress-high'); },
                ask: function(type) {
                    this.visitorData.stress += 15; this.updateStressUI(); let resp = "..."; const d = this.visitorData;
                    if(type === 'origin') resp = d.isDistorted ? "De... longe..." : `Eu vim de ${d.trueData.origin}.`;
                    if(type === 'symptoms') resp = d.isDistorted ? "Fome... muita fome..." : "Estou limpo.";
                    if(type === 'blood') resp = d.isDistorted ? "Vermelho... eu acho." : `Sou ${d.trueData.blood}.`;
                    if(type === 'calm') { this.visitorData.stress = Math.max(0, this.visitorData.stress - 30); game.tensionVal += 5; resp = "Obrigado... estava nervoso."; this.updateStressUI(); }
                    document.getElementById('dialogue-box').innerText = `"${resp}"`;
                },
                updateStressUI: function() { document.getElementById('stress-meter-fill').style.width = this.visitorData.stress + '%'; if(this.visitorData.stress > 50) document.getElementById('stress-meter-fill').style.background = 'red'; else document.getElementById('stress-meter-fill').style.background = 'lime'; },
                scan: function() { if(game.state.energy < 5) return; game.state.energy -= 5; audioSys.sfx.scan(); game.updateHUD(); const d = this.visitorData; let res = `SANGUE: ${d.trueData.blood} | DNA: ${d.isDistorted ? 'CORROMPIDO' : 'NORMAL'}`; if(d.trueData.blood !== d.idCardData.blood) res += " [ERRO DE TIPO]"; const el = document.getElementById('scan-result'); el.innerText = res; el.style.color = d.isDistorted || d.trueData.blood !== d.idCardData.blood ? "red" : "lime"; },
                toggleUV: function() { if(game.unlocks.uv) document.getElementById('visor-circle').classList.toggle('uv-active'); },
                shotgun: function() { 
                    let loss = 15;
                    if(loreDB[5].unlocked) loss = 5; // Buff from Lore
                    audioSys.sfx.error(); game.state.sanity-=loss; achievementSys.unlock('first_kill'); this.close(); 
                },
                decide: function(accept) {
                    const d = this.visitorData;
                    if(accept) { if(d.isDistorted) game.gameOver("VOC√ä DEIXOU UM MONSTRO ENTRAR."); else { game.state.sanity += 10; game.crew.push({name: d.idCardData.name, hp: 100, role: 'CIVIL'}); game.log("Sobrevivente salvo.", "safe"); achievementSys.unlock('first_human'); } } 
                    else { game.state.doorHealth -= 10; if(!d.isDistorted) { game.state.sanity -= 20; game.log("Inocente deixado para morrer.", "alert"); } else game.log("Amea√ßa barrada.", "safe"); audioSys.sfx.error(); }
                    this.close();
                },
                close: function() { clearInterval(game.tensionTimer); document.getElementById('peephole-modal').classList.remove('active'); game.state.paused = false; game.ui.renderCrew(); game.updateHUD(); }
            },

            ui: {
                switchTab: function(t) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); event.target.classList.add('active'); },
                toggleMap: function() { document.getElementById('map-modal').classList.toggle('active'); },
                renderLoreList: function() { const l = document.getElementById('lore-list'); l.innerHTML=""; loreDB.filter(i=>!i.isItem).forEach(i => { l.innerHTML += `<div class="lore-file ${i.unlocked?'':'locked'}" onclick="if(${i.unlocked}){document.getElementById('lore-display').innerHTML='${i.text}';document.getElementById('lore-display').style.display='block';}"><span class="lore-title">${i.unlocked?i.title:'BLOQUEADO'}</span></div>`; }); },
                renderInventory: function() { const l = document.getElementById('inventory-list'); l.innerHTML=""; const items = loreDB.filter(i=>i.isItem && i.unlocked); if(items.length===0) l.innerHTML="Vazio."; else items.forEach(i => { l.innerHTML += `<div style="color:gold; border:1px solid gold; padding:5px; margin:5px;">‚òÖ ${i.title}</div>`; }); },
                renderCrew: function() {
                    const c = document.getElementById('crew-container'); c.innerHTML = "";
                    if(game.crew.length === 0) { c.innerHTML = `<div style="color:#666; padding:10px;">Sozinho.</div>`; return; }
                    game.crew.forEach((m, idx) => { c.innerHTML += `<div class="crew-card"><div class="crew-header"><strong>${m.name}</strong> <span class="crew-role">[${m.role}]</span></div><div class="crew-hp-bar"><div class="crew-hp-fill" style="width:${m.hp}%"></div></div><div class="crew-actions"><button onclick="game.actions.interactCrew(${idx}, 'feed')">ALIMENTAR (-10)</button><button onclick="game.actions.interactCrew(${idx}, 'talk')">CONVERSAR</button><button onclick="game.actions.interactCrew(${idx}, 'heal')" style="border-color:var(--text-safe); color:var(--text-safe)">CURAR (-20)</button></div></div>`; });
                },
                renderScene: function() {
                    const loc = game.state.location; document.getElementById('ascii-art').innerText = scenes[loc]; document.getElementById('location-name').innerText = loc.toUpperCase() + " // " + (loc==='bunker'?"ZONA SEGURA":"ZONA DE RISCO");
                    const btns = document.getElementById('dynamic-actions'); btns.innerHTML = "";
                    if(loc === 'bunker') { document.getElementById('actions-title').innerText = "SISTEMAS VITAIS"; btns.innerHTML = `<button onclick="game.actions.watchTV()"><span>TV</span><span>-10E</span></button><button onclick="game.actions.radio()"><span>R√°dio</span><span>-5E</span></button><button onclick="game.actions.repairDoor()"><span>Reparar</span><span>-15E</span></button><button onclick="game.ui.toggleMap()"><span>MAPA T√ÅTICO</span><span>VIAJAR</span></button>`; } 
                    else { document.getElementById('actions-title').innerText = "A√á√ïES DE CAMPO"; btns.innerHTML = `<button onclick="game.actions.scavenge()"><span>VASCULHAR</span><span>-20E / ALTO RISCO</span></button><button onclick="game.actions.stealth()"><span>ESGUEIRAR</span><span>-10E / BAIXO RISCO</span></button><button onclick="game.actions.returnHome()" style="border-color:var(--text-safe); color:var(--text-safe)"><span>VOLTAR AO BUNKER</span><span>SEGURO</span></button>`; }
                }
            },

            log: function(msg, type="") { const c = document.getElementById('log-container'); c.innerHTML = `<div class="log-entry ${type}">> ${msg}</div>` + c.innerHTML; },
            updateHUD: function() {
                const s = game.state; document.getElementById('val-san').innerText = Math.floor(s.sanity) + "%"; document.getElementById('bar-san').style.width = s.sanity + "%";
                document.getElementById('val-nrg').innerText = Math.floor(s.energy) + "%"; document.getElementById('bar-nrg').style.width = s.energy + "%";
                document.getElementById('val-door').innerText = Math.floor(s.doorHealth) + "%"; document.getElementById('bar-door').style.width = s.doorHealth + "%";
                document.getElementById('val-int').innerText = Math.floor(s.intimacy) + "%"; document.getElementById('bar-int').style.width = s.intimacy + "%";
                let h = Math.floor(s.hour); let m = Math.floor((s.hour-h)*60); document.getElementById('clock-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; document.getElementById('val-day').innerText = s.day;
            }
        };
    </script>
</body>
</html>