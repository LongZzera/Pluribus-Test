<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLURIBUS: A JUN√á√ÉO | The Bunker Experience</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', monospace; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        
        #overlay, #narrative-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #ffcc00; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
            cursor: pointer; text-align: center;
        }
        #narrative-overlay { display: none; cursor: default; background: rgba(0,0,0,0.95); z-index: 2000; }
        
        #overlay h1 { text-shadow: 0 0 10px #ffcc00; margin-bottom: 10px; }
        #overlay p { opacity: 0.8; max-width: 600px; line-height: 1.5; }

        .narrative-title { font-size: 32px; margin-bottom: 20px; color: #fff; text-transform: uppercase; letter-spacing: 4px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; }
        .narrative-body { font-size: 18px; max-width: 700px; color: #ddd; margin-bottom: 40px; line-height: 1.6; }
        .narrative-choices { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .choice-btn {
            background: transparent; border: 2px solid #555; color: #aaa;
            padding: 15px 30px; font-family: 'Courier New'; font-size: 16px;
            cursor: pointer; transition: 0.3s; min-width: 200px;
        }
        .choice-btn:hover { border-color: #ffcc00; color: #ffcc00; background: rgba(255, 204, 0, 0.1); }
        .consequence-text { margin-top: 20px; font-style: italic; color: #ff3333; opacity: 0; transition: opacity 1s; }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: rgba(255, 255, 255, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 50;
            mix-blend-mode: difference;
        }

        #trophy-popup {
            position: absolute; top: -100px; left: 50px; 
            width: 300px; height: 60px;
            background: rgba(20, 20, 20, 0.95);
            border-radius: 40px;
            border-left: 5px solid #ffcc00;
            display: flex; align-items: center; padding: 10px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000; pointer-events: none;
        }
        #trophy-icon {
            width: 40px; height: 40px; border-radius: 50%;
            background: #ffcc00; color: #000;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 20px; margin-right: 15px;
        }
        #trophy-text h4 { margin: 0; color: #fff; font-size: 14px; font-family: sans-serif; }
        #trophy-text p { margin: 0; color: #aaa; font-size: 12px; font-family: sans-serif; }

        #hud-overlay {
            position: absolute; top: 20px; right: 20px; width: 250px;
            padding: 15px; background: rgba(20, 20, 0, 0.1);
            border: 2px solid #ffcc00; color: #ffcc00;
            font-family: 'Courier New', monospace; font-size: 14px;
            z-index: 95; pointer-events: none;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
        }
        .hud-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .hud-label { font-weight: bold; }
        .hud-bar-container { width: 100px; height: 10px; background: #111; border: 1px solid #554400; margin-top: 4px; }
        .hud-bar-fill { height: 100%; background: #ffcc00; transition: width 0.3s; }
        .danger { color: #ff3333; }
        .danger .hud-bar-fill { background: #ff3333; }
        #timer-display { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 10px; color: #fff; text-shadow: 0 0 5px #ffcc00; }
        .hud-quota-val { color: #fff; font-weight: bold; }

        #message-log {
            position: absolute; bottom: 20px; left: 20px; color: #ffcc00;
            font-size: 14px; opacity: 0.8; pointer-events: none; z-index: 80;
            text-shadow: 1px 1px 2px black;
            white-space: pre-line;
        }

        #peephole-ui {
            display: none; 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200;
            background: radial-gradient(circle, transparent 10%, black 70%); 
            pointer-events: auto;
        }

        #visitor-visual {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: monospace; font-size: 14px; color: #ffcc00; white-space: pre;
            text-align: center; opacity: 0.8; filter: blur(1px);
            pointer-events: none;
        }

        #dialogue-box {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            width: 600px; background: rgba(20, 15, 0, 0.9); border: 2px solid #ffcc00;
            padding: 15px; color: #ffcc00; font-family: 'Courier New'; display: none;
            text-align: center;
        }
        
        .typing-effect::after { content: '‚ñå'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #door-controls {
            position: absolute; bottom: 50px; width: 100%; display: flex; 
            justify-content: center; gap: 20px; pointer-events: auto;
        }

        .door-btn {
            background: #111; border: 2px solid #555; color: #aaa; padding: 15px 30px;
            font-family: 'Courier New'; font-weight: bold; cursor: pointer;
            transition: 0.2s; text-transform: uppercase; letter-spacing: 2px;
        }
        .door-btn:hover { color: #fff; border-color: #fff; }
        .btn-interrogate { border-color: #ffcc00; color: #ffcc00; }
        .btn-interrogate:hover { background: #332200; }
        .btn-open { border-color: #aaaa00; color: #ffff00; }
        .btn-open:hover { background: #333300; }
        .btn-shock { border-color: #ff3333; color: #ff3333; }
        .btn-shock:hover { background: #330000; }
        
        #room-indicator {
            position: absolute; top: 20px; left: 20px;
            color: #ffcc00; font-size: 24px; font-weight: bold;
            z-index: 95; text-shadow: 0 0 5px #ffcc00;
        }
        #room-controls-hint {
            position: absolute; top: 50px; left: 20px;
            color: #aaa; font-size: 12px;
            z-index: 95;
        }
        #device-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ffcc00; font-size: 24px; display: none; pointer-events: none; text-shadow: 1px 1px 2px black;
        }

        #vhs-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 90;
            background: linear-gradient(rgba(18, 16, 0, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 200, 0, 0.06), rgba(255, 200, 0, 0.02), rgba(255, 200, 0, 0.06));
            background-size: 100% 2px, 3px 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
        }
        #scanline {
            width: 100%; height: 10px; background: rgba(255,200,0,0.05); opacity: 0.1;
            position: absolute; z-index: 91; pointer-events: none;
            animation: scanline 6s linear infinite;
        }
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }
    </style>
</head>
<body>

<div id="overlay">
    <h1>PLURIBUS: A JUN√á√ÉO</h1>
    <p>MODO HIST√ìRIA: SOBREVIV√äNCIA DE 8 DIAS</p>
    <br>
    <p style="font-size: 12px; color: #aa8800;">[CLIQUE PARA INICIAR]</p>
    <br>
    <p>
        <b>OBJETIVO:</b> Sobreviva at√© o Dia 8.<br>
        <b>CONTROLES:</b> [Q] e [E] para trocar de c√¥modo.<br>
        <b>INTERA√á√ÉO:</b> Clique nos aparelhos para usar.
    </p>
</div>

<div id="narrative-overlay">
    <div class="narrative-title" id="narrative-title">NOITE 1: O SINAL</div>
    <div class="narrative-body" id="narrative-body">...</div>
    <div class="narrative-choices" id="narrative-choices"></div>
    <div class="consequence-text" id="consequence-text"></div>
</div>

<div id="game-container">
    <div id="vhs-overlay"></div>
    <div id="scanline"></div>
    <div id="crosshair"></div>
    <div id="room-indicator">BUNKER</div>
    <div id="room-controls-hint">[Q] ANTERIOR | [E] PR√ìXIMO</div>
    <div id="device-hint">CLIQUE PARA USAR</div>
    
    <div id="trophy-popup">
        <div id="trophy-icon">üèÜ</div>
        <div id="trophy-text">
            <h4>Conquista Desbloqueada</h4>
            <p id="trophy-name">Nome do Trof√©u</p>
        </div>
    </div>

    <div id="hud-overlay">
        <div id="timer-display">05:00</div>
        <div class="hud-row"><span class="hud-label">DIA:</span><span id="hud-day">1/8</span></div>
        <div class="hud-row"><span class="hud-label">COTA:</span><span id="hud-quota" class="hud-quota-val">0/2</span></div>
        <div class="hud-row" id="row-sanity"><span class="hud-label">SANIDADE:</span><div class="hud-bar-container"><div id="bar-sanity" class="hud-bar-fill" style="width: 80%"></div></div></div>
        <div class="hud-row" id="row-door"><span class="hud-label">PORTA:</span><div class="hud-bar-container"><div id="bar-door" class="hud-bar-fill" style="width: 100%"></div></div></div>
        <div class="hud-row" id="row-family"><span class="hud-label">FAM√çLIA:</span><div class="hud-bar-container"><div id="bar-family" class="hud-bar-fill" style="width: 100%"></div></div></div>
        <div class="hud-row"><span class="hud-label" style="font-size:10px; color:#aa8800;">RECURSOS (ENERGIA): <span id="hud-energy">80</span>%</span></div>
    </div>

    <div id="message-log"></div>

    <div id="peephole-ui">
        <div id="visitor-visual"></div>
        <div id="dialogue-box"><span id="dialogue-text">...</span></div>
        <div id="door-controls">
            <button class="door-btn btn-interrogate" onclick="window.gameActions.interrogate()">QUEM √â?</button>
            <button class="door-btn btn-open" onclick="window.gameActions.openDoor()">ABRIR</button>
            <button class="door-btn btn-shock" onclick="window.gameActions.shockDoor()">ELETROCUTAR</button>
            <button class="door-btn" onclick="window.gameActions.exitPeephole()">VOLTAR</button>
        </div>
    </div>
</div>

<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

    const apiKey = ""; 
    const CANVAS_W = 512;
    const CANVAS_H = 512;
    const CRT_COLOR = '#ffcc00';
    let osButtons = [];
    let audioCtx, masterGain;
    let camera, scene, renderer, monitorTexture, monitorContext, pointLightPC, pointLightEmergency;
    let raycaster = new THREE.Raycaster();
    let clock = new THREE.Clock();

    // --- CONSTANTES DE CONFIGURA√á√ÉO ---
    const ROOM_OFFSET = 20;
    const ROOMS = [{ id: 'BUNKER', name: 'BUNKER (QG)', x: 0 }, { id: 'BATHROOM', name: 'BANHEIRO', x: ROOM_OFFSET }, { id: 'LIVING', name: 'SALA DE ESTAR', x: ROOM_OFFSET * 2 }];
    const LOCATIONS = { BUNKER: { color: 0xffcc00, fog: 0x050505, fogDens: 0.15 }, BATHROOM: { color: 0xeeeeee, fog: 0xaaaaaa, fogDens: 0.1 }, LIVING: { color: 0x553322, fog: 0x221100, fogDens: 0.15 }, MARKET: { color: 0x00FFFF, fog: 0x001133, fogDens: 0.3 }, PHARMACY: { color: 0xFFFFFF, fog: 0xEEEEEE, fogDens: 0.4 }, STREETS: { color: 0xFF6600, fog: 0x331100, fogDens: 0.6 } };
    const TROPHIES = { FIRST_BLOOD: { id: 'first_blood', icon: "‚ö°", title: "Primeiro Sangue" }, SAVIOR: { id: 'savior', icon: "ü§ù", title: "O Salvador" }, SLAYER: { id: 'slayer', icon: "üíÄ", title: "Exterminador" }, MECHANIC: { id: 'mechanic', icon: "üîß", title: "Engenheiro" }, VETERAN: { id: 'veteran', icon: "üéñÔ∏è", title: "Veterano" }, FAMILY_FIRST: { id: 'family', icon: "‚ù§Ô∏è", title: "Pai de Fam√≠lia" }, LORE_MASTER: { id: 'lore_master', icon: "üìÇ", title: "Arquivista" }, RADIO_OP: { id: 'radio_op', icon: "üì°", title: "Operador de R√°dio" }, DOCTOR: { id: 'doctor', icon: "üíä", title: "M√©dico de Campo" }, TRUTH_SEEKER: { id: 'truth', icon: "üëÅÔ∏è", title: "Verdade Oculta" }, PLATINUM: { id: 'plat', icon: "üèÜ", title: "A JUN√á√ÉO PERFEITA" } };
    const VISITOR_TYPES = [
        { id: 'survivor', type: 'good', name: 'Sobrevivente', visual: `___\n(o o)\n| - |\n-----`, prompt: "Humano.", reward: { energy: 10, sanity: 5 }, desc: "Humano." },
        { id: 'medic', type: 'good', name: 'M√©dico', visual: `___\n(o o)\n| + |\n-----`, prompt: "M√©dico.", reward: { energy: 10, sanity: 30 }, desc: "Traz rem√©dios." },
        { id: 'mechanic', type: 'good', name: 'Mec√¢nico', visual: `___\n[o o]\n| # |\n-----`, prompt: "Mec√¢nico.", reward: { energy: 10, door: 40 }, desc: "Pode reparar a porta." },
        { id: 'mimic', type: 'bad', name: 'M√≠mico', visual: `___\n(o o)\n| O |\n-----`, prompt: "Monstro.", damage: { door: 30, sanity: 30 }, desc: "Finge ser gente." },
        { id: 'brute', type: 'bad', name: 'Brutamontes', visual: `/ \\\n(X X)\n(###)\n\\___/`, prompt: "Monstro.", damage: { door: 60, sanity: 10 }, desc: "Dano massivo." },
        { id: 'cultist', type: 'bad', name: 'Cultista', visual: ` / \\\n(o o)\n |^| \n-----`, prompt: "Fan√°tico.", damage: { door: 10, sanity: 50 }, desc: "Drena sanidade." }
    ];
    const LORE_DATABASE = [
        { id: 1, title: "PROTOCOLO 0", text: "A Jun√ß√£o √© um filtro.", encrypted: false },
        { id: 2, title: "M√çMICOS", text: "Eles n√£o piscam corretamente.", encrypted: false },
        { id: 3, title: "FREQU√äNCIA 98.5", text: "M√∫sica cl√°ssica acalma.", encrypted: false },
        { id: 4, title: "BUNKER 7", text: "Somos controle.", encrypted: false },
        { id: 5, title: "CULTISTAS", text: "Cuidado com a luz.", encrypted: false },
        { id: 6, title: "MAPA DOS T√öNEIS", text: "Sa√≠da nos dutos Setor 4.", encrypted: true, scrambled: "X7A U#A S@!DA..." },
        { id: 7, title: "PROJETO G√äNESE", text: "Voc√™ √© o Administrador 09.", encrypted: true, scrambled: "V0C# N@0 E..." }
    ];
    const NARRATIVE_EVENTS = [
        { title: "NOITE 1: O PROTOCOLO DE HERAN√áA", body: "Arquivo criptografado encontrado.", choices: [{ text: "Contar a verdade", effect: { sanity: 20, family: -20 } }, { text: "Mentir", effect: { sanity: -10, family: 10 } }] },
        { title: "NOITE 2: O R√ÅDIO AMADOR", body: "Sinal de r√°dio detectado.", choices: [{ text: "Responder", effect: { energy: -20, door: -20 } }, { text: "Destruir r√°dio", effect: { family: -30 } }] },
        { title: "NOITE 3: A OFERTA DA CORPORA√á√ÉO", body: "Drone da Pluribus na ventila√ß√£o.", choices: [{ text: "Aceitar troca", effect: { energy: 100, family: -40 } }, { text: "Recusar", effect: { energy: -30, sanity: 10 } }] },
        { title: "NOITE 4: O PASSADO", body: "Mem√≥rias antigas ressurgem.", choices: [{ text: "Aceitar", effect: { sanity: -30 } }, { text: "Reprimir", effect: { energy: -20 } }] },
        { title: "NOITE 5: FALHA NO FILTRO", body: "Ar pesado.", choices: [{ text: "Consertar fora", effect: { familyHealth: -20, door: -10 } }, { text: "Improvisar", effect: { door: -30 } }] },
        { title: "NOITE 6: O VIZINHO", body: "Mutante na porta.", choices: [{ text: "Atirar", effect: { sanity: -20 } }, { text: "Ignorar", effect: { familyMood: -20 } }] },
        { title: "NOITE 7: O ULTIMATO", body: "Limpeza Final.", choices: [{ text: "Sobrecarrregar", effect: { energy: -50, door: 50 } }, { text: "Racionar", effect: { energy: 30, door: -20 } }] }
    ];
    // CORRE√á√ÉO: Estrutura de dados normalizada para 'question', 'options', 'answer'
    const QUIZ_DATA = { 
        MARKET: [{ question: "Lata sem r√≥tulo.", options: ["Comer", "Ignorar", "Guardar"], answer: 1, rewardType: 'energy', rewardAmount: 20, failAmount: -10 }], 
        PHARMACY: [{ question: "Soro experimental.", options: ["Usar", "Estocar", "Destruir"], answer: 1, rewardType: 'sanity', rewardAmount: 30, failAmount: -20 }], 
        STREETS: [{ question: "N√©voa √°cida.", options: ["Correr", "Sinalizador", "Abrigo"], answer: 2, rewardType: 'sanity', rewardAmount: 20, failAmount: -40 }] 
    };

    const STATE = {
        playing: false, day: 1, maxDays: 8, dayTime: 300,
        sanity: 80, energy: 80, doorHealth: 100, familyMood: 100, familyHealth: 100, 
        dailySurvivorsLetIn: 0, survivorsQuota: 2, nextVisitorTimer: 60, revivalUsed: false, 
        currentRoomIndex: 0, cameraTargetX: 0, activeDevice: 'MONITOR', 
        doorKnocking: false, visitor: null, lookingAtPeephole: false, screenView: 'BOOT', currentLocation: 'BUNKER', gameOver: false, interrogated: false, isNarrativeMode: false,
        unlockedLore: [], decodedLore: [], radio: { target: { freq: 5, amp: 50 }, current: { freq: 2, amp: 20 }, locked: false },
        stats: { humansSaved: 0, monstersKilled: 0, unlockedTrophies: [], radioSignals: 0, familyHeals: 0 },
        quiz: { question: "", options: [], answer: 0, rewardType: '', rewardAmount: 0 },
        minigame: { active: null, isRevival: false, snake: { snake: [{x:10, y:10}], dir: {x:0, y:0}, food: {x:15, y:15}, score: 0, speed: 10, tick: 0 }, memory: { cards: [], flipped: [], matches: 0, locked: false, grid: [4, 3] }, pacman: { player: {x:1, y:1}, ghost: {x:7, y:7, tick: 0, speed: 16}, score: 0, totalDots: 100, map: [], width: 15, height: 15 } },
        interactedObjects: {}
    };

    window.gameActions = { interrogate: () => interrogateVisitor(), openDoor: () => resolveDoor(true), shockDoor: () => resolveDoor(false), exitPeephole: () => exitPeepholeMode() };

    // --- AUDIO ---
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext(); 
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.4; 
        masterGain.connect(audioCtx.destination);
    }

    function playSound(type, pos) {
        if (!audioCtx || STATE.gameOver) return;
        const osc = audioCtx.createOscillator(); 
        const gain = audioCtx.createGain();
        if (pos) {
            const p = audioCtx.createPanner(); p.panningModel = 'HRTF'; p.positionX.value = pos.x; p.positionY.value = pos.y; p.positionZ.value = pos.z;
            osc.connect(gain).connect(p).connect(masterGain);
        } else { osc.connect(gain).connect(masterGain); }
        const now = audioCtx.currentTime;
        if (type === 'click') { osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.1); gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now+0.1); }
        else if (type === 'trophy') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+1); osc.start(now); osc.stop(now+1); }
        else if (type === 'travel') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now+2); gain.gain.value = 0.1; osc.start(now); osc.stop(now+2); }
        else if (type === 'hum') { osc.type = 'sine'; osc.frequency.value = 60; gain.gain.value = 0.05; osc.start(now); }
        else if (type === 'knock') { osc.type = 'triangle'; osc.frequency.setValueAtTime(60, now); osc.frequency.exponentialRampToValueAtTime(10, now+0.2); gain.gain.setValueAtTime(1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3); osc.start(now); osc.stop(now+0.3); }
        else if (type === 'shock') { osc.type = 'sawtooth'; osc.frequency.linearRampToValueAtTime(1000, now+0.5); gain.gain.setValueAtTime(0.5, now); osc.start(now); osc.stop(now+0.5); }
        else if (type === 'jumpscare') { osc.type = 'sawtooth'; osc.frequency.value = 50; gain.gain.value = 1; osc.start(now); osc.stop(now+2); }
    }

    // --- CONFIGURA√á√ÉO 3D ---
    let camPitch = 0, camYaw = 0, targetPitch = 0, targetYaw = 0;
    const LOOK_SPEED = 0.002; const SMOOTH_FACTOR = 0.15; const MAX_YAW = Math.PI / 1.5; const MAX_PITCH = Math.PI / 3; 

    // --- INPUT HANDLERS ---
    function onMouseMove(e) {
        if (!STATE.playing || STATE.gameOver || STATE.lookingAtPeephole || STATE.isNarrativeMode) return;
        if (STATE.screenView.startsWith('GAME_') && STATE.minigame.isRevival) return;
        targetYaw -= e.movementX * LOOK_SPEED; targetPitch -= e.movementY * LOOK_SPEED;
        targetPitch = Math.max(-MAX_PITCH, Math.min(MAX_PITCH, targetPitch));
        targetYaw = Math.max(-MAX_YAW, Math.min(MAX_YAW, targetYaw));
    }

    document.addEventListener('keydown', handleKeyDown);
    function handleKeyDown(e) {
        if (!STATE.playing) return;
        const key = e.key.toLowerCase();
        
        if (!STATE.lookingAtPeephole && !STATE.isNarrativeMode && !STATE.gameOver && !STATE.screenView.startsWith('GAME_') && STATE.screenView !== 'RADIO') {
            if (key === 'e' && STATE.currentRoomIndex < ROOMS.length - 1) { STATE.currentRoomIndex++; STATE.cameraTargetX = ROOMS[STATE.currentRoomIndex].x; STATE.currentLocation = ROOMS[STATE.currentRoomIndex].id; playSound('click'); logNarrative(`Voc√™ foi para: ${ROOMS[STATE.currentRoomIndex].name}`); }
            if (key === 'q' && STATE.currentRoomIndex > 0) { STATE.currentRoomIndex--; STATE.cameraTargetX = ROOMS[STATE.currentRoomIndex].x; STATE.currentLocation = ROOMS[STATE.currentRoomIndex].id; playSound('click'); logNarrative(`Voc√™ foi para: ${ROOMS[STATE.currentRoomIndex].name}`); }
        }
        if (STATE.screenView === 'RADIO') {
            if (key === 'arrowleft') STATE.radio.current.freq = Math.max(1, STATE.radio.current.freq - 0.2);
            if (key === 'arrowright') STATE.radio.current.freq = Math.min(15, STATE.radio.current.freq + 0.2);
            if (key === 'arrowdown') STATE.radio.current.amp = Math.max(10, STATE.radio.current.amp - 2);
            if (key === 'arrowup') STATE.radio.current.amp = Math.min(100, STATE.radio.current.amp + 2);
        }
        if (STATE.screenView === 'GAME_SNAKE') {
             const s = STATE.minigame.snake;
             if (key === 'arrowup' && s.dir.y===0) s.dir={x:0,y:-1}; if(key==='arrowdown' && s.dir.y===0) s.dir={x:0,y:1}; if(key==='arrowleft' && s.dir.x===0) s.dir={x:-1,y:0}; if(key==='arrowright' && s.dir.x===0) s.dir={x:1,y:0};
        }
    }

    function handleWorldClick(obj) {
        if (STATE.interactedObjects[obj.name]) return;
        if (obj.name === "BED" && STATE.energy < 50) { STATE.energy = Math.min(100, STATE.energy + 30); STATE.dayTime -= 60; logNarrative("Cochilo."); playSound('hum'); }
        else if (obj.name === "SINK") { STATE.sanity += 5; logNarrative("√Ågua fria."); playSound('click'); }
        else if (obj.name === "DOOR") enterPeepholeMode();
        else if (['MONITOR', 'PHONE', 'TV', 'NOTEBOOK'].includes(obj.name)) {
            STATE.activeDevice = obj.name;
            if (obj.name === 'MONITOR') STATE.screenView = 'DESKTOP';
            if (obj.name === 'PHONE') STATE.screenView = 'PHONE_HOME';
            if (obj.name === 'TV') STATE.screenView = 'TV_HOME';
            if (obj.name === 'NOTEBOOK') STATE.screenView = 'NOTEBOOK_HOME';
            logNarrative(`Usando: ${obj.name}`);
        }
        STATE.interactedObjects[obj.name] = true; setTimeout(() => STATE.interactedObjects[obj.name] = false, 2000);
    }

    function handleMonitorClick(uv) {
        const x = uv.x * CANVAS_W, y = (1 - uv.y) * CANVAS_H; 
        for (let btn of osButtons) {
             if (x >= btn.x && x <= btn.x + btn.w && y >= btn.y && y <= btn.y + btn.h) {
                 playSound('click');
                 if (btn.action === 'BACK') {
                    if (STATE.activeDevice === 'MONITOR') STATE.screenView = 'DESKTOP';
                    else if (STATE.activeDevice === 'PHONE') STATE.screenView = 'PHONE_HOME';
                    else if (STATE.activeDevice === 'TV') STATE.screenView = 'TV_HOME';
                    else if (STATE.activeDevice === 'NOTEBOOK') STATE.screenView = 'NOTEBOOK_HOME';
                 }
                 else if (btn.action === 'BACK_GAME') {
                     if (STATE.activeDevice === 'PHONE') STATE.screenView = 'PHONE_HOME';
                     else if (STATE.activeDevice === 'TV') STATE.screenView = 'TV_HOME';
                     else STATE.screenView = 'DESKTOP';
                 }
                 else if (btn.action === 'GO_MAP') STATE.screenView = 'MAP';
                 else if (btn.action === 'GO_FAMILY') STATE.screenView = 'FAMILY';
                 else if (btn.action === 'GO_REPAIR') STATE.screenView = 'REPAIR';
                 else if (btn.action === 'GO_TROPHIES') STATE.screenView = 'TROPHIES';
                 else if (btn.action === 'GO_GAMES') STATE.screenView = 'GAMES_MENU';
                 else if (btn.action === 'GO_RADIO') initRadio();
                 else if (btn.action === 'GO_ARCHIVES') STATE.screenView = 'ARCHIVES';
                 else if (btn.action === 'GO_DECODER') STATE.screenView = 'DECODER';
                 else if (btn.action === 'START_SNAKE') { STATE.minigame.snake = { snake: [{x:10, y:10}], dir: {x:0, y:0}, food: {x:15, y:15}, score: 0, speed: 10, tick: 0 }; STATE.screenView = 'GAME_SNAKE'; }
                 else if (btn.action === 'START_PACMAN') { STATE.screenView = 'GAME_PACMAN'; }
                 else if(btn.action === 'REP_DOOR' && STATE.energy >= 30) { STATE.energy -= 30; STATE.doorHealth += 40; }
                 else if(btn.action === 'GO_MARKET') startExpedition('MARKET');
                 else if(btn.action === 'GO_PHARMA') startExpedition('PHARMACY');
                 else if(btn.action === 'GO_STREET') startExpedition('STREETS');
                 else if(btn.action === 'RADIO_LURE' && STATE.energy >= 40) { STATE.energy -= 40; triggerKnockEvent('good'); }
                 else if (btn.action.startsWith('ANS_')) handleQuizAnswer(parseInt(btn.action.split('_')[1]));
                 else if (btn.action.startsWith('MEM_')) handleMemoryClick(parseInt(btn.action.split('_')[1]));
                 else if (btn.action.startsWith('DECRYPT_')) handleDecrypt(parseInt(btn.action.split('_')[1]));
             }
        }
    }

    // --- UTILS & HELPERS ---
    function updateBar(id, val, rowId) { const el = document.getElementById(id); if(el) el.style.width = `${Math.max(0, Math.min(100, val))}%`; const row = document.getElementById(rowId); if(row) row.classList.toggle('danger', val <= 30); }
    function unlockTrophy(key) { 
        if (!TROPHIES[key]) return; 
        const id = TROPHIES[key].id; 
        if (!STATE.stats.unlockedTrophies.includes(id)) { 
            STATE.stats.unlockedTrophies.push(id); 
            const p = document.getElementById('trophy-popup'); 
            document.getElementById('trophy-icon').innerText = TROPHIES[key].icon;
            document.getElementById('trophy-name').innerText = TROPHIES[key].title;
            p.style.top = '20px'; 
            setTimeout(() => p.style.top = '-100px', 4000); 
            playSound('trophy'); 
        } 
    }
    function updateHUD() {
        if (!STATE.playing) return;
        document.getElementById('hud-day').innerText = `${STATE.day}/${STATE.maxDays}`;
        document.getElementById('hud-quota').innerText = `${STATE.dailySurvivorsLetIn}/${STATE.survivorsQuota}`;
        document.getElementById('hud-energy').innerText = Math.floor(STATE.energy);
        updateBar('bar-sanity', STATE.sanity, 'row-sanity'); 
        updateBar('bar-door', STATE.doorHealth, 'row-door'); 
        updateBar('bar-family', STATE.familyMood, 'row-family');
        document.getElementById('room-indicator').innerText = ROOMS[STATE.currentRoomIndex].name;
        
        if (STATE.day >= 8) unlockTrophy('VETERAN');
        if (STATE.familyMood >= 100) unlockTrophy('FAMILY_FIRST');
        if (STATE.unlockedLore.length >= 3) unlockTrophy('LORE_MASTER');
        if (STATE.stats.radioSignals >= 3) unlockTrophy('RADIO_OP');
        if (STATE.stats.familyHeals >= 3) unlockTrophy('DOCTOR');
    }
    function logNarrative(msg) { const el = document.getElementById('message-log'); el.innerText = `> ${msg}`; el.style.opacity = 1; if(el.fadeTimeout) clearTimeout(el.fadeTimeout); el.fadeTimeout = setTimeout(() => el.style.opacity = 0, 4000); }
    function typeWriterEffect(text, el) { el.innerText = ""; let i = 0; function type() { if (i < text.length) { el.innerText += text.charAt(i); i++; setTimeout(type, 15); } } type(); }
    function updateCameraSmooth() {
        if (!STATE.playing || STATE.gameOver) return;
        if (STATE.lookingAtPeephole) {
            const targetX = ROOMS[STATE.currentRoomIndex].x + 2.5;
            camera.position.lerp(new THREE.Vector3(targetX, 1.6, 0), 0.1);
            camera.lookAt(targetX + 1.5, 1.6, 0);
            return;
        }
        camera.position.x += (STATE.cameraTargetX - camera.position.x) * 0.1;
        if (STATE.minigame.isRevival) {
            camera.lookAt(camera.position.x, 1.2, 0.31);
            return;
        }
        camPitch += (targetPitch - camPitch) * SMOOTH_FACTOR;
        camYaw += (targetYaw - camYaw) * SMOOTH_FACTOR;
        camera.rotation.set(camPitch, camYaw, 0, 'YXZ');
    }
    function updateTimer(dt) {
        if (STATE.gameOver || STATE.isNarrativeMode || STATE.screenView === 'LOCATION_QUIZ' || STATE.screenView.startsWith('GAME_')) return;
        const TIME_SCALE = 2.5; 
        const gameDt = dt * TIME_SCALE;
        STATE.dayTime -= gameDt;
        if (!STATE.doorKnocking && !STATE.isNarrativeMode) {
            STATE.nextVisitorTimer -= gameDt;
            if (STATE.nextVisitorTimer <= 0) { triggerKnockEvent(); STATE.nextVisitorTimer = 60; }
        }
        if (STATE.doorKnocking) { STATE.doorHealth -= 2.0 * dt; if (STATE.doorHealth <= 0) checkState(); }
        if (STATE.dayTime <= 0) { STATE.dayTime = 0; startNextDay(); }
        const min = Math.floor(STATE.dayTime / 60);
        const sec = Math.floor(STATE.dayTime % 60);
        document.getElementById('timer-display').innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        if(STATE.doorKnocking) updateHUD();
    }
    function checkState() {
        if (STATE.day > STATE.maxDays) { document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:black;color:#ffcc00;font-family:monospace;"><h1>DIA 8: RESGATE CHEGOU</h1><p>Voc√™ sobreviveu.</p><button onclick="location.reload()">REINICIAR</button></div>`; STATE.playing = false; }
        else if (STATE.energy <= 0) triggerGameOver("Sem Energia.");
        else if (STATE.sanity <= 0) triggerGameOver("Loucura Total.");
        else if (STATE.doorHealth <= 0) triggerGameOver("Porta Destru√≠da.");
        else if (STATE.familyMood <= 0) triggerGameOver("Motim Familiar.");
        else if (STATE.familyHealth <= 0) triggerGameOver("Fam√≠lia Pereceu."); 
    }
    function triggerGameOver(r) {
        if (!STATE.revivalUsed) {
            STATE.revivalUsed = true; STATE.revivalReason = r;
            playSound('jumpscare'); STATE.lookingAtPeephole = false; document.exitPointerLock();
            initPacman(true);
            logNarrative("ERRO CR√çTICO! INICIANDO PROTOCOLO DE EMERG√äNCIA...");
            return;
        }
        STATE.gameOver = true; 
        playSound('jumpscare'); 
        document.getElementById('vhs-overlay').style.background = 'red';
        setTimeout(() => document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:black;color:red;font-family:monospace;text-align:center;"><h1>FIM DE JOGO</h1><p>${r}</p><button onclick="location.reload()">REINICIAR</button></div>`, 2000);
    }
    function revivePlayer() {
        STATE.sanity = Math.max(50, STATE.sanity); STATE.energy = Math.max(50, STATE.energy);
        STATE.doorHealth = Math.max(50, STATE.doorHealth); STATE.familyMood = Math.max(50, STATE.familyMood);
        STATE.familyHealth = Math.max(50, STATE.familyHealth);
        STATE.doorKnocking = false; STATE.minigame.isRevival = false; STATE.screenView = 'DESKTOP';
        playSound('trophy'); logNarrative("SISTEMA RESTAURADO."); document.body.requestPointerLock();
    }
    function triggerKnockEvent(forcedType = null) {
        if (STATE.doorKnocking || STATE.currentLocation !== 'BUNKER' || STATE.isNarrativeMode) return;
        STATE.doorKnocking = true;
        STATE.visitor = VISITOR_TYPES[Math.floor(Math.random() * VISITOR_TYPES.length)];
        STATE.interrogated = false; 
        playSound('knock', {x: 3, y: 1, z: 0});
        updateHUD();
        logNarrative(`ALERTA DE PROXIMIDADE: Porta do ${ROOMS[STATE.currentRoomIndex].name}`);
    }
    function resolveDoor(open) {
        STATE.doorKnocking = false; exitPeepholeMode();
        if (open) {
            if (STATE.visitor.type === 'good') {
                if (STATE.visitor.reward.energy) STATE.energy += STATE.visitor.reward.energy;
                if (STATE.visitor.reward.sanity) STATE.sanity += STATE.visitor.reward.sanity;
                if (STATE.visitor.reward.door) STATE.doorHealth += STATE.visitor.reward.door;
                STATE.dailySurvivorsLetIn++;
                STATE.stats.humansSaved++; if (STATE.stats.humansSaved >= 3) unlockTrophy('SAVIOR');
                playSound('click'); logNarrative("Acesso permitido.");
            } else {
                STATE.doorHealth -= STATE.visitor.damage.door; STATE.sanity -= STATE.visitor.damage.sanity;
                playSound('shock'); logNarrative("ERRO! Intruso invadiu!");
            }
        } else {
            playSound('shock', {x: 3, y: 1, z: 0}); unlockTrophy('FIRST_BLOOD');
            if (STATE.visitor.type === 'good') { STATE.sanity -= 20; logNarrative("Inocente eletrocutado."); }
            else { STATE.sanity += 10; STATE.stats.monstersKilled++; if (STATE.stats.monstersKilled >= 3) unlockTrophy('SLAYER'); logNarrative("Amea√ßa eliminada."); }
        }
        STATE.energy = Math.min(100, STATE.energy); STATE.sanity = Math.min(100, STATE.sanity);
        STATE.doorHealth = Math.min(100, STATE.doorHealth);
        checkState();
    }
    function enterPeepholeMode() {
        if (!STATE.doorKnocking) { logNarrative("Ningu√©m na porta."); return; }
        STATE.lookingAtPeephole = true; document.exitPointerLock();
        document.getElementById('peephole-ui').style.display = 'block'; document.getElementById('dialogue-box').style.display = 'none';
        document.getElementById('visitor-visual').innerText = STATE.visitor.visual;
        const targetX = ROOMS[STATE.currentRoomIndex].x + 2.5;
        camera.position.set(targetX, 1.6, 0); camera.lookAt(targetX + 2, 1.6, 0);
    }
    function exitPeepholeMode() {
        STATE.lookingAtPeephole = false; document.getElementById('peephole-ui').style.display = 'none';
        document.body.requestPointerLock(); 
        camPitch = 0; camYaw = 0; targetPitch = 0; targetYaw = 0;
        const targetX = ROOMS[STATE.currentRoomIndex].x;
        camera.position.set(targetX, 1.2, 2); camera.lookAt(targetX, 1.2, 0);
    }
    function interrogateVisitor() { if (STATE.interrogated) return; STATE.interrogated = true; generateVisitorDialogue(STATE.visitor); }
    async function generateVisitorDialogue(visitor) {
        const txt = document.getElementById('dialogue-text');
        document.getElementById('dialogue-box').style.display = 'block';
        txt.innerText = "Analisando...";
        if (!apiKey || apiKey === "") {
            const lines = ["Por favor, preciso de ajuda.", "Eles est√£o vindo!", "Sou apenas um viajante.", "Tenho suprimentos para trocar."];
            const line = lines[Math.floor(Math.random() * lines.length)];
            setTimeout(() => { typeWriterEffect(`"${line}"\n\n(AN√ÅLISE: ${visitor.prompt})`, txt); }, 500);
            return;
        }
        // AI Logic would go here
        typeWriterEffect("Sinal fraco...", txt);
    }
    function startNextDay() {
        document.getElementById('narrative-overlay').style.display = 'none';
        document.body.requestPointerLock();
        STATE.day++; STATE.dayTime = 300; STATE.dailySurvivorsLetIn = 0; checkState();
        logNarrative(`DIA ${STATE.day} INICIADO.`);
    }
    function startExpedition(loc) { STATE.currentLocation = loc; STATE.screenView = 'LOCATION_QUIZ'; STATE.quiz = QUIZ_DATA[loc][0]; }
    function handleQuizAnswer(i) { 
        STATE.screenView = 'RESULT'; 
        if (i === STATE.quiz.answer) {
            STATE.quiz.resultMsg = "SUCESSO";
            if (STATE.quiz.rewardType === 'energy') STATE.energy += STATE.quiz.rewardAmount;
            if (STATE.quiz.rewardType === 'sanity') STATE.sanity += STATE.quiz.rewardAmount;
        } else {
            STATE.quiz.resultMsg = "FALHA";
            STATE.sanity += STATE.quiz.failAmount;
        }
        setTimeout(() => STATE.screenView = 'DESKTOP', 1000); 
    }
    function handleMemoryClick(i) {}
    function handleDecrypt(i) {}
    function initSnake() { STATE.minigame.snake = { snake: [{x:10, y:10}], dir: {x:0, y:0}, food: {x:15, y:15}, score: 0, speed: 10, tick: 0 }; STATE.screenView = 'GAME_SNAKE'; }
    function initPacman(isRevival = false) { STATE.minigame.isRevival = isRevival; STATE.minigame.pacman={player:{x:1,y:1}, ghost:{x:7,y:7,tick:0,speed:16}, score:0, totalDots:50, map:[], width:15, height:15}; STATE.screenView='GAME_PACMAN'; }
    function checkPacmanWin() { return false; }
    function initMemory() { STATE.screenView = 'GAME_MEMORY'; }
    function initRadio() { STATE.screenView = 'RADIO'; STATE.radio.locked = false; }

    // --- DRAWING ---
    function drawButton(ctx, x, y, w, h, text) {
        ctx.strokeStyle = CRT_COLOR; ctx.lineWidth = 2; ctx.strokeRect(x, y, w, h);
        ctx.fillStyle = CRT_COLOR; ctx.font = '18px monospace'; ctx.fillText(text, x + 10, y + 25);
        return { x, y, w, h };
    }
    function updateAndDrawSnake(ctx) {
        const s = STATE.minigame.snake; ctx.fillText(`SNAKE: ${s.score}`, 20, 30); s.tick++;
        if (s.tick > s.speed) { s.tick = 0; const h={x:s.snake[0].x+s.dir.x, y:s.snake[0].y+s.dir.y}; s.snake.unshift(h); if(h.x===s.food.x && h.y===s.food.y) { s.score++; s.food={x:Math.floor(Math.random()*25),y:Math.floor(Math.random()*25)}; } else { s.snake.pop(); } }
        s.snake.forEach(p => ctx.fillRect(20 + p.x * 18, 50 + p.y * 18, 16, 16));
        ctx.fillStyle='red'; ctx.fillRect(20 + s.food.x * 18, 50 + s.food.y * 18, 16, 16);
        osButtons.push({ action: 'BACK_GAME', ...drawButton(ctx, 380, 450, 100, 40, "SAIR") });
    }
    function updateAndDrawPacman(ctx) { ctx.fillText("PACMAN (SIMULADO)", 20, 30); osButtons.push({ action: 'BACK_GAME', ...drawButton(ctx, 380, 450, 100, 40, "SAIR") }); }
    function drawMemory(ctx) { ctx.fillText("MEMORIA", 20, 30); osButtons.push({ action: 'BACK_GAME', ...drawButton(ctx, 380, 450, 100, 40, "SAIR") }); }
    function drawRadio(ctx) { ctx.fillText("RADIO", 20, 30); osButtons.push({ action: 'BACK', ...drawButton(ctx, 380, 450, 100, 40, "SAIR") }); }
    function drawArchives(ctx) { ctx.fillText("ARQUIVOS", 20, 30); osButtons.push({ action: 'BACK', ...drawButton(ctx, 380, 450, 100, 40, "SAIR") }); }
    function drawDecoder(ctx) { ctx.fillText("DECODER", 20, 30); osButtons.push({ action: 'BACK', ...drawButton(ctx, 380, 450, 100, 40, "SAIR") }); }

    function drawOS() {
        const ctx = monitorContext; if (!ctx) return;
        ctx.fillStyle = '#110d00'; ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
        ctx.shadowBlur = 4; ctx.shadowColor = CRT_COLOR; ctx.fillStyle = CRT_COLOR;
        osButtons = [];

        if (STATE.screenView === 'DESKTOP') {
            ctx.font = '28px monospace'; ctx.fillText(`PLURIBUS OS`, 40, 50);
            if (STATE.doorKnocking) { ctx.fillStyle = 'red'; ctx.fillText("ALERTA", 120, 450); ctx.fillStyle = CRT_COLOR; }
            osButtons.push({ action: 'GO_MAP', ...drawButton(ctx, 40, 100, 430, 50, "EXPEDI√á√ÉO") });
            osButtons.push({ action: 'GO_FAMILY', ...drawButton(ctx, 40, 170, 430, 50, "FAM√çLIA") });
            osButtons.push({ action: 'GO_REPAIR', ...drawButton(ctx, 40, 240, 430, 50, "MANUTEN√á√ÉO") });
            osButtons.push({ action: 'GO_RADIO', ...drawButton(ctx, 40, 310, 430, 50, "R√ÅDIO") });
        }
        else if (STATE.screenView === 'PHONE_HOME') {
            ctx.fillText("SMARTPHONE OS", 40, 50);
            osButtons.push({ action: 'START_SNAKE', ...drawButton(ctx, 40, 100, 430, 50, "JOGO: SNAKE") });
            osButtons.push({ action: 'MAIL', ...drawButton(ctx, 40, 170, 430, 50, "SMS (LORE)") });
        }
        else if (STATE.screenView === 'TV_HOME') {
            ctx.fillText("CANAIS DE TV", 40, 50);
            osButtons.push({ action: 'START_PACMAN', ...drawButton(ctx, 40, 100, 430, 50, "CANAL JOGOS (PACMAN)") });
            osButtons.push({ action: 'NEWS', ...drawButton(ctx, 40, 170, 430, 50, "NOT√çCIAS") });
        }
        else if (STATE.screenView === 'NOTEBOOK_HOME') {
            ctx.fillText("TERMINAL PESSOAL", 40, 50);
            osButtons.push({ action: 'START_MEMORY', ...drawButton(ctx, 40, 100, 430, 50, "TREINO MEM√ìRIA") });
            osButtons.push({ action: 'GO_ARCHIVES', ...drawButton(ctx, 40, 170, 430, 50, "ARQUIVOS") });
            osButtons.push({ action: 'GO_DECODER', ...drawButton(ctx, 40, 240, 430, 50, "DECODER") });
        }
        else if (STATE.screenView === 'GAME_SNAKE') updateAndDrawSnake(ctx);
        else if (STATE.screenView === 'GAME_PACMAN') updateAndDrawPacman(ctx);
        else if (STATE.screenView === 'GAME_MEMORY') drawMemory(ctx);
        else if (STATE.screenView === 'RADIO') drawRadio(ctx);
        else if (STATE.screenView === 'MAP') {
            ctx.fillText("DESTINO DA EXPEDI√á√ÉO:", 40, 50);
            osButtons.push({ action: 'GO_MARKET', ...drawButton(ctx, 40, 100, 430, 50, "MERCADO") });
            osButtons.push({ action: 'GO_PHARMA', ...drawButton(ctx, 40, 170, 430, 50, "FARM√ÅCIA") });
            osButtons.push({ action: 'GO_STREET', ...drawButton(ctx, 40, 240, 430, 50, "RUAS") });
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 400, 100, 40, "CANCELAR") });
        }
        else if (STATE.screenView === 'FAMILY') {
            ctx.fillText("STATUS FAM√çLIA", 40, 50);
            ctx.fillText(`HUMOR: ${Math.floor(STATE.familyMood)}%`, 40, 90);
            osButtons.push({ action: 'FAM_FEED', ...drawButton(ctx, 40, 150, 430, 50, "DAR RA√á√ÉO") });
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 400, 100, 40, "VOLTAR") });
        }
        else if (STATE.screenView === 'REPAIR') {
            ctx.fillText("MANUTEN√á√ÉO", 40, 50);
            ctx.fillText(`PORTA: ${STATE.doorHealth.toFixed(1)}%`, 40, 90);
            osButtons.push({ action: 'REP_DOOR', ...drawButton(ctx, 40, 150, 430, 50, "REPARAR") });
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 400, 100, 40, "VOLTAR") });
        }
        else if (STATE.screenView === 'LOCATION_QUIZ') {
             ctx.fillText("EVENTO:", 40, 50);
             // Using STATE.quiz.question which is guaranteed by startExpedition setting it from QUIZ_DATA
             if (STATE.quiz && STATE.quiz.question) {
                const w = STATE.quiz.question.split(' '); let l = '', y = 80;
                w.forEach(word => { if (ctx.measureText(l + word).width > 450) { ctx.fillText(l, 40, y); l = word + ' '; y += 25; } else l += word + ' '; });
                ctx.fillText(l, 40, y);
                STATE.quiz.options.forEach((opt, i) => osButtons.push({ action: `ANS_${i}`, ...drawButton(ctx, 40, 200 + (i * 70), 430, 50, `${i+1}. ${opt}`) }));
             }
        }
        else if (STATE.screenView === 'RESULT') {
             ctx.fillText(STATE.quiz.resultMsg, 40, 200);
        }
        else if (STATE.screenView === 'BOOT') {
            ctx.fillText("INICIALIZANDO...", 40, 100); if (Math.random() > 0.9) STATE.screenView = 'DESKTOP';
        }

        ctx.fillStyle = "rgba(255, 200, 0, 0.1)"; for (let i = 0; i < CANVAS_H; i += 4) ctx.fillRect(0, i, CANVAS_W, 2);
        monitorTexture.needsUpdate = true;
    }

    // --- 3D & INIT ---
    function initMonitorOS() {
        const c = document.createElement('canvas'); c.width = CANVAS_W; c.height = CANVAS_H;
        monitorContext = c.getContext('2d');
        monitorTexture = new THREE.CanvasTexture(c);
        monitorTexture.minFilter = THREE.LinearFilter; monitorTexture.magFilter = THREE.NearestFilter;
    }

    function createNoiseMaterial(c) {
        const cv = document.createElement('canvas'); cv.width=64; cv.height=64;
        const x = cv.getContext('2d'); x.fillStyle = '#'+c.toString(16); x.fillRect(0,0,64,64);
        for(let i=0;i<500;i++){ x.fillStyle=`rgba(0,0,0,${Math.random()*0.2})`; x.fillRect(Math.random()*64,Math.random()*64,2,2); }
        return new THREE.MeshStandardMaterial({map:new THREE.CanvasTexture(cv), roughness:0.9});
    }

    function createRoom(offsetX, wallColor, deviceName, isBathroom, hasNotebook=false, isLiving=false) {
        const roomGroup = new THREE.Group();
        roomGroup.position.set(offsetX, 0, 0);
        const mat = createNoiseMaterial(wallColor);
        const roomGeo = new THREE.BoxGeometry(6,4,6);
        const roomMesh = new THREE.Mesh(roomGeo, mat); roomMesh.material.side = THREE.BackSide; roomGroup.add(roomMesh);

        if (isBathroom) {
            const sink = new THREE.Mesh(new THREE.BoxGeometry(1, 0.1, 0.6), new THREE.MeshStandardMaterial({color:0xaaaaaa})); sink.position.set(0, 0.9, -2); sink.name = "SINK"; roomGroup.add(sink);
            const mirror = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 1.0), new THREE.MeshStandardMaterial({color:0x88ccff, roughness: 0.1})); mirror.position.set(0, 1.6, -2.95); roomGroup.add(mirror);
            const cab = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.2), new THREE.MeshStandardMaterial({color:0xffffff})); cab.position.set(1.5, 1.5, -2.8); cab.name = "CABINET"; roomGroup.add(cab);
        } else if (isLiving) {
            const couchBase = new THREE.Mesh(new THREE.BoxGeometry(2, 0.5, 1), new THREE.MeshStandardMaterial({color:0x883322})); couchBase.position.set(0, 0.25, 1.5); couchBase.name = "COUCH"; roomGroup.add(couchBase);
            const couchBack = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 0.2), new THREE.MeshStandardMaterial({color:0x883322})); couchBack.position.set(0, 0.5, 2); roomGroup.add(couchBack);
            const rug = new THREE.Mesh(new THREE.BoxGeometry(3, 0.01, 2), new THREE.MeshStandardMaterial({color:0x4444cc})); rug.position.set(0, 0.01, 0); roomGroup.add(rug);
            const stand = new THREE.Mesh(new THREE.BoxGeometry(2, 0.5, 0.6), new THREE.MeshStandardMaterial({color:0x222222})); stand.position.set(0, 0.25, -2.5); roomGroup.add(stand);
        } else {
            const bed = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.4, 2.5), new THREE.MeshStandardMaterial({color:0x334433})); bed.position.set(-1.8, 0.2, -1); bed.name = "BED"; roomGroup.add(bed);
            const d = new THREE.Mesh(new THREE.BoxGeometry(2.5,0.1,1.5), createNoiseMaterial(0x333333)); d.position.set(0,0.8,0); roomGroup.add(d);
        }

        if (deviceName === "PHONE") {
            const phone = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.35, 0.02), new THREE.MeshBasicMaterial({map:monitorTexture}));
            phone.position.set(0, 1.1, 1.5); phone.rotation.x = -0.5; phone.name = "PHONE"; roomGroup.add(phone);
        } else if (deviceName === "TV") {
            const tv = new THREE.Mesh(new THREE.PlaneGeometry(1.8, 1.0), new THREE.MeshBasicMaterial({map:monitorTexture}));
            tv.position.set(0, 1.0, -2.15); tv.name = "TV"; roomGroup.add(tv);
        } else {
            const mon = new THREE.Mesh(new THREE.PlaneGeometry(0.6,0.6), new THREE.MeshBasicMaterial({map:monitorTexture, side:THREE.DoubleSide})); mon.position.set(0,1.2,0.31); mon.name = "MONITOR"; roomGroup.add(mon);
        }
        if (hasNotebook) {
            const noteGroup = new THREE.Group(); noteGroup.position.set(0.8, 0.55, -2.5); 
            const noteBase = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.02, 0.4), new THREE.MeshStandardMaterial({color:0x222222}));
            const noteScreen = new THREE.Mesh(new THREE.PlaneGeometry(0.55, 0.35), new THREE.MeshBasicMaterial({map:monitorTexture}));
            noteScreen.position.set(0, 0.2, -0.18); noteScreen.rotation.x = -0.2; noteScreen.name = "NOTEBOOK";
            noteGroup.add(noteBase); noteGroup.add(noteScreen); roomGroup.add(noteGroup);
        }

        const dr = new THREE.Mesh(new THREE.BoxGeometry(0.1,2.2,1.2), new THREE.MeshStandardMaterial({color:0x2a2a2a})); dr.position.set(2.95,1.1,0); dr.name="DOOR"; roomGroup.add(dr);
        const pp = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.15,16), new THREE.MeshBasicMaterial({color:0x000})); pp.rotation.z=Math.PI/2; pp.position.set(2.90,1.6,0); pp.name="PEEPHOLE"; roomGroup.add(pp);
        scene.add(roomGroup);
    }

    function updateEnvironment3D() {
        const t = LOCATIONS[STATE.currentLocation] || LOCATIONS.BUNKER; 
        if (!t) return; 
        pointLightPC.color.lerp(new THREE.Color(t.color), 0.05);
        scene.fog.color.lerp(new THREE.Color(t.fog), 0.05);
        scene.fog.density = THREE.MathUtils.lerp(scene.fog.density, t.fogDens, 0.02);
    }

    function init3D() {
        const c = document.getElementById('game-container');
        scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050505, 0.15);
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100); camera.position.set(0, 1.2, 2);
        renderer = new THREE.WebGLRenderer({ antialias: false }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true; c.appendChild(renderer.domElement);
        initMonitorOS(); 
        
        createRoom(0, 0x444444, "MONITOR", false, false, false);
        createRoom(ROOM_OFFSET, 0xdddddd, "PHONE", true, false, false); 
        createRoom(ROOM_OFFSET * 2, 0x664422, "TV", false, true, true); 

        scene.add(new THREE.AmbientLight(0x111111));
        pointLightPC = new THREE.PointLight(0xffcc00, 1, 4); pointLightPC.position.set(0,1.2,0.5); scene.add(pointLightPC);
        pointLightEmergency = new THREE.PointLight(0xff0000, 0, 15); pointLightEmergency.position.set(2.5,2.8,0); scene.add(pointLightEmergency);
        
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        
        document.addEventListener('mousemove', onMouseMove);

        document.addEventListener('click', (e) => {
            if(!STATE.playing) return;
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const h = raycaster.intersectObjects(scene.children, true);
            if(h.length){ 
                const obj = h[0].object;
                if (['MONITOR', 'PHONE', 'TV', 'NOTEBOOK'].includes(obj.name)) handleMonitorClick(h[0].uv);
                else handleWorldClick(obj);
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate); 
        if(!scene || !camera || !STATE.playing) return;
        const dt = clock.getDelta();
        updateTimer(dt);
        updateCameraSmooth();
        pointLightPC.position.x = camera.position.x;
        pointLightEmergency.position.x = ROOMS[STATE.currentRoomIndex].x + 2.5; 
        updateEnvironment3D(); 
        updateHUD(); 
        drawOS();
        renderer.render(scene, camera);
    }

    document.getElementById('overlay').addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'none';
        document.body.requestPointerLock();
        initAudio(); 
        init3D(); 
        playSound('hum');
        STATE.playing = true; 
        clock.start(); 
        animate();
        logNarrative("Iniciando sistemas... Bunker operacional.");
    });
</script>
</body>
</html>