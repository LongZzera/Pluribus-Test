<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLURIBUS: A JUN√á√ÉO | The Bunker Experience</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', monospace; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        
        /* --- UI GERAL (AGORA AMARELO) --- */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #ffcc00; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
            cursor: pointer; text-align: center;
        }
        #overlay h1 { text-shadow: 0 0 10px #ffcc00; margin-bottom: 10px; }
        #overlay p { opacity: 0.8; max-width: 600px; line-height: 1.5; }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: rgba(255, 255, 255, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 50;
            mix-blend-mode: difference;
        }

        /* --- NOTIFICA√á√ÉO DE TROF√âU --- */
        #trophy-popup {
            position: absolute; top: -100px; left: 50px; 
            width: 300px; height: 60px;
            background: rgba(20, 20, 20, 0.95);
            border-radius: 40px;
            border-left: 5px solid #ffcc00;
            display: flex; align-items: center; padding: 10px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000; pointer-events: none;
        }
        #trophy-icon {
            width: 40px; height: 40px; border-radius: 50%;
            background: #ffcc00; color: #000;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 20px; margin-right: 15px;
        }
        #trophy-text h4 { margin: 0; color: #fff; font-size: 14px; font-family: sans-serif; }
        #trophy-text p { margin: 0; color: #aaa; font-size: 12px; font-family: sans-serif; }

        /* --- HUD DE STATUS --- */
        #hud-overlay {
            position: absolute; top: 20px; right: 20px; width: 250px;
            padding: 15px; background: rgba(20, 20, 0, 0.1);
            border: 2px solid #ffcc00; color: #ffcc00;
            font-family: 'Courier New', monospace; font-size: 14px;
            z-index: 95; pointer-events: none;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
        }
        .hud-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .hud-label { font-weight: bold; }
        .hud-bar-container { width: 100px; height: 10px; background: #111; border: 1px solid #554400; margin-top: 4px; }
        .hud-bar-fill { height: 100%; background: #ffcc00; transition: width 0.3s; }
        .danger { color: #ff3333; }
        .danger .hud-bar-fill { background: #ff3333; }

        /* --- EFEITOS VHS/CRT (TINTADO DE AMARELO) --- */
        #vhs-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 90;
            background: linear-gradient(rgba(18, 16, 0, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 200, 0, 0.06), rgba(255, 200, 0, 0.02), rgba(255, 200, 0, 0.06));
            background-size: 100% 2px, 3px 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
        }
        #scanline {
            width: 100%; height: 10px; background: rgba(255,200,0,0.05); opacity: 0.1;
            position: absolute; z-index: 91; pointer-events: none;
            animation: scanline 6s linear infinite;
        }
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }
        
        /* --- LOGS DE MENSAGENS --- */
        #message-log {
            position: absolute; bottom: 20px; left: 20px; color: #ffcc00;
            font-size: 14px; opacity: 0.8; pointer-events: none; z-index: 80;
            text-shadow: 1px 1px 2px black;
        }

        /* --- UI DA PORTA / OLHO M√ÅGICO --- */
        #peephole-ui {
            display: none; 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200;
            background: radial-gradient(circle, transparent 10%, black 70%); 
            pointer-events: auto;
        }

        #visitor-visual {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: monospace; font-size: 14px; color: #ffcc00; white-space: pre;
            text-align: center; opacity: 0.8; filter: blur(1px);
            pointer-events: none;
        }

        #dialogue-box {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            width: 600px; background: rgba(20, 15, 0, 0.9); border: 2px solid #ffcc00;
            padding: 15px; color: #ffcc00; font-family: 'Courier New'; display: none;
            text-align: center;
        }
        
        .typing-effect::after { content: '‚ñå'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #door-controls {
            position: absolute; bottom: 50px; width: 100%; display: flex; 
            justify-content: center; gap: 20px; pointer-events: auto;
        }

        .door-btn {
            background: #111; border: 2px solid #555; color: #aaa; padding: 15px 30px;
            font-family: 'Courier New'; font-weight: bold; cursor: pointer;
            transition: 0.2s; text-transform: uppercase; letter-spacing: 2px;
        }
        .door-btn:hover { color: #fff; border-color: #fff; }
        .btn-interrogate { border-color: #ffcc00; color: #ffcc00; }
        .btn-interrogate:hover { background: #332200; }
        .btn-open { border-color: #aaaa00; color: #ffff00; }
        .btn-open:hover { background: #333300; }
        .btn-shock { border-color: #ff3333; color: #ff3333; }
        .btn-shock:hover { background: #330000; }

    </style>
</head>
<body>

<div id="overlay">
    <h1>PLURIBUS: A JUN√á√ÉO</h1>
    <p>MODO HIST√ìRIA: SOBREVIV√äNCIA DE 8 DIAS + TROF√âUS</p>
    <br>
    <p style="font-size: 12px; color: #aa8800;">[CLIQUE PARA INICIAR]</p>
    <br>
    <p>
        <b>OBJETIVO:</b> Sobreviva at√© o Dia 8. Cuide da Fam√≠lia.<br>
        <b>NOVOS PERIGOS:</b> M√≠micos, Cultistas, Brutos.<br>
        <b>PLATINAS:</b> Desbloqueie conquistas no sistema.
    </p>
</div>

<div id="game-container">
    <div id="vhs-overlay"></div>
    <div id="scanline"></div>
    <div id="crosshair"></div>
    
    <!-- NOTIFICA√á√ÉO DE TROF√âU -->
    <div id="trophy-popup">
        <div id="trophy-icon">üèÜ</div>
        <div id="trophy-text">
            <h4>Conquista Desbloqueada</h4>
            <p id="trophy-name">Nome do Trof√©u</p>
        </div>
    </div>

    <!-- HUD DE STATUS -->
    <div id="hud-overlay">
        <div class="hud-row">
            <span class="hud-label">DIA:</span>
            <span id="hud-day">1/8</span>
        </div>
        <div class="hud-row" id="row-sanity">
            <span class="hud-label">SANIDADE:</span>
            <div class="hud-bar-container"><div id="bar-sanity" class="hud-bar-fill" style="width: 80%"></div></div>
        </div>
        <div class="hud-row" id="row-door">
            <span class="hud-label">PORTA:</span>
            <div class="hud-bar-container"><div id="bar-door" class="hud-bar-fill" style="width: 100%"></div></div>
        </div>
        <div class="hud-row" id="row-family">
            <span class="hud-label">FAM√çLIA:</span>
            <div class="hud-bar-container"><div id="bar-family" class="hud-bar-fill" style="width: 100%"></div></div>
        </div>
        <div class="hud-row">
             <span class="hud-label" style="font-size:10px; color:#aa8800; margin-top:5px;">RECURSOS (ENERGIA): <span id="hud-energy">80</span>%</span>
        </div>
    </div>

    <div id="message-log"></div>

    <!-- UI DO OLHO M√ÅGICO -->
    <div id="peephole-ui">
        <div id="visitor-visual"></div>
        <div id="dialogue-box"><span id="dialogue-text">...</span></div>
        <div id="door-controls">
            <button class="door-btn btn-interrogate" onclick="window.gameActions.interrogate()">QUEM √â?</button>
            <button class="door-btn btn-open" onclick="window.gameActions.openDoor()">ABRIR</button>
            <button class="door-btn btn-shock" onclick="window.gameActions.shockDoor()">ELETROCUTAR</button>
            <button class="door-btn" onclick="window.gameActions.exitPeephole()">VOLTAR</button>
        </div>
    </div>
</div>

<!-- Import Three.js -->
<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

    // --- CONFIGURA√á√ÉO GLOBAL ---
    const apiKey = ""; 
    
    // Lista de Trof√©us
    const TROPHIES = {
        FIRST_BLOOD: { id: 'first_blood', title: "Primeiro Sangue", desc: "Eletrocutou um visitante.", icon: "‚ö°" },
        SAVIOR: { id: 'savior', title: "O Salvador", desc: "Salvou 3 humanos.", icon: "ü§ù" },
        SLAYER: { id: 'slayer', title: "Exterminador", desc: "Matou 3 monstros.", icon: "üíÄ" },
        SURVIVOR: { id: 'survivor', title: "Meio Caminho", desc: "Chegou ao Dia 4.", icon: "üìÖ" },
        MECHANIC: { id: 'mechanic', title: "Engenheiro", desc: "Reparou a porta ao m√°ximo.", icon: "üîß" },
        FAMILY_FIRST: { id: 'family', title: "Pai de Fam√≠lia", desc: "Manteve o humor da fam√≠lia em 100%.", icon: "‚ù§Ô∏è" },
        PLATINUM: { id: 'plat', title: "A JUN√á√ÉO PERFEITA", desc: "Coletou todos os trof√©us.", icon: "üèÜ" }
    };

    // Defini√ß√£o de Visitantes
    const VISITOR_TYPES = [
        // BONS
        { 
            id: 'survivor', type: 'good', name: 'Sobrevivente', 
            visual: `___\n(o o)\n| - |\n-----`, 
            prompt: "Humano desesperado. Fale 10 palavras pedindo abrigo.",
            reward: { energy: 10, sanity: 5 },
            desc: "Apenas algu√©m tentando viver."
        },
        { 
            id: 'medic', type: 'good', name: 'M√©dico de Campo', 
            visual: `___\n(o o)\n| + |\n-----`, 
            prompt: "M√©dico militar calmo. Ofere√ßa ajuda m√©dica em troca de abrigo.",
            reward: { energy: 10, sanity: 30 }, // Cura muita sanidade
            desc: "Traz rem√©dios."
        },
        { 
            id: 'mechanic', type: 'good', name: 'Mec√¢nico', 
            visual: `___\n[o o]\n| # |\n-----`, 
            prompt: "Mec√¢nico pr√°tico. Diga que pode consertar a porta se entrar.",
            reward: { energy: 10, door: 40 }, // Repara a porta
            desc: "Pode reparar a porta."
        },
        { 
            id: 'trader', type: 'good', name: 'Mercador', 
            visual: `___\n($ $)\n| - |\n-----`, 
            prompt: "Vendedor ambulante. Ofere√ßa baterias em troca de pouso.",
            reward: { energy: 50, sanity: 0 }, // Muita energia
            desc: "Carrega baterias pesadas."
        },

        // MAUS
        { 
            id: 'mimic', type: 'bad', name: 'M√≠mico', 
            visual: `___\n(o o)\n| O |\n-----`, // Visualmente igual ao humano normal
            prompt: "Monstro M√≠mico. Tente falar como humano, mas gagueje ou repita palavras de forma estranha.",
            damage: { door: 30, sanity: 30 },
            desc: "Finge ser gente. Falha na fala."
        },
        { 
            id: 'brute', type: 'bad', name: 'Brutamontes', 
            visual: `/ \\\n(X X)\n(###)\n\\___/`, 
            prompt: "Monstro violento e burro. Grite e ameace derrubar a porta.",
            damage: { door: 60, sanity: 10 }, // Destr√≥i a porta r√°pido
            desc: "Dano massivo na porta."
        },
        { 
            id: 'cultist', type: 'bad', name: 'Cultista', 
            visual: ` / \\\n(o o)\n |^| \n-----`, 
            prompt: "Fan√°tico religioso. Fale sobre 'A Jun√ß√£o' e a gl√≥ria da morte.",
            damage: { door: 10, sanity: 50 }, // Dano mental alto
            desc: "Drena sua sanidade."
        },
        { 
            id: 'weeper', type: 'bad', name: 'A Chorona', 
            visual: `___\n(T T)\n| o |\n-----`, 
            prompt: "Mulher chorando incontrolavelmente. Solu√ßos entre palavras.",
            damage: { door: 20, sanity: 40 },
            desc: "Choro enlouquecedor."
        }
    ];

    const STATE = {
        playing: false,
        day: 1,
        maxDays: 8,
        sanity: 80,
        energy: 80,
        doorHealth: 100,
        familyMood: 100,
        
        doorKnocking: false,
        visitor: null, // Objeto do visitante atual
        lookingAtPeephole: false,
        screenView: 'BOOT', 
        currentLocation: 'BUNKER',
        gameOver: false,
        interrogated: false,
        
        // Estat√≠sticas para Trof√©us
        stats: {
            humansSaved: 0,
            monstersKilled: 0,
            unlockedTrophies: []
        },

        quiz: { question: "", options: [], answer: 0, rewardType: '', rewardAmount: 0 }
    };

    // CORES ATUALIZADAS PARA AMARELO/√ÇMBAR
    const LOCATIONS = {
        BUNKER: { color: 0xffcc00, fog: 0x050505, fogDens: 0.15 }, // √Çmbar principal
        MARKET: { color: 0x00FFFF, fog: 0x001133, fogDens: 0.3 },
        PHARMACY: { color: 0xFFFFFF, fog: 0xEEEEEE, fogDens: 0.4 },
        STREETS: { color: 0xFF6600, fog: 0x331100, fogDens: 0.6 }
    };

    const QUIZ_DATA = {
        MARKET: [
            { q: "Lata sem r√≥tulo encontrada.", opt: ["Comer", "Ignorar", "Guardar"], ans: 1, type: 'energy', val: 20, fail: -10 },
            { q: "Rob√¥ de seguran√ßa bloqueia a passagem.", opt: ["Lutar", "Hackear ID", "Fugir"], ans: 1, type: 'energy', val: 30, fail: -20 },
            { q: "Vendedor suspeito oferece troca.", opt: ["Aceitar", "Recusar", "Roubar"], ans: 0, type: 'energy', val: 25, fail: -10 }
        ],
        PHARMACY: [
            { q: "Soro experimental encontrado.", opt: ["Usar", "Estocar", "Destruir"], ans: 1, type: 'sanity', val: 30, fail: -20 },
            { q: "Receita m√©dica antiga no ch√£o.", opt: ["Ler", "Ignorar", "Comer"], ans: 0, type: 'sanity', val: 15, fail: -5 },
            { q: "Alarme de g√°s dispara.", opt: ["Correr", "M√°scara", "Esconder"], ans: 1, type: 'sanity', val: 20, fail: -30 }
        ],
        STREETS: [
            { q: "N√©voa √°cida se aproxima.", opt: ["Correr", "Sinalizador", "Abrigo"], ans: 2, type: 'sanity', val: 20, fail: -40 },
            { q: "Drone espi√£o avistado.", opt: ["Acenar", "Im√≥vel", "Atirar"], ans: 1, type: 'energy', val: 10, fail: -30 },
            { q: "Gritos em um beco.", opt: ["Investigar", "Armadilha", "Ignorar"], ans: 1, type: 'sanity', val: 40, fail: -10 }
        ]
    };

    window.gameActions = {
        interrogate: () => interrogateVisitor(),
        openDoor: () => resolveDoor(true),
        shockDoor: () => resolveDoor(false),
        exitPeephole: () => exitPeepholeMode()
    };

    let camera, scene, renderer;
    let monitorTexture, monitorContext, monitorMesh;
    let pointLightPC, pointLightEmergency;
    let raycaster = new THREE.Raycaster();
    let clock = new THREE.Clock();
    let audioCtx, masterGain;

    // --- SISTEMA DE TROF√âUS ---
    function unlockTrophy(key) {
        const trophy = TROPHIES[key];
        if (!trophy || STATE.stats.unlockedTrophies.includes(key)) return;

        STATE.stats.unlockedTrophies.push(key);
        showTrophyPopup(trophy);
        playSound('trophy');

        // Check Platinum
        const totalTrophies = Object.keys(TROPHIES).length - 1; // -1 pela platina
        if (STATE.stats.unlockedTrophies.length === totalTrophies && !STATE.stats.unlockedTrophies.includes('PLATINUM')) {
            setTimeout(() => unlockTrophy('PLATINUM'), 2000);
        }
    }

    function showTrophyPopup(trophy) {
        const popup = document.getElementById('trophy-popup');
        document.getElementById('trophy-icon').innerText = trophy.icon;
        document.getElementById('trophy-name').innerText = trophy.title;
        
        popup.style.top = '20px';
        setTimeout(() => { popup.style.top = '-100px'; }, 4000);
    }

    // --- FUN√á√ïES DE STATUS E HUD ---
    function updateHUD() {
        if (!STATE.playing) return;
        document.getElementById('hud-day').innerText = `${STATE.day}/${STATE.maxDays}`;
        document.getElementById('hud-energy').innerText = Math.floor(STATE.energy);
        updateBar('bar-sanity', STATE.sanity, 'row-sanity');
        updateBar('bar-door', STATE.doorHealth, 'row-door');
        updateBar('bar-family', STATE.familyMood, 'row-family');

        // Checks de Trof√©u Passivos
        if (STATE.day >= 4) unlockTrophy('SURVIVOR');
        if (STATE.familyMood >= 100) unlockTrophy('FAMILY_FIRST');
    }

    function updateBar(id, value, rowId) {
        const bar = document.getElementById(id);
        const row = document.getElementById(rowId);
        bar.style.width = `${Math.max(0, Math.min(100, value))}%`;
        if (value <= 30) row.classList.add('danger');
        else row.classList.remove('danger');
    }

    // --- GEMINI API ---
    async function generateVisitorDialogue(visitor) {
        const dialogueText = document.getElementById('dialogue-text');
        document.getElementById('dialogue-box').style.display = 'block';
        dialogueText.innerText = "Analisando voz...";
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: visitor.prompt + " Max 12 palavras." }] }] })
            });
            const data = await response.json();
            typeWriterEffect(data.candidates[0].content.parts[0].text, dialogueText);
        } catch (e) {
            typeWriterEffect("...ru√≠do est√°tico...", dialogueText);
        }
    }

    function typeWriterEffect(text, element) {
        element.innerText = "";
        let i = 0;
        function type() {
            if (i < text.length) { element.innerText += text.charAt(i); i++; setTimeout(type, 50); }
        }
        type();
    }

    // --- √ÅUDIO ---
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.4;
        masterGain.connect(audioCtx.destination);
    }

    function playSound(type, pos = null) {
        if (!audioCtx || STATE.gameOver) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        if (pos) {
            const panner = audioCtx.createPanner();
            panner.panningModel = 'HRTF';
            panner.positionX.value = pos.x; panner.positionY.value = pos.y; panner.positionZ.value = pos.z;
            osc.connect(gain).connect(panner).connect(masterGain);
        } else {
            osc.connect(gain).connect(masterGain);
        }

        const now = audioCtx.currentTime;
        if (type === 'click') {
            osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if (type === 'trophy') { // Som PS5-ish
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(400, now); 
            osc.frequency.linearRampToValueAtTime(800, now+0.2);
            gain.gain.setValueAtTime(0.1, now); 
            gain.gain.linearRampToValueAtTime(0, now+1.0);
            osc.start(now); osc.stop(now+1.0);
        } else if (type === 'travel') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now+2);
            gain.gain.value = 0.1; osc.start(now); osc.stop(now+2);
        } else if (type === 'hum') {
            osc.type = 'sine'; osc.frequency.value = 60; gain.gain.value = 0.05; osc.start(now);
        } else if (type === 'knock') {
            // Som mais pesado para Brutos
            const freq = STATE.visitor && STATE.visitor.id === 'brute' ? 30 : 60;
            osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, now); osc.frequency.exponentialRampToValueAtTime(10, now+0.2);
            gain.gain.setValueAtTime(1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        } else if (type === 'shock') {
            osc.type = 'sawtooth'; osc.frequency.linearRampToValueAtTime(1000, now+0.5);
            gain.gain.setValueAtTime(0.5, now); osc.start(now); osc.stop(now+0.5);
        } else if (type === 'jumpscare') {
            osc.type = 'sawtooth'; osc.frequency.value = 50; gain.gain.value = 1; osc.start(now); osc.stop(now+2);
        }
    }

    // --- VISUAIS ---
    function updateEnvironment3D() {
        const target = LOCATIONS[STATE.currentLocation];
        const curCol = pointLightPC.color;
        curCol.lerp(new THREE.Color(target.color), 0.05);
        scene.fog.color.lerp(new THREE.Color(target.fog), 0.05);
        scene.fog.density = THREE.MathUtils.lerp(scene.fog.density, target.fogDens, 0.02);
    }

    // --- SISTEMA OPERACIONAL (OS) ---
    const CANVAS_W = 512;
    const CANVAS_H = 512;
    const CRT_COLOR = '#ffcc00'; // AMARELO AGORA
    let osButtons = [];

    function initMonitorOS() {
        const canvas = document.createElement('canvas');
        canvas.width = CANVAS_W; canvas.height = CANVAS_H;
        monitorContext = canvas.getContext('2d');
        monitorTexture = new THREE.CanvasTexture(canvas);
        monitorTexture.minFilter = THREE.LinearFilter; monitorTexture.magFilter = THREE.NearestFilter;
        drawOS();
    }

    function drawButton(ctx, x, y, w, h, text) {
        ctx.strokeStyle = CRT_COLOR; ctx.lineWidth = 2; ctx.strokeRect(x, y, w, h);
        ctx.fillStyle = CRT_COLOR; ctx.font = '18px monospace'; ctx.fillText(text, x + 10, y + 25);
        return { x, y, w, h };
    }

    function drawOS() {
        const ctx = monitorContext;
        if (!ctx) return;
        ctx.fillStyle = '#110d00'; ctx.fillRect(0, 0, CANVAS_W, CANVAS_H); // Fundo amarelado escuro
        ctx.shadowBlur = 4; ctx.shadowColor = CRT_COLOR; ctx.fillStyle = CRT_COLOR;
        osButtons = [];

        if (STATE.screenView === 'DESKTOP') {
            ctx.font = '28px monospace'; ctx.fillText(`PLURIBUS OS v9.0`, 40, 50);
            
            if (STATE.doorKnocking) {
                ctx.fillStyle = 'red'; ctx.shadowColor = 'red';
                ctx.fillText("ALERTA DE SEGURAN√áA", 120, 450);
                ctx.fillStyle = CRT_COLOR; ctx.shadowColor = CRT_COLOR;
            }

            osButtons.push({ action: 'GO_MAP', ...drawButton(ctx, 40, 100, 430, 50, "EXPEDI√á√ÉO (AVAN√áAR DIA)") });
            osButtons.push({ action: 'GO_FAMILY', ...drawButton(ctx, 40, 170, 430, 50, "FAM√çLIA / SOBREVIVENTES") });
            osButtons.push({ action: 'GO_REPAIR', ...drawButton(ctx, 40, 240, 430, 50, "MANUTEN√á√ÉO / PORTA") });
            osButtons.push({ action: 'GO_TROPHIES', ...drawButton(ctx, 40, 310, 200, 50, "TROF√âUS") });
            osButtons.push({ action: 'MAIL', ...drawButton(ctx, 270, 310, 200, 50, "DI√ÅRIO") });
        }
        else if (STATE.screenView === 'TROPHIES') {
            ctx.fillText("COLE√á√ÉO DE TROF√âUS", 40, 50);
            let y = 100;
            ctx.font = '16px monospace';
            
            const list = Object.values(TROPHIES);
            list.forEach(t => {
                const unlocked = STATE.stats.unlockedTrophies.includes(t.id);
                const prefix = unlocked ? `[X] ${t.icon}` : `[ ] üîí`;
                ctx.fillStyle = unlocked ? CRT_COLOR : '#554400';
                ctx.fillText(`${prefix} ${t.title}`, 40, y);
                y += 30;
            });
            
            ctx.fillStyle = CRT_COLOR;
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 420, 100, 40, "VOLTAR") });
        }
        else if (STATE.screenView === 'FAMILY') {
            ctx.fillText("STATUS DA FAM√çLIA", 40, 50);
            ctx.font = '16px monospace';
            ctx.fillText(`HUMOR: ${STATE.familyMood}%`, 40, 90);
            ctx.fillText(`Eles est√£o nos fundos do bunker.`, 40, 120);
            
            osButtons.push({ action: 'FAM_FEED', ...drawButton(ctx, 40, 200, 430, 50, "DAR RA√á√ÉO (Gasta 20 Energia)") });
            osButtons.push({ action: 'FAM_TALK', ...drawButton(ctx, 40, 270, 430, 50, "CONVERSAR (Gasta 10 Energia)") });
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 420, 100, 40, "VOLTAR") });
        }
        else if (STATE.screenView === 'REPAIR') {
            ctx.fillText("MANUTEN√á√ÉO", 40, 50);
            ctx.font = '16px monospace';
            ctx.fillText(`INTEGRIDADE DA PORTA: ${STATE.doorHealth}%`, 40, 90);
            
            osButtons.push({ action: 'REP_DOOR', ...drawButton(ctx, 40, 200, 430, 50, "REPARAR PORTA (Gasta 30 Energia)") });
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 420, 100, 40, "VOLTAR") });
        }
        else if (STATE.screenView === 'MAP') {
            ctx.fillText("DESTINO DA EXPEDI√á√ÉO:", 40, 50);
            osButtons.push({ action: 'GO_MARKET', ...drawButton(ctx, 40, 100, 430, 50, "MERCADO (Risco M√©dio)") });
            osButtons.push({ action: 'GO_PHARMA', ...drawButton(ctx, 40, 170, 430, 50, "FARM√ÅCIA (Risco Baixo)") });
            osButtons.push({ action: 'GO_STREET', ...drawButton(ctx, 40, 240, 430, 50, "RUAS (Risco Alto)") });
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 400, 100, 40, "CANCELAR") });
        }
        else if (STATE.screenView === 'LOCATION_QUIZ') {
            ctx.font = '20px monospace';
            ctx.fillText(`LOCAL: ${STATE.currentLocation}`, 40, 40);
            const words = STATE.quiz.question.split(' ');
            let line = '', y = 80;
            ctx.font = '16px monospace';
            for(let n = 0; n < words.length; n++) {
                if (ctx.measureText(line + words[n]).width > 450) { ctx.fillText(line, 40, y); line = words[n] + ' '; y += 25; }
                else line += words[n] + ' ';
            }
            ctx.fillText(line, 40, y);
            STATE.quiz.options.forEach((opt, idx) => {
                osButtons.push({ action: `ANS_${idx}`, ...drawButton(ctx, 40, 200 + (idx * 70), 430, 50, `${idx+1}. ${opt}`) });
            });
        }
        else if (STATE.screenView === 'RESULT') {
            ctx.font = '20px monospace';
            ctx.fillText("RESULTADO:", 40, 100);
            ctx.fillText(STATE.quiz.resultMsg, 40, 150);
        }
        else if (STATE.screenView === 'BOOT') {
            ctx.fillText("INICIALIZANDO...", 40, 100);
            if(Math.random() > 0.9) STATE.screenView = 'DESKTOP';
        }
        else if (STATE.screenView === 'MAIL') {
            ctx.fillText("DI√ÅRIO:", 40, 50);
            ctx.font = '14px monospace';
            ctx.fillText("- M√≠micos podem parecer humanos.", 40, 100);
            ctx.fillText("- Brutos n√£o falam, s√≥ gritam.", 40, 120);
            osButtons.push({ action: 'BACK', ...drawButton(ctx, 40, 420, 100, 40, "VOLTAR") });
        }

        // Scanlines
        ctx.fillStyle = "rgba(255, 200, 0, 0.1)";
        for (let i = 0; i < CANVAS_H; i += 4) ctx.fillRect(0, i, CANVAS_W, 2);
        monitorTexture.needsUpdate = true;
    }

    // --- L√ìGICA DO JOGO ---
    function startExpedition(loc) {
        STATE.currentLocation = loc;
        playSound('travel');
        const pool = QUIZ_DATA[loc];
        const qData = pool[Math.floor(Math.random() * pool.length)];
        STATE.quiz = { question: qData.q, options: qData.opt, answer: qData.ans, rewardType: qData.type, rewardAmount: qData.val, failAmount: qData.fail };
        STATE.screenView = 'LOCATION_QUIZ';
    }

    function handleQuizAnswer(idx) {
        const correct = idx === STATE.quiz.answer;
        let msg = "";
        
        if (correct) {
            if (STATE.quiz.rewardType === 'energy') STATE.energy = Math.min(100, STATE.energy + STATE.quiz.rewardAmount);
            if (STATE.quiz.rewardType === 'sanity') STATE.sanity = Math.min(100, STATE.sanity + STATE.quiz.rewardAmount);
            msg = `SUCESSO! +${STATE.quiz.rewardAmount} ${STATE.quiz.rewardType}.`;
            playSound('click');
        } else {
            STATE.energy = Math.max(0, STATE.energy - 10);
            STATE.sanity = Math.max(0, STATE.sanity + STATE.quiz.failAmount);
            msg = "FALHA. Dano sofrido.";
            playSound('shock');
        }

        // Avan√ßar dia e degradar status
        STATE.day++;
        STATE.familyMood -= 20; 
        STATE.quiz.resultMsg = msg;
        STATE.screenView = 'RESULT';
        checkState();
    }

    function checkState() {
        if (STATE.day > STATE.maxDays) {
            victory();
            return;
        }
        if (STATE.energy <= 0) triggerGameOver("Sem Energia. Sistemas vitais falharam.");
        else if (STATE.sanity <= 0) triggerGameOver("Colapso Mental Total.");
        else if (STATE.doorHealth <= 0) triggerGameOver("A porta foi derrubada.");
        else if (STATE.familyMood <= 0) triggerGameOver("MOTIM! A fam√≠lia te atacou.");
    }

    function returnToBunker() {
        STATE.currentLocation = 'BUNKER';
        STATE.screenView = 'DESKTOP';
    }

    function victory() {
        document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:black;color:#ffcc00;font-family:monospace;"><h1>DIA 8: RESGATE CHEGOU</h1><p>Voc√™ e sua fam√≠lia sobreviveram.</p><button onclick="location.reload()">REINICIAR</button></div>`;
        STATE.playing = false;
    }

    function triggerGameOver(reason) {
        STATE.gameOver = true;
        playSound('jumpscare');
        document.getElementById('vhs-overlay').style.background = 'red';
        setTimeout(() => {
            document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:black;color:red;font-family:monospace;text-align:center;"><h1>FIM DE JOGO</h1><p>${reason}</p><p>Dia: ${STATE.day}</p><button onclick="location.reload()">REINICIAR</button></div>`;
        }, 2000);
    }

    // --- INTERA√á√ïES DO MONITOR ---
    function handleMonitorClick(uv) {
        if (STATE.screenView === 'RESULT') return; 

        const x = uv.x * CANVAS_W;
        const y = (1 - uv.y) * CANVAS_H;
        playSound('click');
        
        for (let btn of osButtons) {
            if (x >= btn.x && x <= btn.x + btn.w && y >= btn.y && y <= btn.y + btn.h) {
                // Navega√ß√£o
                if (btn.action === 'GO_MAP') STATE.screenView = 'MAP';
                if (btn.action === 'GO_FAMILY') STATE.screenView = 'FAMILY';
                if (btn.action === 'GO_REPAIR') STATE.screenView = 'REPAIR';
                if (btn.action === 'GO_TROPHIES') STATE.screenView = 'TROPHIES';
                if (btn.action === 'MAIL') STATE.screenView = 'MAIL';
                if (btn.action === 'BACK') STATE.screenView = 'DESKTOP';
                
                // A√ß√µes de Fam√≠lia
                if (btn.action === 'FAM_FEED') {
                    if (STATE.energy >= 20) {
                        STATE.energy -= 20;
                        STATE.familyMood = Math.min(100, STATE.familyMood + 30);
                        logMessage("Fam√≠lia alimentada.");
                    } else logMessage("Energia insuficiente.");
                }
                if (btn.action === 'FAM_TALK') {
                    if (STATE.energy >= 10) {
                        STATE.energy -= 10;
                        STATE.sanity = Math.min(100, STATE.sanity + 10);
                        STATE.familyMood = Math.min(100, STATE.familyMood + 10);
                        logMessage("Voc√™s conversaram um pouco.");
                    } else logMessage("Energia insuficiente.");
                }

                // A√ß√µes de Reparo
                if (btn.action === 'REP_DOOR') {
                    if (STATE.energy >= 30) {
                        STATE.energy -= 30;
                        STATE.doorHealth = Math.min(100, STATE.doorHealth + 40);
                        unlockTrophy('MECHANIC'); // Trof√©u poss√≠vel
                        logMessage("Porta refor√ßada.");
                    } else logMessage("Energia insuficiente.");
                }

                // Expedi√ß√µes
                if (btn.action === 'GO_MARKET') startExpedition('MARKET');
                if (btn.action === 'GO_PHARMA') startExpedition('PHARMACY');
                if (btn.action === 'GO_STREET') startExpedition('STREETS');

                if (btn.action.startsWith('ANS_')) handleQuizAnswer(parseInt(btn.action.split('_')[1]));
            }
        }
    }

    // --- INTERA√á√ïES DE PORTA ---
    function triggerKnockEvent() {
        if (STATE.doorKnocking || STATE.currentLocation !== 'BUNKER') return;
        
        STATE.doorKnocking = true;
        
        // Sele√ß√£o de Visitante Complexo
        const r = Math.random();
        if (r < 0.3) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'survivor');
        else if (r < 0.4) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'mimic');
        else if (r < 0.5) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'brute');
        else if (r < 0.6) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'medic');
        else if (r < 0.7) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'mechanic');
        else if (r < 0.8) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'weeper');
        else if (r < 0.9) STATE.visitor = VISITOR_TYPES.find(v => v.id === 'trader');
        else STATE.visitor = VISITOR_TYPES.find(v => v.id === 'cultist');

        STATE.interrogated = false;
        playSound('knock', {x: 3, y: 1, z: 0});
        
        STATE.doorHealth -= 5; // Dano de aviso
        updateHUD();
        
        const blinkInterval = setInterval(() => {
            if (!STATE.doorKnocking) { clearInterval(blinkInterval); pointLightEmergency.intensity = 0; return; }
            pointLightEmergency.intensity = pointLightEmergency.intensity > 0 ? 0 : 3;
        }, 600);
        logMessage(`ALERTA: ALGU√âM NA PORTA.`);
    }

    function resolveDoor(open) {
        STATE.doorKnocking = false;
        pointLightEmergency.intensity = 0;
        exitPeepholeMode();
        
        if (open) {
            if (STATE.visitor.type === 'good') {
                // Aplicar recompensas espec√≠ficas
                if (STATE.visitor.reward.energy) STATE.energy = Math.min(100, STATE.energy + STATE.visitor.reward.energy);
                if (STATE.visitor.reward.sanity) STATE.sanity = Math.min(100, STATE.sanity + STATE.visitor.reward.sanity);
                if (STATE.visitor.reward.door) STATE.doorHealth = Math.min(100, STATE.doorHealth + STATE.visitor.reward.door);
                
                STATE.stats.humansSaved++;
                if (STATE.stats.humansSaved >= 3) unlockTrophy('SAVIOR');
                
                playSound('click');
                logMessage(`${STATE.visitor.name} entrou. ${STATE.visitor.desc}`);
            } else {
                // Aplicar danos espec√≠ficos
                STATE.doorHealth -= (STATE.visitor.damage.door || 0);
                STATE.sanity -= (STATE.visitor.damage.sanity || 0);
                
                logMessage(`ERRO: ${STATE.visitor.name} entrou! ${STATE.visitor.desc}`);
                playSound('shock');
            }
        } else {
            playSound('shock', {x: 3, y: 1, z: 0});
            unlockTrophy('FIRST_BLOOD'); // Primeiro choque
            
            if (STATE.visitor.type === 'good') {
                STATE.sanity -= 20;
                logMessage("Voc√™ eletrocutou um inocente.");
            } else {
                STATE.sanity += 10;
                STATE.stats.monstersKilled++;
                if (STATE.stats.monstersKilled >= 3) unlockTrophy('SLAYER');
                logMessage("Amea√ßa eliminada.");
            }
        }
        checkState();
    }

    function enterPeepholeMode() {
        if (!STATE.doorKnocking) { logMessage("Sil√™ncio."); return; }
        STATE.lookingAtPeephole = true;
        document.exitPointerLock(); 
        document.getElementById('peephole-ui').style.display = 'block';
        document.getElementById('dialogue-box').style.display = 'none';
        
        const visual = document.getElementById('visitor-visual');
        visual.innerText = STATE.visitor.visual;
        
        camera.position.set(2.5, 1.6, 0); camera.lookAt(4, 1.6, 0);
    }
    
    function exitPeepholeMode() {
        STATE.lookingAtPeephole = false;
        document.getElementById('peephole-ui').style.display = 'none';
        document.body.requestPointerLock();
        camera.position.set(0, 1.2, 2); camera.lookAt(0, 1.2, 0);
    }
    
    function interrogateVisitor() {
        if (STATE.interrogated) return;
        STATE.interrogated = true;
        generateVisitorDialogue(STATE.visitor);
    }

    function logMessage(msg) {
        const el = document.getElementById('message-log');
        el.innerText = `> ${msg}`;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 3000);
    }

    // --- SETUP THREE.JS (BOILERPLATE) ---
    function init3D() {
        const container = document.getElementById('game-container');
        scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050505, 0.15);
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.2, 2);
        renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Assets
        const wallMat = createNoiseMaterial(0x444444);
        const room = new THREE.Mesh(new THREE.BoxGeometry(6,4,6), wallMat);
        room.material.side = THREE.BackSide; scene.add(room);
        
        const desk = new THREE.Mesh(new THREE.BoxGeometry(2.5,0.1,1.5), createNoiseMaterial(0x333333));
        desk.position.set(0,0.8,0); scene.add(desk);

        initMonitorOS();
        monitorMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.6,0.6), new THREE.MeshBasicMaterial({map:monitorTexture, side:THREE.DoubleSide}));
        monitorMesh.position.set(0,1.2,0.31); monitorMesh.name="MONITOR"; scene.add(monitorMesh);
        
        const door = new THREE.Mesh(new THREE.BoxGeometry(0.1,2.2,1.2), new THREE.MeshStandardMaterial({color:0x2a2a2a}));
        door.position.set(2.95,1.1,0); door.name="DOOR"; scene.add(door);
        
        const peep = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.15,16), new THREE.MeshBasicMaterial({color:0x000}));
        peep.rotation.z=Math.PI/2; peep.position.set(2.90,1.6,0); peep.name="PEEPHOLE"; scene.add(peep);

        scene.add(new THREE.AmbientLight(0x111111));
        pointLightPC = new THREE.PointLight(0xffcc00, 1, 4); pointLightPC.position.set(0,1.2,0.5); scene.add(pointLightPC);
        pointLightEmergency = new THREE.PointLight(0xff0000, 0, 15); pointLightEmergency.position.set(2.5,2.8,0); scene.add(pointLightEmergency);

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('click', onClick);
    }

    function createNoiseMaterial(c) {
        const cnv = document.createElement('canvas'); cnv.width=64; cnv.height=64;
        const ctx = cnv.getContext('2d'); ctx.fillStyle = '#'+c.toString(16); ctx.fillRect(0,0,64,64);
        for(let i=0;i<500;i++){ ctx.fillStyle=`rgba(0,0,0,${Math.random()*0.2})`; ctx.fillRect(Math.random()*64,Math.random()*64,2,2); }
        const tex = new THREE.CanvasTexture(cnv); return new THREE.MeshStandardMaterial({map:tex, roughness:0.9});
    }

    let rotX=0, rotY=0;
    function onMouseMove(e) {
        if(!STATE.playing || STATE.gameOver || STATE.lookingAtPeephole) return;
        rotY -= e.movementX*0.002; rotX -= e.movementY*0.002;
        rotX = Math.max(-Math.PI/3, Math.min(Math.PI/3, rotX));
        camera.rotation.set(0,0,0); camera.rotateY(rotY); camera.rotateX(rotX);
    }

    function onClick() {
        if(!STATE.playing || STATE.gameOver || STATE.lookingAtPeephole) return;
        raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = raycaster.intersectObjects(scene.children);
        if(hits.length){
            if(hits[0].object.name==="MONITOR") handleMonitorClick(hits[0].uv);
            else if(hits[0].object.name==="PEEPHOLE" || hits[0].object.name==="DOOR") enterPeepholeMode();
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        if(!STATE.playing || STATE.gameOver) return;
        
        updateEnvironment3D();
        updateHUD();
        drawOS();

        if (STATE.screenView === 'RESULT' && !STATE.resultTimer) {
            STATE.resultTimer = setTimeout(() => { returnToBunker(); STATE.resultTimer = null; }, 3000);
        }

        if (STATE.currentLocation === 'BUNKER' && !STATE.doorKnocking && !STATE.lookingAtPeephole && Math.random() < 0.002) triggerKnockEvent();
        renderer.render(scene, camera);
    }

    document.getElementById('overlay').addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'none';
        document.body.requestPointerLock();
        initAudio(); init3D(); playSound('hum');
        STATE.playing = true; clock.start(); animate();
    });

</script>
</body>
</html>